\doxysection{thread.\+c}
\hypertarget{thread_8c_source}{}\label{thread_8c_source}\index{C:/Users/matanel/Desktop/Projects/KernelDevelopment/kernel/core/ps/thread.c@{C:/Users/matanel/Desktop/Projects/KernelDevelopment/kernel/core/ps/thread.c}}
\mbox{\hyperlink{thread_8c}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00001}00001\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{ps_8h}{../../includes/ps.h}}"{}}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00002}00002\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{assert_8h}{../../assert.h}}"{}}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00003}00003\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{mg_8h}{../../includes/mg.h}}"{}}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00004}00004\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{ob_8h}{../../includes/ob.h}}"{}}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00005}00005\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00006}\mbox{\hyperlink{thread_8c_a380e61f9be3a2721fd83a3a0b07f4132}{00006}}\ \textcolor{preprocessor}{\#define\ MIN\_TID\ \ \ \ \ \ \ \ \ \ \ 3u}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00007}\mbox{\hyperlink{thread_8c_af6bea0442249039ac2b6b3c250938c0c}{00007}}\ \textcolor{preprocessor}{\#define\ MAX\_TID\ \ \ \ \ \ \ \ \ \ \ 0xFFFFFFFCu}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00008}\mbox{\hyperlink{thread_8c_a31452d15206784935051c52d5a78ff03}{00008}}\ \textcolor{preprocessor}{\#define\ ALIGN\_DELTA\ \ \ \ \ \ \ 3u}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00009}\mbox{\hyperlink{thread_8c_a08150dd3f0ffc0e330a631dd728ea448}{00009}}\ \textcolor{preprocessor}{\#define\ MAX\_FREE\_POOL\ \ \ \ \ 1024u}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00010}00010\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00011}\mbox{\hyperlink{thread_8c_a90b7a8cb7bc3fdbd98014a3e15ee6e9a}{00011}}\ \textcolor{preprocessor}{\#define\ THREAD\_STACK\_SIZE\ (1024*24)\ }\textcolor{comment}{//\ 24\ KiB}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00012}\mbox{\hyperlink{thread_8c_afa1d2c5ae9892cf06df19518092ad464}{00012}}\ \textcolor{preprocessor}{\#define\ THREAD\_ALIGNMENT\ 16}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00013}00013\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00014}00014\ \textcolor{comment}{//\ Clean\ exit\ for\ a\ thread—never\ returns!}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00015}00015\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ ThreadExit(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00016}00016\ \textcolor{preprocessor}{\#ifdef\ DEBUG}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00017}00017\ \ \ \ \ \mbox{\hyperlink{gop_8c_a41ff1165c1969706dadb5b409ae082e9}{gop\_printf}}(\mbox{\hyperlink{mg_8h_ad86358bf19927183dd7b4ae215a29731}{COLOR\_RED}},\ \textcolor{stringliteral}{"{}Reached\ ThreadExit,\ dereferencing\ object.\(\backslash\)n"{}});}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00018}00018\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00019}00019\ \ \ \ \ \textcolor{comment}{//\ Terminate\ the\ thread.}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00020}00020\ \ \ \ \ \mbox{\hyperlink{assert_8h_a3d4ae9c092e117c836f52dc7d7cee574}{assert}}(\&\mbox{\hyperlink{thread_8c_a83437e8cd9a8e8befc491348dfcb41c0}{PsGetCurrentThread}}()-\/>InternalThread\ ==\ \mbox{\hyperlink{me_8h_a47d6bb330b3f195c125bd452af7031c8}{MeGetCurrentThread}}());}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00021}00021\ \ \ \ \ \mbox{\hyperlink{thread_8c_a15e6e7020dd68d4ec91f0dee0cdae31a}{PsTerminateThread}}(\mbox{\hyperlink{thread_8c_a83437e8cd9a8e8befc491348dfcb41c0}{PsGetCurrentThread}}(),\ \mbox{\hyperlink{mtstatus_8h_a147849337a41d8be9ccb4ef599b84a86}{MT\_SUCCESS}});}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00022}00022\ \}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00023}00023\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00024}00024\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ ThreadWrapperEx(\mbox{\hyperlink{ps_8h_a72fcf929d51dce199593912ed4910ade}{ThreadEntry}}\ thread\_entry,\ \mbox{\hyperlink{ps_8h_ac97f2b26eaa411a9744e1be2fbc90c11}{THREAD\_PARAMETER}}\ parameter)\ \{}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00025}00025\ \ \ \ \ \textcolor{comment}{//\ thread\_entry(parameters)\ -\/>\ void\ func(void*)}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00026}00026\ \ \ \ \ thread\_entry(parameter);\ \textcolor{comment}{//\ If\ thread\ entry\ takes\ no\ parameters,\ passing\ NULL\ is\ still\ fine.}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00028}00028\ \ \ \ \ ThreadExit();}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00029}00029\ \}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00030}00030\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00031}00031\ \textcolor{keyword}{extern}\ \mbox{\hyperlink{core_8h_a1079f854acf7ed03691ff4ea20bc1be6}{EPROCESS}}\ \mbox{\hyperlink{scheduler_8c_ac6c835f9ef3163dba3826f22bf43b9d2}{PsInitialSystemProcess}};}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00032}00032\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00033}00033\ \mbox{\hyperlink{mtstatus_8h_a7c794b38d203a5b842f27b12fb55495a}{MTSTATUS}}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00034}\mbox{\hyperlink{thread_8c_ab8403a27ef7d0d88a6ea3cd4b44bb97d}{00034}}\ \mbox{\hyperlink{thread_8c_ab8403a27ef7d0d88a6ea3cd4b44bb97d}{PsCreateThread}}(}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00035}00035\ \ \ \ \ \mbox{\hyperlink{ht_8h_a84a85b4c81f3ad61278cc4473a44f202}{HANDLE}}\ ProcessHandle,}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00036}00036\ \ \ \ \ \mbox{\hyperlink{ht_8h_a4eff5701246ce814577877fc805928de}{PHANDLE}}\ ThreadHandle,}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00037}00037\ \ \ \ \ \mbox{\hyperlink{ps_8h_a72fcf929d51dce199593912ed4910ade}{ThreadEntry}}\ EntryPoint,}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00038}00038\ \ \ \ \ \mbox{\hyperlink{ps_8h_ac97f2b26eaa411a9744e1be2fbc90c11}{THREAD\_PARAMETER}}\ ThreadParameter,}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00039}00039\ \ \ \ \ \mbox{\hyperlink{me_8h_ae2fa920c6cd4660356637d5a33222a70}{TimeSliceTicks}}\ TimeSlice}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00040}00040\ )}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00041}00041\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00042}00042\ \{}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00043}00043\ \ \ \ \ \textcolor{comment}{//\ Checks.}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00044}00044\ \ \ \ \ \textcolor{keywordflow}{if}\ (!ProcessHandle\ ||\ !EntryPoint\ ||\ !TimeSlice)\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{mtstatus_8h_a55458e0861f6a58c2bc62538f93609ce}{MT\_INVALID\_PARAM}};}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00045}00045\ \ \ \ \ \mbox{\hyperlink{mtstatus_8h_a7c794b38d203a5b842f27b12fb55495a}{MTSTATUS}}\ Status;}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00046}00046\ \ \ \ \ \mbox{\hyperlink{core_8h_a991a69d592c53aaa098317abccbdfca7}{PEPROCESS}}\ ParentProcess;}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00047}00047\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00048}00048\ \ \ \ \ Status\ =\ \mbox{\hyperlink{ob_8c_a47671180c09015ad53f4b1dbacd09de6}{ObReferenceObjectByHandle}}(ProcessHandle,\ \mbox{\hyperlink{ps_8h_a7c1dec2d565737e21ad7739eea6e751e}{MT\_PROCESS\_CREATE\_THREAD}},\ \mbox{\hyperlink{psmgr_8c_a5831e6e9cf425b592554e81508ce2155}{PsProcessType}},\ (\textcolor{keywordtype}{void}**)\&ParentProcess,\ NULL);}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00049}00049\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{mtstatus_8h_a51b65f92cdedadf23a01dff0f9f4fac7}{MT\_FAILURE}}(Status))\ \textcolor{keywordflow}{return}\ Status;}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00050}00050\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00051}00051\ \ \ \ \ \textcolor{comment}{//\ Acquire\ process\ rundown\ protection.}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00052}00052\ \ \ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{rundown_8c_a5901eaa5bcb8edcbd0bad3d55f0f816f}{MsAcquireRundownProtection}}(\&ParentProcess-\/>\mbox{\hyperlink{struct___e_p_r_o_c_e_s_s_a1e28d84793df7af85a2a5154fcd435c7}{ProcessRundown}}))\ \{}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00053}00053\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Process\ is,\ being\ terminated?}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00054}00054\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{mtstatus_8h_a170dcded714ddb53772102d131ee77dc}{MT\_PROCESS\_IS\_TERMINATING}};}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00055}00055\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00056}00056\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00057}00057\ \ \ \ \ \textcolor{comment}{//\ Create\ a\ new\ thread.}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00058}00058\ \ \ \ \ \mbox{\hyperlink{core_8h_ad66fec9d1871be79dbc3f828f4ac5ee7}{PETHREAD}}\ Thread;}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00059}00059\ \ \ \ \ Status\ =\ \mbox{\hyperlink{ob_8c_ad77278de8f30feb544f7bd27bd85a81f}{ObCreateObject}}(\mbox{\hyperlink{psmgr_8c_a32564f2df24bd688bb18b93f81d3bf7d}{PsThreadType}},\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{core_8h_ab36019f6c21ddbae4a9dd226ed885a46}{ETHREAD}}),\ (\textcolor{keywordtype}{void}**)\ \&\ Thread);}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00060}00060\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{mtstatus_8h_a51b65f92cdedadf23a01dff0f9f4fac7}{MT\_FAILURE}}(Status))\ \textcolor{keywordflow}{goto}\ Cleanup;}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00061}00061\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00062}00062\ \ \ \ \ \textcolor{comment}{//\ Initialize\ list\ head.}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00063}00063\ \ \ \ \ \mbox{\hyperlink{ms_8h_a46e3ce34dec4da38189211cef81110c1}{InitializeListHead}}(\&Thread-\/>\mbox{\hyperlink{struct___e_t_h_r_e_a_d_af89b69b8dfdc6f73ffba7bdf79eeec8e}{ThreadListEntry}});}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00064}00064\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00065}00065\ \ \ \ \ \textcolor{comment}{//\ Create\ a\ TID\ for\ the\ thread.}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00066}00066\ \ \ \ \ Thread-\/>\mbox{\hyperlink{struct___e_t_h_r_e_a_d_a4f322c225ea87b4c71a53def5189f4a2}{TID}}\ =\ \mbox{\hyperlink{cid_8c_a5dfbea187ffb7f2ef182fb25330e6d8a}{PsAllocateThreadId}}(Thread);}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00067}00067\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00068}00068\ \ \ \ \ \textcolor{comment}{//\ Create\ a\ new\ stack\ for\ the\ thread's\ kernel\ environment.}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00069}00069\ \ \ \ \ Thread-\/>\mbox{\hyperlink{struct___e_t_h_r_e_a_d_a277ac0724d62341752a5d14f7ebe57fa}{InternalThread}}.\mbox{\hyperlink{struct___i_t_h_r_e_a_d_a949a9f69e54a9c4714e29011de37383e}{KernelStack}}\ =\ \mbox{\hyperlink{mmproc_8c_a395221ebf401ad2be0b1e0b2389da78d}{MiCreateKernelStack}}(\textcolor{keyword}{false});}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00070}00070\ \ \ \ \ \textcolor{keywordflow}{if}\ (!Thread-\/>\mbox{\hyperlink{struct___e_t_h_r_e_a_d_a277ac0724d62341752a5d14f7ebe57fa}{InternalThread}}.\mbox{\hyperlink{struct___i_t_h_r_e_a_d_a949a9f69e54a9c4714e29011de37383e}{KernelStack}})\ \textcolor{keywordflow}{goto}\ CleanupWithRef;}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00071}00071\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00072}00072\ \ \ \ \ \textcolor{comment}{//\ Create\ user\ mode\ stack.\ (FIXME\ User\ mode\ stack\ creation\ like\ in\ ntdll,\ but\ how\ does\ it\ create\ the\ first\ user\ mode\ thread\ stack,\ helluva\ i\ know.)}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00073}00073\ \ \ \ \ \textcolor{keywordtype}{void}*\ BaseAddress\ =\ (\textcolor{keywordtype}{void}*)(\mbox{\hyperlink{mm_8h_a820eaf87fc49c007ebf206dbb7e58d0c}{USER\_VA\_END}}\ -\/\ 4096);}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00074}00074\ \ \ \ \ Status\ =\ \mbox{\hyperlink{vad_8c_aac5120b7c69029846c637943bf5b33b2}{MmAllocateVirtualMemory}}(ParentProcess,\ \&BaseAddress,\ 4096,\ \mbox{\hyperlink{mm_8h_a36cace3c811aa394d169dd55e644c91caea0945f7ba6f617c48fa1d0767a51a4b}{VAD\_FLAG\_WRITE}}\ |\ \mbox{\hyperlink{mm_8h_a36cace3c811aa394d169dd55e644c91ca22ecf9cb9f89e6499098916eae1b3fba}{VAD\_FLAG\_READ}});}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00075}00075\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{mtstatus_8h_a51b65f92cdedadf23a01dff0f9f4fac7}{MT\_FAILURE}}(Status))\ \textcolor{keywordflow}{goto}\ CleanupWithRef;}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00076}00076\ \ \ \ \ Thread-\/>\mbox{\hyperlink{struct___e_t_h_r_e_a_d_a277ac0724d62341752a5d14f7ebe57fa}{InternalThread}}.\mbox{\hyperlink{struct___i_t_h_r_e_a_d_a11a9d0f7a133753b1f3af14396caf0fc}{StackBase}}\ =\ (\textcolor{keywordtype}{void}*)(\mbox{\hyperlink{mm_8h_a820eaf87fc49c007ebf206dbb7e58d0c}{USER\_VA\_END}});\ \textcolor{comment}{//\ Stack\ grows\ downward.}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00077}00077\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00078}00078\ \ \ \ \ \textcolor{comment}{//\ Setup\ timeslice.}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00079}00079\ \ \ \ \ Thread-\/>\mbox{\hyperlink{struct___e_t_h_r_e_a_d_a277ac0724d62341752a5d14f7ebe57fa}{InternalThread}}.\mbox{\hyperlink{struct___i_t_h_r_e_a_d_a8888cdbf0abf1eab5ad7011409de2220}{TimeSlice}}\ =\ TimeSlice;}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00080}00080\ \ \ \ \ Thread-\/>\mbox{\hyperlink{struct___e_t_h_r_e_a_d_a277ac0724d62341752a5d14f7ebe57fa}{InternalThread}}.\mbox{\hyperlink{struct___i_t_h_r_e_a_d_ac82dc0f66693dda24c97ed90c0f899b7}{TimeSliceAllocated}}\ =\ TimeSlice;}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00081}00081\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00082}00082\ \ \ \ \ \textcolor{comment}{//\ Set\ registers}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00083}00083\ \ \ \ \ \mbox{\hyperlink{core_8h_a14d79ce92fc8bd426be5e9b939f8ba7a}{TRAP\_FRAME}}\ ContextFrame;}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00084}00084\ \ \ \ \ \mbox{\hyperlink{mm_8h_a7d9455da4f2ec94a98286a19e7d8e39d}{kmemset}}(\&ContextFrame,\ 0,\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{core_8h_a14d79ce92fc8bd426be5e9b939f8ba7a}{TRAP\_FRAME}}));}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00085}00085\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00086}00086\ \ \ \ \ ContextFrame.\mbox{\hyperlink{struct___t_r_a_p___f_r_a_m_e_a8e218c31298bb17b5041cfc61646d6b9}{rsp}}\ =\ (uint64\_t)Thread-\/>\mbox{\hyperlink{struct___e_t_h_r_e_a_d_a277ac0724d62341752a5d14f7ebe57fa}{InternalThread}}.\mbox{\hyperlink{struct___i_t_h_r_e_a_d_a11a9d0f7a133753b1f3af14396caf0fc}{StackBase}};}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00087}00087\ \ \ \ \ ContextFrame.\mbox{\hyperlink{struct___t_r_a_p___f_r_a_m_e_a90e28f434559f0582a69699dc4dbc286}{rip}}\ =\ (uint64\_t)EntryPoint;}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00088}00088\ \ \ \ \ ContextFrame.\mbox{\hyperlink{struct___t_r_a_p___f_r_a_m_e_a5764734a394146dcf093f9295c2fd5b4}{rdi}}\ =\ (uint64\_t)ThreadParameter;}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00089}00089\ \ \ \ \ ContextFrame.\mbox{\hyperlink{struct___t_r_a_p___f_r_a_m_e_ac67e007ae346a1499c5a276869bfd1bb}{rflags}}\ =\ \mbox{\hyperlink{me_8h_a42d2be9195a6eaec44cd3f5a9ff372eb}{USER\_RFLAGS}};}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00090}00090\ \ \ \ \ ContextFrame.\mbox{\hyperlink{struct___t_r_a_p___f_r_a_m_e_aea3e8b50ef91f54dad11c01a77675324}{cs}}\ =\ \mbox{\hyperlink{me_8h_a32134ca8ad3890b9f208cf4ec56477e0}{USER\_CS}};}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00091}00091\ \ \ \ \ ContextFrame.\mbox{\hyperlink{struct___t_r_a_p___f_r_a_m_e_a515ae478df5d026d97c16d466d1d2611}{ss}}\ =\ \mbox{\hyperlink{me_8h_ab7835d5c0b7d8988f4b58c033cd8e8d0}{USER\_SS}};}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00092}00092\ \ \ \ \ Thread-\/>\mbox{\hyperlink{struct___e_t_h_r_e_a_d_a277ac0724d62341752a5d14f7ebe57fa}{InternalThread}}.\mbox{\hyperlink{struct___i_t_h_r_e_a_d_ababb8727e86c272342fa9424274c88b7}{TrapRegisters}}\ =\ ContextFrame;}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00093}00093\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00094}00094\ \ \ \ \ \textcolor{comment}{//\ Set\ state}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00095}00095\ \ \ \ \ Thread-\/>\mbox{\hyperlink{struct___e_t_h_r_e_a_d_a277ac0724d62341752a5d14f7ebe57fa}{InternalThread}}.\mbox{\hyperlink{struct___i_t_h_r_e_a_d_a0212532a6ccca439cbf4a98c092eb2c9}{ThreadState}}\ =\ \mbox{\hyperlink{ps_8h_aa10ee122164d8eab53bd059c31538ca3adc6a307a71277ce8d642b5b916e05042}{THREAD\_READY}};}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00096}00096\ \ \ \ \ Thread-\/>\mbox{\hyperlink{struct___e_t_h_r_e_a_d_a277ac0724d62341752a5d14f7ebe57fa}{InternalThread}}.\mbox{\hyperlink{struct___i_t_h_r_e_a_d_ae9e70a267dbbee57a023a480da6d34a9}{ApcState}}.\mbox{\hyperlink{struct___a_p_c___s_t_a_t_e_aa6bf8b2333758277c1ad3222df0533be}{SavedApcProcess}}\ =\ ParentProcess;}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00097}00097\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00098}00098\ \ \ \ \ \textcolor{comment}{//\ Set\ process's\ thread\ properties.}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00099}00099\ \ \ \ \ \textcolor{keywordflow}{if}\ (!ParentProcess-\/>\mbox{\hyperlink{struct___e_p_r_o_c_e_s_s_aa332e3add171f80b25646e5c1a3fd53b}{MainThread}})\ \{}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00100}00100\ \ \ \ \ \ \ \ \ ParentProcess-\/>\mbox{\hyperlink{struct___e_p_r_o_c_e_s_s_aa332e3add171f80b25646e5c1a3fd53b}{MainThread}}\ =\ Thread;}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00101}00101\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00102}00102\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00103}00103\ \ \ \ \ Thread-\/>\mbox{\hyperlink{struct___e_t_h_r_e_a_d_a1db330b908dc0c15f56f4a4de49ed883}{ParentProcess}}\ =\ ParentProcess;}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00104}00104\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00105}00105\ \ \ \ \ \textcolor{comment}{//\ Create\ a\ handle\ for\ the\ thread\ (and\ place\ it\ in\ the\ process's\ handle\ table).}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00106}00106\ \ \ \ \ Status\ =\ \mbox{\hyperlink{ob_8c_a70b2e47218e2d92659efb010e14c5993}{ObCreateHandleForObjectEx}}(Thread,\ \mbox{\hyperlink{ps_8h_a7364848e8554eb43b069f7f56c28c26c}{MT\_THREAD\_ALL\_ACCESS}},\ ThreadHandle,\ ParentProcess-\/>\mbox{\hyperlink{struct___e_p_r_o_c_e_s_s_a433fb021c56e2c0fdbdec96ea9dcecab}{ObjectTable}});}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00107}00107\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{mtstatus_8h_a51b65f92cdedadf23a01dff0f9f4fac7}{MT\_FAILURE}}(Status))\ \textcolor{keywordflow}{goto}\ CleanupWithRef;}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00108}00108\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00109}00109\ \ \ \ \ \textcolor{comment}{//\ Add\ to\ list\ of\ all\ threads\ in\ the\ parent\ process.}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00110}00110\ \ \ \ \ \mbox{\hyperlink{ms_8h_abc60fab3d33ed1b1c9f11d1ed674a7b3}{InsertTailList}}(\&ParentProcess-\/>\mbox{\hyperlink{struct___e_p_r_o_c_e_s_s_afa2bf092db11195fa0f0688767cd7baf}{AllThreads}},\ \&Thread-\/>\mbox{\hyperlink{struct___e_t_h_r_e_a_d_af89b69b8dfdc6f73ffba7bdf79eeec8e}{ThreadListEntry}});}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00111}00111\ \ \ \ \ \mbox{\hyperlink{atomic_8h_a27cd82fe2beb9519f805e93551e2aa4b}{InterlockedIncrementU32}}((\textcolor{keyword}{volatile}\ uint32\_t*)\&ParentProcess-\/>\mbox{\hyperlink{struct___e_p_r_o_c_e_s_s_a18cc8b1fbce9eb05da106ba8c46a9cb1}{NumThreads}});}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00112}00112\ \ \ \ \ Status\ =\ \mbox{\hyperlink{mtstatus_8h_a147849337a41d8be9ccb4ef599b84a86}{MT\_SUCCESS}};}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00113}00113\ CleanupWithRef:}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00114}00114\ \ \ \ \ \textcolor{comment}{//\ If\ all\ went\ smoothly,\ this\ should\ cancel\ out\ the\ reference\ made\ by\ ObCreateHandleForObject.\ (so\ we\ only\ have\ 1\ reference\ left\ by\ ObCreateObject)}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00115}00115\ \ \ \ \ \textcolor{comment}{//\ If\ not,\ it\ would\ reach\ reference\ 0,\ and\ PspDeleteThread\ would\ execute.}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00116}00116\ \ \ \ \ \mbox{\hyperlink{ob_8c_a7dee8ead706a375c2a916dc9ed752224}{ObDereferenceObject}}(Thread);}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00117}00117\ Cleanup:}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00118}00118\ \ \ \ \ \mbox{\hyperlink{rundown_8c_a83aff9858a03409861f6c210b508b012}{MsReleaseRundownProtection}}(\&ParentProcess-\/>\mbox{\hyperlink{struct___e_p_r_o_c_e_s_s_a1e28d84793df7af85a2a5154fcd435c7}{ProcessRundown}});}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00119}00119\ \ \ \ \ \textcolor{keywordflow}{return}\ Status;}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00120}00120\ \}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00121}00121\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00122}\mbox{\hyperlink{thread_8c_a07ad56c2b409d9a227ff6787d9f48643}{00122}}\ \mbox{\hyperlink{mtstatus_8h_a7c794b38d203a5b842f27b12fb55495a}{MTSTATUS}}\ \mbox{\hyperlink{thread_8c_a07ad56c2b409d9a227ff6787d9f48643}{PsCreateSystemThread}}(\mbox{\hyperlink{ps_8h_a72fcf929d51dce199593912ed4910ade}{ThreadEntry}}\ entry,\ \mbox{\hyperlink{ps_8h_ac97f2b26eaa411a9744e1be2fbc90c11}{THREAD\_PARAMETER}}\ parameter,\ \mbox{\hyperlink{me_8h_ae2fa920c6cd4660356637d5a33222a70}{TimeSliceTicks}}\ TIMESLICE)\ \{}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00123}00123\ \ \ \ \ \textcolor{keywordflow}{if}\ (!\mbox{\hyperlink{scheduler_8c_ac6c835f9ef3163dba3826f22bf43b9d2}{PsInitialSystemProcess}}.PID)\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{mtstatus_8h_aafd803b321d036759d81fd68163ea0fd}{MT\_NOT\_FOUND}};\ \textcolor{comment}{//\ The\ system\ process,\ somehow,\ hasn't\ been\ setupped\ yet.}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00124}00124\ \ \ \ \ \textcolor{keywordflow}{if}\ (!entry\ ||\ !TIMESLICE)\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{mtstatus_8h_a55458e0861f6a58c2bc62538f93609ce}{MT\_INVALID\_PARAM}};}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00125}00125\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00126}00126\ \ \ \ \ \textcolor{comment}{//\ First,\ allocate\ a\ new\ thread.\ (using\ our\ shiny\ and\ glossy\ new\ object\ manager!!!)}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00127}00127\ \ \ \ \ \mbox{\hyperlink{mtstatus_8h_a7c794b38d203a5b842f27b12fb55495a}{MTSTATUS}}\ Status;}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00128}00128\ \ \ \ \ \mbox{\hyperlink{core_8h_ad66fec9d1871be79dbc3f828f4ac5ee7}{PETHREAD}}\ thread;\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00129}00129\ \ \ \ \ Status\ =\ \mbox{\hyperlink{ob_8c_ad77278de8f30feb544f7bd27bd85a81f}{ObCreateObject}}(\mbox{\hyperlink{psmgr_8c_a32564f2df24bd688bb18b93f81d3bf7d}{PsThreadType}},\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{core_8h_ab36019f6c21ddbae4a9dd226ed885a46}{ETHREAD}}),\ (\textcolor{keywordtype}{void}*)\ \&\ thread);}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00130}00130\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{mtstatus_8h_a51b65f92cdedadf23a01dff0f9f4fac7}{MT\_FAILURE}}(Status))\ \{}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00131}00131\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ Status;}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00132}00132\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00133}00133\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00134}00134\ \ \ \ \ \mbox{\hyperlink{ms_8h_a46e3ce34dec4da38189211cef81110c1}{InitializeListHead}}(\&thread-\/>\mbox{\hyperlink{struct___e_t_h_r_e_a_d_af89b69b8dfdc6f73ffba7bdf79eeec8e}{ThreadListEntry}});}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00135}00135\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00136}00136\ \ \ \ \ \textcolor{comment}{//\ Zero\ it.}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00137}00137\ \ \ \ \ \mbox{\hyperlink{mm_8h_a7d9455da4f2ec94a98286a19e7d8e39d}{kmemset}}((\textcolor{keywordtype}{void}*)thread,\ 0,\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{core_8h_ab36019f6c21ddbae4a9dd226ed885a46}{ETHREAD}}));}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00138}00138\ \ \ \ \ \textcolor{keywordtype}{bool}\ LargeStack\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00139}00139\ \ \ \ \ \textcolor{keywordtype}{void}*\ stackStart\ =\ \mbox{\hyperlink{mmproc_8c_a395221ebf401ad2be0b1e0b2389da78d}{MiCreateKernelStack}}(LargeStack);}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00140}00140\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00141}00141\ \ \ \ \ \textcolor{keywordflow}{if}\ (!stackStart)\ \{}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00142}00142\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ free\ thread}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00143}00143\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{ob_8c_a7dee8ead706a375c2a916dc9ed752224}{ObDereferenceObject}}(thread);}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00144}00144\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{mtstatus_8h_a04d00d9b51e2f25c23b87d750df59dc4}{MT\_NO\_MEMORY}};}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00145}00145\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00146}00146\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00147}00147\ \ \ \ \ uintptr\_t\ StackTop\ =\ (uintptr\_t)stackStart;}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00148}00148\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00149}00149\ \ \ \ \ StackTop\ \&=\ \string~0xF;\ \textcolor{comment}{//\ Align\ to\ 16\ bytes\ (clear\ lower\ 4\ bits)}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00150}00150\ \ \ \ \ StackTop\ -\/=\ 8;\ \textcolor{comment}{//\ Decrement\ by\ 8\ to\ keep\ 16-\/byte\ alignment.\ (after\ pushes)}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00151}00151\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00152}00152\ \ \ \ \ thread-\/>\mbox{\hyperlink{struct___e_t_h_r_e_a_d_a277ac0724d62341752a5d14f7ebe57fa}{InternalThread}}.\mbox{\hyperlink{struct___i_t_h_r_e_a_d_a11a9d0f7a133753b1f3af14396caf0fc}{StackBase}}\ =\ stackStart;\ \textcolor{comment}{//\ The\ stackbase\ must\ be\ the\ one\ gotten\ from\ MiCreateKernelStack,\ as\ freeing\ with\ StackTop\ will\ result\ in\ incorrect\ arithmetic,\ and\ so\ assertion\ failure.}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00153}00153\ \ \ \ \ thread-\/>\mbox{\hyperlink{struct___e_t_h_r_e_a_d_a277ac0724d62341752a5d14f7ebe57fa}{InternalThread}}.\mbox{\hyperlink{struct___i_t_h_r_e_a_d_a1ceb5f81bce3838a9703c746dbfc9066}{IsLargeStack}}\ =\ LargeStack;}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00154}00154\ \ \ \ \ thread-\/>\mbox{\hyperlink{struct___e_t_h_r_e_a_d_a277ac0724d62341752a5d14f7ebe57fa}{InternalThread}}.\mbox{\hyperlink{struct___i_t_h_r_e_a_d_a949a9f69e54a9c4714e29011de37383e}{KernelStack}}\ =\ stackStart;}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00155}00155\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00156}00156\ \ \ \ \ \mbox{\hyperlink{core_8h_a14d79ce92fc8bd426be5e9b939f8ba7a}{TRAP\_FRAME}}*\ cfm\ =\ \&thread-\/>\mbox{\hyperlink{struct___e_t_h_r_e_a_d_a277ac0724d62341752a5d14f7ebe57fa}{InternalThread}}.\mbox{\hyperlink{struct___i_t_h_r_e_a_d_ababb8727e86c272342fa9424274c88b7}{TrapRegisters}};}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00157}00157\ \ \ \ \ \mbox{\hyperlink{mm_8h_a7d9455da4f2ec94a98286a19e7d8e39d}{kmemset}}(cfm,\ 0,\ \textcolor{keyword}{sizeof}\ *\ cfm);}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00158}00158\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00159}00159\ \ \ \ \ \textcolor{comment}{//\ Set\ our\ timeslice.}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00160}00160\ \ \ \ \ thread-\/>\mbox{\hyperlink{struct___e_t_h_r_e_a_d_a277ac0724d62341752a5d14f7ebe57fa}{InternalThread}}.\mbox{\hyperlink{struct___i_t_h_r_e_a_d_a8888cdbf0abf1eab5ad7011409de2220}{TimeSlice}}\ =\ TIMESLICE;}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00161}00161\ \ \ \ \ thread-\/>\mbox{\hyperlink{struct___e_t_h_r_e_a_d_a277ac0724d62341752a5d14f7ebe57fa}{InternalThread}}.\mbox{\hyperlink{struct___i_t_h_r_e_a_d_ac82dc0f66693dda24c97ed90c0f899b7}{TimeSliceAllocated}}\ =\ TIMESLICE;}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00162}00162\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00163}00163\ \ \ \ \ \textcolor{comment}{//\ saved\ rsp\ must\ point\ to\ the\ top\ (aligned),\ not\ sp-\/8}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00164}00164\ \ \ \ \ cfm-\/>\mbox{\hyperlink{struct___t_r_a_p___f_r_a_m_e_a8e218c31298bb17b5041cfc61646d6b9}{rsp}}\ =\ (uint64\_t)StackTop;}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00165}00165\ \ \ \ \ cfm-\/>\mbox{\hyperlink{struct___t_r_a_p___f_r_a_m_e_a90e28f434559f0582a69699dc4dbc286}{rip}}\ =\ (uint64\_t)ThreadWrapperEx;}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00166}00166\ \ \ \ \ cfm-\/>\mbox{\hyperlink{struct___t_r_a_p___f_r_a_m_e_a5764734a394146dcf093f9295c2fd5b4}{rdi}}\ =\ (uint64\_t)entry;\ \textcolor{comment}{//\ first\ argument\ to\ ThreadWrapperEx\ (the\ entry\ point)}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00167}00167\ \ \ \ \ cfm-\/>\mbox{\hyperlink{struct___t_r_a_p___f_r_a_m_e_ac778707d44587840c5bd1269e8644eb9}{rsi}}\ =\ (uint64\_t)parameter;\ \textcolor{comment}{//\ second\ arugment\ to\ ThreadWrapperEx\ (the\ parameter\ pointer)}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00168}00168\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00169}00169\ \ \ \ \ cfm-\/>\mbox{\hyperlink{struct___t_r_a_p___f_r_a_m_e_a515ae478df5d026d97c16d466d1d2611}{ss}}\ =\ \mbox{\hyperlink{me_8h_a0f0e6aa17e708f29f1de07be4d6c53e8}{KERNEL\_SS}};}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00170}00170\ \ \ \ \ cfm-\/>\mbox{\hyperlink{struct___t_r_a_p___f_r_a_m_e_aea3e8b50ef91f54dad11c01a77675324}{cs}}\ =\ \mbox{\hyperlink{me_8h_ab0b69b822e9207a5960bc07fc3d36ee4}{KERNEL\_CS}};}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00171}00171\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00172}00172\ \ \ \ \ \textcolor{comment}{//\ Create\ it's\ RFLAGS\ with\ IF\ bit\ set\ to\ 1.}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00173}00173\ \ \ \ \ cfm-\/>\mbox{\hyperlink{struct___t_r_a_p___f_r_a_m_e_ac67e007ae346a1499c5a276869bfd1bb}{rflags}}\ |=\ (1\ <<\ 9ULL);}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00174}00174\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00175}00175\ \ \ \ \ \textcolor{comment}{//\ Set\ it's\ registers\ and\ others.}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00176}00176\ \ \ \ \ thread-\/>\mbox{\hyperlink{struct___e_t_h_r_e_a_d_a277ac0724d62341752a5d14f7ebe57fa}{InternalThread}}.\mbox{\hyperlink{struct___i_t_h_r_e_a_d_ababb8727e86c272342fa9424274c88b7}{TrapRegisters}}\ =\ *cfm;}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00177}00177\ \ \ \ \ thread-\/>\mbox{\hyperlink{struct___e_t_h_r_e_a_d_a277ac0724d62341752a5d14f7ebe57fa}{InternalThread}}.\mbox{\hyperlink{struct___i_t_h_r_e_a_d_a0212532a6ccca439cbf4a98c092eb2c9}{ThreadState}}\ =\ \mbox{\hyperlink{ps_8h_aa10ee122164d8eab53bd059c31538ca3adc6a307a71277ce8d642b5b916e05042}{THREAD\_READY}};}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00178}00178\ \ \ \ \ thread-\/>\mbox{\hyperlink{struct___e_t_h_r_e_a_d_a4f322c225ea87b4c71a53def5189f4a2}{TID}}\ =\ \mbox{\hyperlink{cid_8c_a5dfbea187ffb7f2ef182fb25330e6d8a}{PsAllocateThreadId}}(thread);}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00179}00179\ \ \ \ \ thread-\/>\mbox{\hyperlink{struct___e_t_h_r_e_a_d_a9f858225ecfd7174a28bddc1a075bd08}{CurrentEvent}}\ =\ NULL;}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00180}00180\ \ \ \ \ thread-\/>\mbox{\hyperlink{struct___e_t_h_r_e_a_d_a277ac0724d62341752a5d14f7ebe57fa}{InternalThread}}.\mbox{\hyperlink{struct___i_t_h_r_e_a_d_ae9e70a267dbbee57a023a480da6d34a9}{ApcState}}.\mbox{\hyperlink{struct___a_p_c___s_t_a_t_e_aa6bf8b2333758277c1ad3222df0533be}{SavedApcProcess}}\ =\ \&\mbox{\hyperlink{scheduler_8c_ac6c835f9ef3163dba3826f22bf43b9d2}{PsInitialSystemProcess}};}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00181}00181\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00182}00182\ \ \ \ \ \textcolor{comment}{//\ Process\ stuffz}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00183}00183\ \ \ \ \ thread-\/>\mbox{\hyperlink{struct___e_t_h_r_e_a_d_a1db330b908dc0c15f56f4a4de49ed883}{ParentProcess}}\ =\ \&\mbox{\hyperlink{scheduler_8c_ac6c835f9ef3163dba3826f22bf43b9d2}{PsInitialSystemProcess}};\ \textcolor{comment}{//\ The\ parent\ process\ for\ the\ system\ thread,\ is\ the\ system\ process.}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00184}00184\ \ \ \ \ \mbox{\hyperlink{ps_8h_a082a6c14a0748ab67e5560c96a47b623}{MeEnqueueThreadWithLock}}(\&\mbox{\hyperlink{me_8h_ad67c53006a896cba38c6eabe92a0ad91}{MeGetCurrentProcessor}}()-\/>readyQueue,\ thread);}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00185}00185\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00186}00186\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00187}00187\ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{mtstatus_8h_a147849337a41d8be9ccb4ef599b84a86}{MT\_SUCCESS}};}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00188}00188\ \}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00189}00189\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00190}00190\ \mbox{\hyperlink{core_8h_ad66fec9d1871be79dbc3f828f4ac5ee7}{PETHREAD}}\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00191}\mbox{\hyperlink{thread_8c_a83437e8cd9a8e8befc491348dfcb41c0}{00191}}\ \mbox{\hyperlink{thread_8c_a83437e8cd9a8e8befc491348dfcb41c0}{PsGetCurrentThread}}\ (\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00192}00192\ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{macros_8h_aad0775b806dea2a5529806f0e8d90cee}{CONTAINING\_RECORD}}(\mbox{\hyperlink{me_8h_a47d6bb330b3f195c125bd452af7031c8}{MeGetCurrentThread}}(),\ \mbox{\hyperlink{core_8h_ab36019f6c21ddbae4a9dd226ed885a46}{ETHREAD}},\ InternalThread);}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00193}00193\ \}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00194}00194\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00195}00195\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00196}\mbox{\hyperlink{thread_8c_a15e6e7020dd68d4ec91f0dee0cdae31a}{00196}}\ \mbox{\hyperlink{thread_8c_a15e6e7020dd68d4ec91f0dee0cdae31a}{PsTerminateThread}}(}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00197}00197\ \ \ \ \ \mbox{\hyperlink{annotations_8h_ac2bbd6d630a06a980d9a92ddb9a49928}{IN}}\ \mbox{\hyperlink{core_8h_ad66fec9d1871be79dbc3f828f4ac5ee7}{PETHREAD}}\ Thread,}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00198}00198\ \ \ \ \ \mbox{\hyperlink{annotations_8h_ac2bbd6d630a06a980d9a92ddb9a49928}{IN}}\ \mbox{\hyperlink{mtstatus_8h_a7c794b38d203a5b842f27b12fb55495a}{MTSTATUS}}\ ExitStatus}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00199}00199\ )}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00200}00200\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00201}00201\ \{}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00202}00202\ \ \ \ \ \textcolor{comment}{//\ On\ thread\ terminations,\ we\ only\ unlink\ them\ from\ global\ list,\ delete\ stacks,\ and\ other}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00203}00203\ \ \ \ \ \textcolor{comment}{//\ BUT\ WE\ DO\ NOT\ -\/\ Delete\ the\ ETHREAD,\ since\ thats\ up\ to\ the\ object\ manager\ to\ do\ so,\ we\ do\ not\ interfere}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00204}00204\ \ \ \ \ \textcolor{comment}{//\ with\ its\ work.}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00205}00205\ \ \ \ \ Thread-\/>InternalThread.ThreadState\ =\ \mbox{\hyperlink{ps_8h_aa10ee122164d8eab53bd059c31538ca3a671b68cda962520c0b53a108cb584203}{THREAD\_TERMINATING}};}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00206}00206\ \ \ \ \ Thread-\/>ExitStatus\ =\ ExitStatus;}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00207}00207\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00208}00208\ \ \ \ \ \textcolor{comment}{//\ Signal\ all\ events\ that\ the\ thread\ is\ waiting\ on\ to\ execute\ immediately.}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00209}00209\ \ \ \ \ \textcolor{comment}{//\ Todo\ parse\ waitblock.}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00210}00210\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00211}00211\ \ \ \ \ \textcolor{comment}{//\ Since\ this\ is\ marked\ as\ TERMINATING,\ the\ scheduler\ will\ dereference\ the\ thread\ in\ Ob,\ and\ from\ that\ if}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00212}00212\ \ \ \ \ \textcolor{comment}{//\ the\ references\ have\ reached\ 0,\ the\ Ob\ will\ call\ PsDeleteThread.}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00213}00213\ \ \ \ \ \textcolor{comment}{//\ The\ scheduler\ WILL\ NOT\ schedule\ this\ thread\ anymore\ due\ to\ its\ TERMINATION\ flag.}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00214}00214\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00215}00215\ \ \ \ \ \textcolor{comment}{//\ Schedule\ away!}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00216}00216\ \ \ \ \ \mbox{\hyperlink{scheduler_8c_a0014bec3cf8d95a2fe028d30d8f7bd1d}{Schedule}}();}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00217}00217\ \}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00218}00218\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00219}00219\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00220}\mbox{\hyperlink{thread_8c_ace7d0ce52fd3242f29560caa1197ddc2}{00220}}\ \mbox{\hyperlink{thread_8c_ace7d0ce52fd3242f29560caa1197ddc2}{PsDeleteThread}}(}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00221}00221\ \ \ \ \ \mbox{\hyperlink{annotations_8h_ac2bbd6d630a06a980d9a92ddb9a49928}{IN}}\ \textcolor{keywordtype}{void}*\ Object}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00222}00222\ )}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00223}00223\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00224}00224\ \{}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00225}00225\ \ \ \ \ \textcolor{comment}{//\ This\ function\ is\ called\ when\ the\ reference\ count\ for\ this\ thread\ has\ reached\ 0\ (e.g,\ it\ is\ no\ longer\ in\ use)}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00226}00226\ \ \ \ \ \textcolor{comment}{//\ (No\ need\ to\ call\ PsTerminateThread,\ it\ is\ the\ one\ that\ initiated\ the\ final\ dereference,\ since\ it\ set\ to\ terminated,\ and\ scheduler\ called\ dereference)}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00227}00227\ \ \ \ \ \textcolor{comment}{//\ We\ free\ everything\ that\ the\ thread\ uses.}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00228}00228\ \ \ \ \ \textcolor{comment}{//\ All\ though,\ before,\ we\ should\ wait\ for\ rundown\ release\ (so\ nobody\ is\ changing\ the\ fields\ to\ avoid\ UAF)}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00229}00229\ \ \ \ \ \mbox{\hyperlink{core_8h_ad66fec9d1871be79dbc3f828f4ac5ee7}{PETHREAD}}\ Thread\ =\ (\mbox{\hyperlink{core_8h_ad66fec9d1871be79dbc3f828f4ac5ee7}{PETHREAD}})Object;}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00230}00230\ \ \ \ \ \mbox{\hyperlink{rundown_8c_aac47f99e0adc9ac0498d115f952e7ec6}{MsWaitForRundownProtectionRelease}}(\&Thread-\/>\mbox{\hyperlink{struct___e_t_h_r_e_a_d_a17130bdf8bc4c41840767d7f5d775aa3}{ThreadRundown}});}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00231}00231\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00232}00232\ \ \ \ \ \textcolor{keywordtype}{bool}\ IsKernelThread\ =\ \mbox{\hyperlink{ps_8h_aa30db9b8d584b69873c706c5ea12aa87}{PsIsKernelThread}}(Thread);}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00233}00233\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00234}00234\ \ \ \ \ \textcolor{comment}{//\ Free\ TID.}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00235}00235\ \ \ \ \ \mbox{\hyperlink{cid_8c_ae34f562ec68ec4d092329da8efa705e6}{PsFreeCid}}(Thread-\/>\mbox{\hyperlink{struct___e_t_h_r_e_a_d_a4f322c225ea87b4c71a53def5189f4a2}{TID}});}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00236}00236\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00237}00237\ \ \ \ \ \textcolor{comment}{//\ Free\ its\ stack.}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00238}00238\ \ \ \ \ \textcolor{keywordflow}{if}\ (IsKernelThread)\ \{}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00239}00239\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{pswork_8c_a8622c6be494cf16caf6a6c2eb8009343}{PsDeferKernelStackDeletion}}(Thread-\/>\mbox{\hyperlink{struct___e_t_h_r_e_a_d_a277ac0724d62341752a5d14f7ebe57fa}{InternalThread}}.\mbox{\hyperlink{struct___i_t_h_r_e_a_d_a11a9d0f7a133753b1f3af14396caf0fc}{StackBase}},\ Thread-\/>\mbox{\hyperlink{struct___e_t_h_r_e_a_d_a277ac0724d62341752a5d14f7ebe57fa}{InternalThread}}.\mbox{\hyperlink{struct___i_t_h_r_e_a_d_a1ceb5f81bce3838a9703c746dbfc9066}{IsLargeStack}});}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00240}00240\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00241}00241\ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00242}00242\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{assert_8h_a3d4ae9c092e117c836f52dc7d7cee574}{assert}}(\textcolor{keyword}{false},\ \textcolor{stringliteral}{"{}User\ mode\ threads\ are\ not\ supported\ yet."{}});}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00243}00243\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00244}00244\ }
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00245}00245\ \ \ \ \ \textcolor{comment}{//\ When\ we\ reach\ here,\ the\ function\ returns,\ and\ the\ ETHREAD\ is\ deleted.}}
\DoxyCodeLine{\Hypertarget{thread_8c_source_l00246}00246\ \}}

\end{DoxyCode}

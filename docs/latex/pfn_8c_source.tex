\doxysection{pfn.\+c}
\hypertarget{pfn_8c_source}{}\label{pfn_8c_source}\index{C:/Users/matanel/Desktop/Projects/KernelDevelopment/kernel/core/mm/pfn.c@{C:/Users/matanel/Desktop/Projects/KernelDevelopment/kernel/core/mm/pfn.c}}
\mbox{\hyperlink{pfn_8c}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00001}00001\ \textcolor{comment}{/*++}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00002}00002\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00003}00003\ \textcolor{comment}{Module\ Name:}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00004}00004\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00005}00005\ \textcolor{comment}{\ \ \ \ pfn.c}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00006}00006\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00007}00007\ \textcolor{comment}{Purpose:}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00008}00008\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00009}00009\ \textcolor{comment}{\ \ \ \ This\ translation\ unit\ contains\ the\ implementation\ of\ the\ PFN\ Database\ (covers\ physical\ memory\ map\ init)}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00010}00010\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00011}00011\ \textcolor{comment}{Author:}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00012}00012\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00013}00013\ \textcolor{comment}{\ \ \ \ slep\ (Matanel)\ 2025.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00014}00014\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00015}00015\ \textcolor{comment}{Revision\ History:}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00016}00016\ \textcolor{comment}{\ \ \ \ DD/MM/YY}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00017}00017\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00018}00018\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00019}00019\ \textcolor{comment}{\ \ \ \ 17/10/2025\ -\/\ Revised\ Physical\ Memory\ from\ a\ simple\ bitmap\ to\ a\ PFN\ database.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00020}00020\ \textcolor{comment}{\ \ \ \ }}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00021}00021\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00022}00022\ \textcolor{comment}{-\/-\/*/}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00023}00023\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00024}00024\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{mm_8h}{../../includes/mm.h}}"{}}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00025}00025\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{mg_8h}{../../includes/mg.h}}"{}}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00026}00026\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{assert_8h}{../../assert.h}}"{}}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00027}00027\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{me_8h}{../../includes/me.h}}"{}}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00028}00028\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00029}\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{00029}}\ \mbox{\hyperlink{mm_8h_a67864b7f6770308b692c66253a69e09d}{MM\_PFN\_DATABASE}}\ \mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00030}\mbox{\hyperlink{pfn_8c_a751b1ff6046212e402e3ac873016e7ff}{00030}}\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{pfn_8c_a751b1ff6046212e402e3ac873016e7ff}{MmPfnDatabaseInitialized}}\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00031}\mbox{\hyperlink{pfn_8c_a22803a09c3713dda1ef6f7ee637874dc}{00031}}\ \mbox{\hyperlink{mm_8h_a7ce93fd02781ab3e20db6b11d7e28395}{PAGE\_INDEX}}\ \mbox{\hyperlink{pfn_8c_a22803a09c3713dda1ef6f7ee637874dc}{MmHighestPfn}}\ =\ 0;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00032}00032\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00033}00033\ \textcolor{keyword}{static}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00034}00034\ uint64\_t\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00035}00035\ MiGetTotalMemory\ (}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00036}00036\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{efi_8h_aa7f93145770b2b55fa44fc8b9a2cf58d}{BOOT\_INFO}}*\ boot\_info}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00037}00037\ )}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00038}00038\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00039}00039\ \textcolor{comment}{/*++}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00040}00040\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00041}00041\ \textcolor{comment}{\ \ \ \ Routine\ description:}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00042}00042\ \textcolor{comment}{\ \ \ \ }}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00043}00043\ \textcolor{comment}{\ \ \ \ \ \ \ \ Calculates\ the\ highest\ address\ of\ USABLE\ physical\ memory\ in\ the\ system.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00044}00044\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00045}00045\ \textcolor{comment}{\ \ \ \ Arguments:}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00046}00046\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00047}00047\ \textcolor{comment}{\ \ \ \ \ \ \ \ [IN]\ \ \ \ Pointer\ to\ BOOT\_INFO\ struct,\ obtained\ from\ UEFI.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00048}00048\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00049}00049\ \textcolor{comment}{\ \ \ \ Return\ Values:}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00050}00050\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00051}00051\ \textcolor{comment}{\ \ \ \ \ \ \ \ Highest\ Usable\ Address\ in\ physical\ memory\ (total\ amount\ of\ usable\ RAM)}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00052}00052\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00053}00053\ \textcolor{comment}{\ \ \ \ \ \ \ \ DO\ NOTE:\ The\ function\ will\ return\ the\ max\ address\ that\ is\ usable\ in\ the\ system,\ which\ might\ leave\ MMIO\ holes\ above,\ these\ will\ NOT\ be\ added\ into\ the\ PFN\ DB.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00054}00054\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00055}00055\ \textcolor{comment}{-\/-\/*/}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00056}00056\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00057}00057\ \{}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00058}00058\ \ \ \ \ uint64\_t\ highest\_addr\ =\ 0;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00059}00059\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ entry\_count\ =\ boot\_info-\/>\mbox{\hyperlink{struct___b_o_o_t___i_n_f_o_a9bec53c13537ffc17434fc3db3f36f0d}{MapSize}}\ /\ boot\_info-\/>\mbox{\hyperlink{struct___b_o_o_t___i_n_f_o_a8bc89261b88b97450ff261d153d0bbdb}{DescriptorSize}};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00060}00060\ \ \ \ \ \mbox{\hyperlink{efi_8h_aef521078a6a7d9bacb81e5cd18cf37b9}{PEFI\_MEMORY\_DESCRIPTOR}}\ desc\ =\ boot\_info-\/>\mbox{\hyperlink{struct___b_o_o_t___i_n_f_o_a43e384015b713dc64d7f8a59ad452622}{MemoryMap}};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00061}00061\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00062}00062\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ entry\_count;\ i++)\ \{}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00063}00063\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ FILTER:\ Only\ look\ at\ usable\ RAM\ or\ memory\ we\ might\ reclaim.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00064}00064\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Ignore\ Reserved,\ Unusable,\ and\ MemoryMappedIO.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00065}00065\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ TODO\ Other\ types...}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00066}00066\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (desc-\/>\mbox{\hyperlink{struct___e_f_i___m_e_m_o_r_y___d_e_s_c_r_i_p_t_o_r_a140acdd7ac30628e97d1851104f05c03}{Type}}\ ==\ \mbox{\hyperlink{efi_8h_af095fe56818f3bd8a310206b8777bb1c}{EfiConventionalMemory}})}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00067}00067\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00068}00068\ \ \ \ \ \ \ \ \ \ \ \ \ uint64\_t\ region\_end\ =\ desc-\/>\mbox{\hyperlink{struct___e_f_i___m_e_m_o_r_y___d_e_s_c_r_i_p_t_o_r_ad31a686b44d9fa70840b0f625434e291}{PhysicalStart}}\ +\ (desc-\/>\mbox{\hyperlink{struct___e_f_i___m_e_m_o_r_y___d_e_s_c_r_i_p_t_o_r_a84530c369b622a5f3899052267fa18fe}{NumberOfPages}}\ *\ \mbox{\hyperlink{mm_8h_a0b0f623858c974a2dc2a4361d59341c2}{PhysicalFrameSize}});}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00069}00069\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (region\_end\ >\ highest\_addr)\ highest\_addr\ =\ region\_end;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00070}00070\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00071}00071\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00072}00072\ \ \ \ \ \ \ \ \ desc\ =\ (\mbox{\hyperlink{efi_8h_aef521078a6a7d9bacb81e5cd18cf37b9}{PEFI\_MEMORY\_DESCRIPTOR}})((uint8\_t*)desc\ +\ boot\_info-\/>\mbox{\hyperlink{struct___b_o_o_t___i_n_f_o_a8bc89261b88b97450ff261d153d0bbdb}{DescriptorSize}});}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00073}00073\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00074}00074\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00075}00075\ \ \ \ \ \textcolor{keywordflow}{return}\ highest\_addr;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00076}00076\ \}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00077}00077\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00078}00078\ \textcolor{keyword}{static}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00079}00079\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00080}00080\ MiReservePhysRange(}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00081}00081\ \ \ \ \ uint64\_t\ phys\_start,}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00082}00082\ \ \ \ \ uint64\_t\ length}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00083}00083\ )}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00084}00084\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00085}00085\ \{}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00086}00086\ \ \ \ \ uint64\_t\ first\ =\ phys\_start\ /\ \mbox{\hyperlink{mm_8h_a0b0f623858c974a2dc2a4361d59341c2}{PhysicalFrameSize}};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00087}00087\ \ \ \ \ uint64\_t\ pages\ =\ (length\ +\ \mbox{\hyperlink{mm_8h_a0b0f623858c974a2dc2a4361d59341c2}{PhysicalFrameSize}}\ -\/\ 1)\ /\ \mbox{\hyperlink{mm_8h_a0b0f623858c974a2dc2a4361d59341c2}{PhysicalFrameSize}};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00088}00088\ \ \ \ \ \textcolor{keywordflow}{for}\ (uint64\_t\ i\ =\ 0;\ i\ <\ pages;\ ++i)\ \{}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00089}00089\ \ \ \ \ \ \ \ \ uint64\_t\ idx\ =\ first\ +\ i;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00090}00090\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (idx\ >=\ \mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.TotalPageCount)\ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00091}00091\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{mm_8h_add4af0c873a7e9aa078742eac12b1879}{PPFN\_ENTRY}}\ e\ =\ \&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.PfnEntries[idx];}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00092}00092\ \ \ \ \ \ \ \ \ e-\/>\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_a279682d710d9c634f4a7121f1474c17c}{RefCount}}\ =\ 1;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00093}00093\ \ \ \ \ \ \ \ \ e-\/>\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_a9ac4c1f881137da2601ed5d333bb5989}{State}}\ =\ \mbox{\hyperlink{mm_8h_a12462d873d8d81a717b5a7622091e998a68c66f57633f47bedf7267c068ad1fc9}{PfnStateActive}};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00094}00094\ \ \ \ \ \ \ \ \ e-\/>\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_aeb3f0fed7dd127f81565f62281a7ae41}{Flags}}\ =\ \mbox{\hyperlink{mm_8h_ade48055747533779e94bcf44ff15e345a2083092a472202565e584dea988f0264}{PFN\_FLAG\_NONE}};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00095}00095\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{atomic_8h_a417663fb902a228350d64b7ad5e9d6cb}{InterlockedIncrementU64}}(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.TotalReserved);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00096}00096\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00097}00097\ \}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00098}00098\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00099}00099\ \mbox{\hyperlink{mtstatus_8h_a7c794b38d203a5b842f27b12fb55495a}{MTSTATUS}}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00100}\mbox{\hyperlink{pfn_8c_aa80c9f143f084f29f0961969eecbab97}{00100}}\ \mbox{\hyperlink{pfn_8c_aa80c9f143f084f29f0961969eecbab97}{MiInitializePfnDatabase}}(}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00101}00101\ \ \ \ \ \mbox{\hyperlink{annotations_8h_ac2bbd6d630a06a980d9a92ddb9a49928}{IN}}\ \ \mbox{\hyperlink{efi_8h_a30603a4329e93f45c29e6988998e39b8}{PBOOT\_INFO}}\ BootInfo}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00102}00102\ )}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00103}00103\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00104}00104\ \textcolor{comment}{/*++}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00105}00105\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00106}00106\ \textcolor{comment}{\ \ \ \ Routine\ description:\ }}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00107}00107\ \textcolor{comment}{\ \ \ \ \ \ \ \ }}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00108}00108\ \textcolor{comment}{\ \ \ \ \ \ \ \ Initializes\ the\ global\ PFN\ database.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00109}00109\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00110}00110\ \textcolor{comment}{\ \ \ \ Arguments:}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00111}00111\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00112}00112\ \textcolor{comment}{\ \ \ \ \ \ \ \ [IN]\ \ \ \ Pointer\ to\ BOOT\_INFO\ struct,\ obtained\ from\ UEFI.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00113}00113\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00114}00114\ \textcolor{comment}{\ \ \ \ Return\ Values:}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00115}00115\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00116}00116\ \textcolor{comment}{\ \ \ \ \ \ \ \ MTSTATUS\ Status\ Code.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00117}00117\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00118}00118\ \textcolor{comment}{-\/-\/*/}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00119}00119\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00120}00120\ \{}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00121}00121\ \ \ \ \ \textcolor{comment}{//\ First\ of\ all,\ before\ creating\ the\ PFN\ Database}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00122}00122\ \ \ \ \ \textcolor{comment}{//\ we\ would\ need\ the\ amount\ of\ total\ RAM,\ divide\ that\ by\ each\ physical\ frame\ size}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00123}00123\ \ \ \ \ \textcolor{comment}{//\ to\ allocate\ the\ amount\ of\ PFN\_ENTRY(ies)\ needed.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00124}00124\ \ \ \ \ uint64\_t\ totalRam\ =\ MiGetTotalMemory(BootInfo);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00125}00125\ \ \ \ \ \textcolor{keywordflow}{if}\ (!totalRam)\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{mtstatus_8h_a04d00d9b51e2f25c23b87d750df59dc4}{MT\_NO\_MEMORY}};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00126}00126\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00127}00127\ \ \ \ \ uint64\_t\ totalPfnEntries\ =\ totalRam\ /\ \mbox{\hyperlink{mm_8h_a0b0f623858c974a2dc2a4361d59341c2}{PhysicalFrameSize}};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00128}00128\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00129}00129\ \ \ \ \ \textcolor{comment}{//\ The\ amount\ of\ PFN\ Entries\ needed\ times\ the\ sizeof\ the\ struct,\ gives\ us\ the\ amount\ in\ bytes.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00130}00130\ \ \ \ \ uint64\_t\ neededRam\ =\ totalPfnEntries\ *\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{mm_8h_a6c0fa5674fb17649810840e7ca79bbf4}{PFN\_ENTRY}});}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00131}00131\ \ \ \ \ \mbox{\hyperlink{assert_8h_a3d4ae9c092e117c836f52dc7d7cee574}{assert}}((neededRam)\ <\ INT32\_MAX,\ \textcolor{stringliteral}{"{}Needed\ Ram\ DB\ is\ insanely\ huge"{}});}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00132}00132\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00133}00133\ \ \ \ \ \textcolor{comment}{//\ Now,\ we\ need\ to\ find\ a\ suitable\ memory\ region\ to\ hold\ the\ PFN\ Entries\ in.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00134}00134\ \ \ \ \ \mbox{\hyperlink{efi_8h_aef521078a6a7d9bacb81e5cd18cf37b9}{PEFI\_MEMORY\_DESCRIPTOR}}\ desc\ =\ BootInfo-\/>MemoryMap;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00135}00135\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ entryCount\ =\ BootInfo-\/>MapSize\ /\ BootInfo-\/>DescriptorSize;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00136}00136\ \ \ \ \ uint64\_t\ pfnEntriesPhys\ =\ 0;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00137}00137\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00138}00138\ \ \ \ \ \textcolor{comment}{//\ Loop\ over\ all\ memory.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00139}00139\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ entryCount;\ i++)\ \{}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00140}00140\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (desc-\/>\mbox{\hyperlink{struct___e_f_i___m_e_m_o_r_y___d_e_s_c_r_i_p_t_o_r_a140acdd7ac30628e97d1851104f05c03}{Type}}\ ==\ \mbox{\hyperlink{efi_8h_af095fe56818f3bd8a310206b8777bb1c}{EfiConventionalMemory}})\ \{}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00141}00141\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ This\ physical\ region\ size\ is\ the\ number\ of\ pages\ in\ it\ times\ frame\ size.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00142}00142\ \ \ \ \ \ \ \ \ \ \ \ \ uint64\_t\ regionSize\ =\ desc-\/>\mbox{\hyperlink{struct___e_f_i___m_e_m_o_r_y___d_e_s_c_r_i_p_t_o_r_a84530c369b622a5f3899052267fa18fe}{NumberOfPages}}\ *\ \mbox{\hyperlink{mm_8h_a0b0f623858c974a2dc2a4361d59341c2}{PhysicalFrameSize}};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00143}00143\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00144}00144\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (regionSize\ >=\ neededRam)\ \{}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00145}00145\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ This\ region\ can\ hold\ the\ PFN\ database\ entries.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00146}00146\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pfnEntriesPhys\ =\ desc-\/>\mbox{\hyperlink{struct___e_f_i___m_e_m_o_r_y___d_e_s_c_r_i_p_t_o_r_ad31a686b44d9fa70840b0f625434e291}{PhysicalStart}};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00147}00147\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00148}00148\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00149}00149\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00150}00150\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Advance\ to\ the\ next\ UEFI\ memory\ descriptor\ in\ the\ map.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00151}00151\ \ \ \ \ \ \ \ \ desc\ =\ (\mbox{\hyperlink{efi_8h_aef521078a6a7d9bacb81e5cd18cf37b9}{PEFI\_MEMORY\_DESCRIPTOR}})((uint8\_t*)desc\ +\ BootInfo-\/>DescriptorSize);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00152}00152\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00153}00153\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00154}00154\ \ \ \ \ \textcolor{comment}{//\ Verify\ we\ found\ a\ suitable\ region.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00155}00155\ \ \ \ \ \textcolor{keywordflow}{if}\ (!pfnEntriesPhys)\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{mtstatus_8h_aafd803b321d036759d81fd68163ea0fd}{MT\_NOT\_FOUND}};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00156}00156\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00157}00157\ \ \ \ \ \textcolor{comment}{//\ Convert\ the\ address\ to\ our\ virtual\ offsetable.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00158}00158\ \ \ \ \ uint64\_t\ pfnEntriesVirt\ =\ pfnEntriesPhys\ +\ \mbox{\hyperlink{mm_8h_aa1cd9b3c456e6501f130ba4f13636192}{PhysicalMemoryOffset}};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00159}00159\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00160}00160\ \ \ \ \ \textcolor{comment}{//\ Initialize\ the\ doubly\ linked\ lists.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00161}00161\ \ \ \ \ \mbox{\hyperlink{ms_8h_a46e3ce34dec4da38189211cef81110c1}{InitializeListHead}}(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.FreePageList.ListEntry);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00162}00162\ \ \ \ \ \mbox{\hyperlink{ms_8h_a46e3ce34dec4da38189211cef81110c1}{InitializeListHead}}(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.BadPageList.ListEntry);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00163}00163\ \ \ \ \ \mbox{\hyperlink{ms_8h_a46e3ce34dec4da38189211cef81110c1}{InitializeListHead}}(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.StandbyPageList.ListEntry);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00164}00164\ \ \ \ \ \mbox{\hyperlink{ms_8h_a46e3ce34dec4da38189211cef81110c1}{InitializeListHead}}(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.ZeroedPageList.ListEntry);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00165}00165\ \ \ \ \ \mbox{\hyperlink{ms_8h_a46e3ce34dec4da38189211cef81110c1}{InitializeListHead}}(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.ModifiedPageList.ListEntry);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00166}00166\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00167}00167\ \ \ \ \ \textcolor{comment}{//\ Map\ the\ whole\ region,\ acquire\ its\ PTE\ for\ each\ 4KiB.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00168}00168\ \ \ \ \ uint64\_t\ neededPages\ =\ (neededRam\ +\ \mbox{\hyperlink{mm_8h_acf0ee72c65911c54a418ccefba70ee77}{VirtualPageSize}}\ -\/\ 1)\ /\ \mbox{\hyperlink{mm_8h_acf0ee72c65911c54a418ccefba70ee77}{VirtualPageSize}};\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00169}00169\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00170}00170\ \ \ \ \ \textcolor{keywordflow}{for}\ (uint64\_t\ i\ =\ 0;\ i\ <\ neededPages;\ i++)\ \{}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00171}00171\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{mm_8h_a58b57de8cb1ef44a0f90f7f6e82f4b17}{PMMPTE}}\ pte\ =\ \mbox{\hyperlink{map_8c_ae02125d7ba25e59d4034251153f86492}{MiGetPtePointer}}(pfnEntriesVirt);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00172}00172\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!pte)\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{mtstatus_8h_a1c3bb6736a4567dcb59b8bbaa5837a6e}{MT\_GENERAL\_FAILURE}};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00173}00173\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{mm_8h_adc67d797a4f0738b7e8b651af8bdfd71}{MI\_WRITE\_PTE}}(pte,\ pfnEntriesVirt,\ pfnEntriesPhys,\ \mbox{\hyperlink{mm_8h_a00a91f63329e5c0511b76df1ce7884b0ac5ccf22183fd81d4268d6eb4f3bad604}{PAGE\_PRESENT}}\ |\ \mbox{\hyperlink{mm_8h_a00a91f63329e5c0511b76df1ce7884b0a0e92aa1b5476d7f05fbdf6fe3acfeed6}{PAGE\_RW}});}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00174}00174\ \ \ \ \ \ \ \ \ pfnEntriesVirt\ +=\ \mbox{\hyperlink{mm_8h_acf0ee72c65911c54a418ccefba70ee77}{VirtualPageSize}};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00175}00175\ \ \ \ \ \ \ \ \ pfnEntriesPhys\ +=\ \mbox{\hyperlink{mm_8h_acf0ee72c65911c54a418ccefba70ee77}{VirtualPageSize}};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00176}00176\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00177}00177\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00178}00178\ \ \ \ \ \textcolor{comment}{//\ Set\ the\ pointer.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00179}00179\ \ \ \ \ uint64\_t\ pfn\_region\_phys\ =\ pfnEntriesPhys\ -\/\ (neededPages\ *\ \mbox{\hyperlink{mm_8h_acf0ee72c65911c54a418ccefba70ee77}{VirtualPageSize}});}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00180}00180\ \ \ \ \ \mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.PfnEntries\ =\ (\mbox{\hyperlink{mm_8h_add4af0c873a7e9aa078742eac12b1879}{PPFN\_ENTRY}})(uintptr\_t)(pfn\_region\_phys\ +\ \mbox{\hyperlink{mm_8h_aa1cd9b3c456e6501f130ba4f13636192}{PhysicalMemoryOffset}});}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00181}00181\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00182}00182\ \ \ \ \ \textcolor{comment}{//\ Zero\ the\ region.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00183}00183\ \ \ \ \ \mbox{\hyperlink{mm_8h_a7d9455da4f2ec94a98286a19e7d8e39d}{kmemset}}(\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.PfnEntries,\ 0,\ neededPages\ *\ \mbox{\hyperlink{mm_8h_acf0ee72c65911c54a418ccefba70ee77}{VirtualPageSize}});}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00184}00184\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00185}00185\ \ \ \ \ \textcolor{comment}{//\ Initialize\ counts.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00186}00186\ \ \ \ \ \mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.TotalPageCount\ =\ totalPfnEntries;\ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00187}00187\ \ \ \ \ \mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.AvailablePages\ =\ 0;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00188}00188\ \ \ \ \ \mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.TotalReserved\ =\ 0;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00189}00189\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00190}00190\ \ \ \ \ \mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.FreePageList.Count\ =\ 0;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00191}00191\ \ \ \ \ \mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.BadPageList.Count\ =\ 0;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00192}00192\ \ \ \ \ \mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.StandbyPageList.Count\ =\ 0;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00193}00193\ \ \ \ \ \mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.ZeroedPageList.Count\ =\ 0;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00194}00194\ \ \ \ \ \mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.ModifiedPageList.Count\ =\ 0;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00195}00195\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00196}00196\ \ \ \ \ \textcolor{comment}{//\ Initialize\ locks}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00197}00197\ \ \ \ \ \mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.PfnDatabaseLock.locked\ =\ 0;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00198}00198\ \ \ \ \ \mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.BadPageList.PfnListLock.locked\ =\ 0;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00199}00199\ \ \ \ \ \mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.StandbyPageList.PfnListLock.locked\ =\ 0;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00200}00200\ \ \ \ \ \mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.ZeroedPageList.PfnListLock.locked\ =\ 0;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00201}00201\ \ \ \ \ \mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.FreePageList.PfnListLock.locked\ =\ 0;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00202}00202\ \ \ \ \ \mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.ModifiedPageList.PfnListLock.locked\ =\ 0;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00203}00203\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00204}00204\ \ \ \ \ \textcolor{comment}{//\ Reserve\ the\ PFN\ Array\ in\ the\ PFN\ List.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00205}00205\ \ \ \ \ MiReservePhysRange(pfn\_region\_phys,\ neededPages\ *\ \mbox{\hyperlink{mm_8h_acf0ee72c65911c54a418ccefba70ee77}{VirtualPageSize}});}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00206}00206\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00207}00207\ \ \ \ \ \textcolor{comment}{//\ We\ can\ interact\ with\ the\ entries,\ begin\ filling\ the\ PFN\ DB.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00208}00208\ \ \ \ \ \mbox{\hyperlink{mm_8h_a7ce93fd02781ab3e20db6b11d7e28395}{PAGE\_INDEX}}\ lastPfnIdx\ =\ 0;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00209}00209\ \ \ \ \ desc\ =\ BootInfo-\/>MemoryMap;\ \textcolor{comment}{//\ reset\ desc\ to\ original\ pointer}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00210}00210\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ entryCount;\ i++)\ \{}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00211}00211\ \ \ \ \ \ \ \ \ uint64\_t\ regionStart\ =\ desc-\/>\mbox{\hyperlink{struct___e_f_i___m_e_m_o_r_y___d_e_s_c_r_i_p_t_o_r_ad31a686b44d9fa70840b0f625434e291}{PhysicalStart}};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00212}00212\ \ \ \ \ \ \ \ \ uint64\_t\ regionPages\ =\ desc-\/>\mbox{\hyperlink{struct___e_f_i___m_e_m_o_r_y___d_e_s_c_r_i_p_t_o_r_a84530c369b622a5f3899052267fa18fe}{NumberOfPages}};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00213}00213\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00214}00214\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ For\ each\ 4KiB\ page\ in\ the\ physical\ region\ of\ pages}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00215}00215\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (uint64\_t\ p\ =\ 0;\ p\ <\ regionPages;\ p++)\ \{}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00216}00216\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ The\ physical\ address\ is\ calculated\ by\ taking\ the\ (regionStart\ (physical\ address\ of\ region\ base)\ plus\ the\ current\ increment)\ times\ the\ frame\ size.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00217}00217\ \ \ \ \ \ \ \ \ \ \ \ \ uint64\_t\ physAddr\ =\ regionStart\ +\ p\ *\ \mbox{\hyperlink{mm_8h_a0b0f623858c974a2dc2a4361d59341c2}{PhysicalFrameSize}};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00218}00218\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00219}00219\ \ \ \ \ \ \ \ \ \ \ \ \ uint64\_t\ currentPfnIndex\ =\ (physAddr\ /\ \mbox{\hyperlink{mm_8h_a0b0f623858c974a2dc2a4361d59341c2}{PhysicalFrameSize}});}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00220}00220\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00221}00221\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ UEFI\ Memory\ maps\ arent\ sorted\ in\ order,\ we\ could\ get\ address\ 0x100000\ at\ one\ iteration,\ and\ address\ 0x2000\ at\ the\ next\ iteration.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00222}00222\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We\ guard\ it\ with\ a\ simple\ if\ statement.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00223}00223\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (currentPfnIndex\ >\ lastPfnIdx)\ \{}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00224}00224\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ lastPfnIdx\ =\ currentPfnIndex;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00225}00225\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00226}00226\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00227}00227\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (currentPfnIndex\ >=\ \mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.TotalPageCount)\ \{}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00228}00228\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ out\ of\ range\ physical\ address,\ we\ skip.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00229}00229\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00230}00230\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00231}00231\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00232}00232\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{mm_8h_add4af0c873a7e9aa078742eac12b1879}{PPFN\_ENTRY}}\ entry\ =\ \&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.PfnEntries[currentPfnIndex];}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00233}00233\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00234}00234\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ If\ this\ page\ is\ inside\ the\ PFN-\/array\ region\ we\ just\ reserved,\ skip\ adding\ it\ to\ db.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00235}00235\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (desc-\/>\mbox{\hyperlink{struct___e_f_i___m_e_m_o_r_y___d_e_s_c_r_i_p_t_o_r_a140acdd7ac30628e97d1851104f05c03}{Type}}\ ==\ \mbox{\hyperlink{efi_8h_af095fe56818f3bd8a310206b8777bb1c}{EfiConventionalMemory}})\ \{}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00236}00236\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (physAddr\ >=\ pfn\_region\_phys\ \&\&\ physAddr\ <\ pfn\_region\_phys\ +\ neededPages\ *\ \mbox{\hyperlink{mm_8h_acf0ee72c65911c54a418ccefba70ee77}{VirtualPageSize}})\ \{}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00237}00237\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};\ \textcolor{comment}{//\ Do\ not\ touch\ this\ entry,\ it\ was\ set\ by\ MiReservePhysRange}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00238}00238\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00239}00239\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00240}00240\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00241}00241\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Initialize\ the\ PFN\ Entry.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00242}00242\ \ \ \ \ \ \ \ \ \ \ \ \ entry-\/>\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_a279682d710d9c634f4a7121f1474c17c}{RefCount}}\ =\ 0;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00243}00243\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00244}00244\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{switch}\ (desc-\/>\mbox{\hyperlink{struct___e_f_i___m_e_m_o_r_y___d_e_s_c_r_i_p_t_o_r_a140acdd7ac30628e97d1851104f05c03}{Type}})\ \{}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00245}00245\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ \mbox{\hyperlink{efi_8h_af095fe56818f3bd8a310206b8777bb1c}{EfiConventionalMemory}}:}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00246}00246\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ entry-\/>\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_a9ac4c1f881137da2601ed5d333bb5989}{State}}\ =\ \mbox{\hyperlink{mm_8h_a12462d873d8d81a717b5a7622091e998a234f13589416e616e0a90ee46052ea6d}{PfnStateFree}};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00247}00247\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ entry-\/>\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_aeb3f0fed7dd127f81565f62281a7ae41}{Flags}}\ =\ \mbox{\hyperlink{mm_8h_ade48055747533779e94bcf44ff15e345a2083092a472202565e584dea988f0264}{PFN\_FLAG\_NONE}};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00248}00248\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00249}00249\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Add\ to\ free\ list.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00250}00250\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{ms_8h_abc60fab3d33ed1b1c9f11d1ed674a7b3}{InsertTailList}}(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.FreePageList.ListEntry,\ \&entry-\/>\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_a118ffbb89a3a201c17eae8d00f9e70d7}{Descriptor}}.\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_adc1221f2a2b3fa268f8699acb6fd220e}{ListEntry}});}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00251}00251\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Increment\ the\ free\ page\ list\ count.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00252}00252\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{atomic_8h_a417663fb902a228350d64b7ad5e9d6cb}{InterlockedIncrementU64}}(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.FreePageList.Count);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00253}00253\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{atomic_8h_a417663fb902a228350d64b7ad5e9d6cb}{InterlockedIncrementU64}}(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.AvailablePages);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00254}00254\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00255}00255\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ \mbox{\hyperlink{efi_8h_a4f64535d5504ac8f2ebf923f6d0ced08}{EfiBootServicesCode}}:}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00256}00256\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ \mbox{\hyperlink{efi_8h_aa4fa5f19b00f75592a5d1a5335409e28}{EfiBootServicesData}}:}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00257}00257\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ \mbox{\hyperlink{efi_8h_a90aae2e90363a29ad96d432a5f7f72dc}{EfiLoaderCode}}:}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00258}00258\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ \mbox{\hyperlink{efi_8h_a63d4f335cccc52962bc247c9001f0170}{EfiLoaderData}}:}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00259}00259\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ \mbox{\hyperlink{efi_8h_af3cee49f9ec781299b538a17e9e02ff8}{EfiRuntimeServicesCode}}:}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00260}00260\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ \mbox{\hyperlink{efi_8h_a1f301de8ab02b899d7144cd4d2157789}{EfiRuntimeServicesData}}:}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00261}00261\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ \mbox{\hyperlink{efi_8h_af4e9f34f6444eef713f1e6239642490d}{EfiReservedMemoryType}}:}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00262}00262\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ \mbox{\hyperlink{efi_8h_a719f76dff215b3b6e8ed43a558ad59fc}{EfiACPIMemoryNVS}}:}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00263}00263\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Mark\ pages\ used\ by\ firmware,\ loader,\ or\ kernel\ as\ active.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00264}00264\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ these\ will\ not\ be\ returned\ by\ the\ page\ allocator.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00265}00265\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ entry-\/>\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_a9ac4c1f881137da2601ed5d333bb5989}{State}}\ =\ \mbox{\hyperlink{mm_8h_a12462d873d8d81a717b5a7622091e998a68c66f57633f47bedf7267c068ad1fc9}{PfnStateActive}};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00266}00266\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ entry-\/>\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_aeb3f0fed7dd127f81565f62281a7ae41}{Flags}}\ =\ \mbox{\hyperlink{mm_8h_ade48055747533779e94bcf44ff15e345a2083092a472202565e584dea988f0264}{PFN\_FLAG\_NONE}};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00267}00267\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ entry-\/>\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_a118ffbb89a3a201c17eae8d00f9e70d7}{Descriptor}}.\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_a968216918d5ebf946c497a66564f1223}{Mapping}}.\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_aaf1a5e1a132630fb917e3fc578d379cb}{PteAddress}}\ =\ NULL;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00268}00268\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ entry-\/>\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_a118ffbb89a3a201c17eae8d00f9e70d7}{Descriptor}}.\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_a968216918d5ebf946c497a66564f1223}{Mapping}}.\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_adb8c0f630bc7f4792c1489a7e8897e5b}{Vad}}\ =\ NULL;\ \textcolor{comment}{//\ No\ VAD\ for\ these.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00269}00269\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ entry-\/>\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_a279682d710d9c634f4a7121f1474c17c}{RefCount}}\ =\ 1;\ \textcolor{comment}{//\ Set\ reference\ count\ to\ 1,\ so\ allocator\ will\ not\ get\ confused.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00270}00270\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{atomic_8h_a417663fb902a228350d64b7ad5e9d6cb}{InterlockedIncrementU64}}(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.TotalReserved);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00271}00271\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00272}00272\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//case\ EfiACPIReclaimMemory\ TODO\ RECLAIMABLE.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00273}00273\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00274}00274\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ If\ its\ not\ conventional\ memory,\ or\ one\ of\ the\ runtime/loader/boot/reserved,\ it\ is\ bad\ memory.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00275}00275\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ entry-\/>\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_a9ac4c1f881137da2601ed5d333bb5989}{State}}\ =\ \mbox{\hyperlink{mm_8h_a12462d873d8d81a717b5a7622091e998af40deb1ae533bd460652991e9b7bc8be}{PfnStateBad}};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00276}00276\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ entry-\/>\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_aeb3f0fed7dd127f81565f62281a7ae41}{Flags}}\ =\ \mbox{\hyperlink{mm_8h_ade48055747533779e94bcf44ff15e345a2083092a472202565e584dea988f0264}{PFN\_FLAG\_NONE}};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00277}00277\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00278}00278\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Add\ to\ free\ list\ and\ increment\ count.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00279}00279\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{ms_8h_abc60fab3d33ed1b1c9f11d1ed674a7b3}{InsertTailList}}(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.BadPageList.ListEntry,\ \&entry-\/>\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_a118ffbb89a3a201c17eae8d00f9e70d7}{Descriptor}}.\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_adc1221f2a2b3fa268f8699acb6fd220e}{ListEntry}});}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00280}00280\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{atomic_8h_a417663fb902a228350d64b7ad5e9d6cb}{InterlockedIncrementU64}}(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.BadPageList.Count);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00281}00281\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00282}00282\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00283}00283\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00284}00284\ \ \ \ \ \ \ \ \ desc\ =\ (\mbox{\hyperlink{efi_8h_aef521078a6a7d9bacb81e5cd18cf37b9}{PEFI\_MEMORY\_DESCRIPTOR}})((uint8\_t*)desc\ +\ BootInfo-\/>DescriptorSize);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00285}00285\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00286}00286\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00287}00287\ \ \ \ \ \textcolor{comment}{//\ Set\ the\ global\ state\ as\ initialized.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00288}00288\ \ \ \ \ \mbox{\hyperlink{pfn_8c_a751b1ff6046212e402e3ac873016e7ff}{MmPfnDatabaseInitialized}}\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00289}00289\ \ \ \ \ \mbox{\hyperlink{pfn_8c_a22803a09c3713dda1ef6f7ee637874dc}{MmHighestPfn}}\ =\ lastPfnIdx;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00290}00290\ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{mtstatus_8h_a147849337a41d8be9ccb4ef599b84a86}{MT\_SUCCESS}};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00291}00291\ \}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00292}00292\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00293}00293\ \textcolor{keyword}{static}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00294}00294\ \mbox{\hyperlink{mm_8h_add4af0c873a7e9aa078742eac12b1879}{PPFN\_ENTRY}}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00295}00295\ MiReleaseAnyPage(}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00296}00296\ \ \ \ \ \mbox{\hyperlink{annotations_8h_ac2bbd6d630a06a980d9a92ddb9a49928}{IN}}\ \mbox{\hyperlink{core_8h_a5ab6087d9cf9b1c2356140128e66b95f}{PDOUBLY\_LINKED\_LIST}}\ ListEntry}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00297}00297\ )}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00298}00298\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00299}00299\ \textcolor{comment}{/*++}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00300}00300\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00301}00301\ \textcolor{comment}{\ \ \ \ Routine\ description:}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00302}00302\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00303}00303\ \textcolor{comment}{\ \ \ \ \ \ \ \ Attempts\ to\ retrieve\ a\ PFN\ Entry\ from\ the\ ListEntry\ given.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00304}00304\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00305}00305\ \textcolor{comment}{\ \ \ \ Arguments:}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00306}00306\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00307}00307\ \textcolor{comment}{\ \ \ \ \ \ \ \ [IN]\ \ \ \ Pointer\ to\ ListEntry\ of\ PFN\_LIST.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00308}00308\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00309}00309\ \textcolor{comment}{\ \ \ \ Return\ Values:}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00310}00310\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00311}00311\ \textcolor{comment}{\ \ \ \ \ \ \ \ Pointer\ of\ PFN\_ENTRY,\ NULL\ on\ failure.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00312}00312\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00313}00313\ \textcolor{comment}{-\/-\/*/}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00314}00314\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00315}00315\ \{}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00316}00316\ \ \ \ \ \mbox{\hyperlink{core_8h_a5ab6087d9cf9b1c2356140128e66b95f}{PDOUBLY\_LINKED\_LIST}}\ pListEntry\ =\ \mbox{\hyperlink{ms_8h_a27ee423d523647ea53fae6d0afdef066}{RemoveHeadList}}(ListEntry);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00317}00317\ \ \ \ \ \textcolor{keywordflow}{if}\ (!pListEntry)\ \textcolor{keywordflow}{return}\ NULL;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00318}00318\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00319}00319\ \ \ \ \ \textcolor{comment}{//\ Return\ the\ PFN\_ENTRY\ of\ this\ ListEntry.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00320}00320\ \ \ \ \ \mbox{\hyperlink{mm_8h_add4af0c873a7e9aa078742eac12b1879}{PPFN\_ENTRY}}\ pPfnEntry\ =\ \mbox{\hyperlink{macros_8h_aad0775b806dea2a5529806f0e8d90cee}{CONTAINING\_RECORD}}(pListEntry,\ \mbox{\hyperlink{mm_8h_a6c0fa5674fb17649810840e7ca79bbf4}{PFN\_ENTRY}},\ Descriptor.ListEntry);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00321}00321\ \ \ \ \ \textcolor{keywordflow}{return}\ pPfnEntry;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00322}00322\ \}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00323}00323\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00324}00324\ \mbox{\hyperlink{mm_8h_a7ce93fd02781ab3e20db6b11d7e28395}{PAGE\_INDEX}}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00325}\mbox{\hyperlink{pfn_8c_a09e1bd69ed2aaa499051fddb5e1b94ff}{00325}}\ \mbox{\hyperlink{pfn_8c_a09e1bd69ed2aaa499051fddb5e1b94ff}{MiRequestPhysicalPage}}(}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00326}00326\ \ \ \ \ \mbox{\hyperlink{annotations_8h_ac2bbd6d630a06a980d9a92ddb9a49928}{IN}}\ \ \mbox{\hyperlink{mm_8h_a2af3dbc8dfc6350d4c18c46bf3c92d2a}{PFN\_STATE}}\ ListType}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00327}00327\ )}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00328}00328\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00329}00329\ \textcolor{comment}{/*++}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00330}00330\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00331}00331\ \textcolor{comment}{\ \ \ \ Routine\ description:}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00332}00332\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00333}00333\ \textcolor{comment}{\ \ \ \ \ \ \ \ Retrieves\ a\ physical\ page\ from\ the\ PFN\ Database.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00334}00334\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00335}00335\ \textcolor{comment}{\ \ \ \ Arguments:}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00336}00336\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00337}00337\ \textcolor{comment}{\ \ \ \ \ \ \ \ [IN]\ \ \ \ enum\ \_PFN\_STATE\ Type.\ (e.g\ PfnStateZeroed\ is\ guranteed\ to\ return\ a\ zeroed\ physical\ page)}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00338}00338\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00339}00339\ \textcolor{comment}{\ \ \ \ Return\ Values:}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00340}00340\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00341}00341\ \textcolor{comment}{\ \ \ \ \ \ \ \ PFN\ Index\ of\ the\ page,\ otherwise\ PFN\_ERROR\ on\ failure.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00342}00342\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00343}00343\ \textcolor{comment}{\ \ \ \ Notes:}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00344}00344\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00345}00345\ \textcolor{comment}{\ \ \ \ \ \ \ \ The\ PFN\ index\ given,\ does\ not\ return\ an\ actively\ mapped\ PFN\ (that\ is\ mapped\ to\ a\ VA),\ other\ functions\ must\ set\ its\ mapping.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00346}00346\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00347}00347\ \textcolor{comment}{-\/-\/*/}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00348}00348\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00349}00349\ \{\ \ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00350}00350\ \ \ \ \ \textcolor{comment}{//\ Declarations}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00351}00351\ \ \ \ \ \mbox{\hyperlink{core_8h_a7258ea91cea6c1c174df48f6225ef4da}{IRQL}}\ oldIrql;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00352}00352\ \ \ \ \ \mbox{\hyperlink{core_8h_a7258ea91cea6c1c174df48f6225ef4da}{IRQL}}\ DbIrql;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00353}00353\ \ \ \ \ \mbox{\hyperlink{mm_8h_add4af0c873a7e9aa078742eac12b1879}{PPFN\_ENTRY}}\ pfn\ =\ NULL;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00354}00354\ \ \ \ \ \mbox{\hyperlink{mm_8h_a2af3dbc8dfc6350d4c18c46bf3c92d2a}{PFN\_STATE}}\ oldState;\ \textcolor{comment}{//\ To\ know\ if\ we\ need\ to\ zero}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00355}00355\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00356}00356\ \ \ \ \ \textcolor{comment}{//\ Acquire\ global\ PFN\ DB\ lock.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00357}00357\ \ \ \ \ \mbox{\hyperlink{spinlock_8c_a1efc92e3aa7c8ab17da8a844bb9fd129}{MsAcquireSpinlock}}(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.PfnDatabaseLock,\ \&DbIrql);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00358}00358\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00359}00359\ \ \ \ \ \textcolor{comment}{//\ 1.\ Try\ ZeroedPageList}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00360}00360\ \ \ \ \ \mbox{\hyperlink{spinlock_8c_a1efc92e3aa7c8ab17da8a844bb9fd129}{MsAcquireSpinlock}}(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.ZeroedPageList.PfnListLock,\ \&oldIrql);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00361}00361\ \ \ \ \ pfn\ =\ MiReleaseAnyPage(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.ZeroedPageList.ListEntry);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00362}00362\ \ \ \ \ \mbox{\hyperlink{spinlock_8c_ac938b07a766c2e0f5c701f2264e46918}{MsReleaseSpinlock}}(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.ZeroedPageList.PfnListLock,\ oldIrql);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00363}00363\ \ \ \ \ \textcolor{keywordflow}{if}\ (pfn)\ \{}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00364}00364\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{atomic_8h_a7d3179efc4f0416b59ae569a96a33ba2}{InterlockedDecrementU64}}(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.ZeroedPageList.Count);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00365}00365\ \ \ \ \ \ \ \ \ oldState\ =\ \mbox{\hyperlink{mm_8h_a12462d873d8d81a717b5a7622091e998a26f8d58b053c67264f771e0e2dbdc38a}{PfnStateZeroed}};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00366}00366\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{goto}\ found;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00367}00367\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00368}00368\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00369}00369\ \ \ \ \ \textcolor{comment}{//\ 2.\ Try\ FreePageList}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00370}00370\ \ \ \ \ \mbox{\hyperlink{spinlock_8c_a1efc92e3aa7c8ab17da8a844bb9fd129}{MsAcquireSpinlock}}(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.FreePageList.PfnListLock,\ \&oldIrql);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00371}00371\ \ \ \ \ pfn\ =\ MiReleaseAnyPage(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.FreePageList.ListEntry);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00372}00372\ \ \ \ \ \mbox{\hyperlink{spinlock_8c_ac938b07a766c2e0f5c701f2264e46918}{MsReleaseSpinlock}}(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.FreePageList.PfnListLock,\ oldIrql);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00373}00373\ \ \ \ \ \textcolor{keywordflow}{if}\ (pfn)\ \{}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00374}00374\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{atomic_8h_a7d3179efc4f0416b59ae569a96a33ba2}{InterlockedDecrementU64}}(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.FreePageList.Count);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00375}00375\ \ \ \ \ \ \ \ \ oldState\ =\ \mbox{\hyperlink{mm_8h_a12462d873d8d81a717b5a7622091e998a234f13589416e616e0a90ee46052ea6d}{PfnStateFree}};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00376}00376\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{goto}\ found;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00377}00377\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00378}00378\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00379}00379\ \ \ \ \ \textcolor{comment}{//\ 3.\ Try\ StandbyPageList}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00380}00380\ \ \ \ \ \mbox{\hyperlink{spinlock_8c_a1efc92e3aa7c8ab17da8a844bb9fd129}{MsAcquireSpinlock}}(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.StandbyPageList.PfnListLock,\ \&oldIrql);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00381}00381\ \ \ \ \ pfn\ =\ MiReleaseAnyPage(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.StandbyPageList.ListEntry);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00382}00382\ \ \ \ \ \mbox{\hyperlink{spinlock_8c_ac938b07a766c2e0f5c701f2264e46918}{MsReleaseSpinlock}}(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.StandbyPageList.PfnListLock,\ oldIrql);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00383}00383\ \ \ \ \ \textcolor{keywordflow}{if}\ (pfn)\ \{}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00384}00384\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{atomic_8h_a7d3179efc4f0416b59ae569a96a33ba2}{InterlockedDecrementU64}}(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.StandbyPageList.Count);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00385}00385\ \ \ \ \ \ \ \ \ oldState\ =\ \mbox{\hyperlink{mm_8h_a12462d873d8d81a717b5a7622091e998ac7ce2dd9565e07f38302f67305b7e869}{PfnStateStandby}};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00386}00386\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{goto}\ found;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00387}00387\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00388}00388\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00389}00389\ \ \ \ \ \textcolor{comment}{//\ 4.\ All\ lists\ are\ empty}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00390}00390\ \ \ \ \ \textcolor{comment}{//\ TODO:\ Paging\ (flush\ modified\ list\ to\ disk,\ give\ a\ page\ from\ there.)}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00391}00391\ \ \ \ \ \textcolor{comment}{//\ Release\ Global\ Lock}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00392}00392\ \ \ \ \ \mbox{\hyperlink{spinlock_8c_ac938b07a766c2e0f5c701f2264e46918}{MsReleaseSpinlock}}(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.PfnDatabaseLock,\ DbIrql);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00393}00393\ \ \ \ \ \textcolor{keywordflow}{return}\ (uint64\_t)-\/1;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00394}00394\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00395}00395\ found:}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00396}00396\ \ \ \ \ \textcolor{comment}{//\ Claim\ while\ locked.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00397}00397\ \ \ \ \ \mbox{\hyperlink{assert_8h_a3d4ae9c092e117c836f52dc7d7cee574}{assert}}((pfn-\/>\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_a279682d710d9c634f4a7121f1474c17c}{RefCount}})\ ==\ 0);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00398}00398\ \ \ \ \ pfn-\/>\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_a9ac4c1f881137da2601ed5d333bb5989}{State}}\ =\ \mbox{\hyperlink{mm_8h_a12462d873d8d81a717b5a7622091e998a16c1fda3836f3c9b73b714d62f4dc311}{PfnStateTransition}};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00399}00399\ \ \ \ \ \textcolor{comment}{//\ Set\ final\ metadata:\ now\ "{}owned"{}\ by\ the\ caller.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00400}00400\ \ \ \ \ pfn-\/>\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_a279682d710d9c634f4a7121f1474c17c}{RefCount}}\ =\ 1;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00401}00401\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00402}00402\ \ \ \ \ \textcolor{comment}{//\ Release\ Global\ Lock}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00403}00403\ \ \ \ \ \mbox{\hyperlink{spinlock_8c_ac938b07a766c2e0f5c701f2264e46918}{MsReleaseSpinlock}}(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.PfnDatabaseLock,\ DbIrql);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00404}00404\ \ \ \ \ \textcolor{comment}{//\ Decrement\ total\ available\ pages}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00405}00405\ \ \ \ \ \mbox{\hyperlink{atomic_8h_a7d3179efc4f0416b59ae569a96a33ba2}{InterlockedDecrementU64}}(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.AvailablePages);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00406}00406\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00407}00407\ \ \ \ \ uint64\_t\ pfnIndex\ =\ \mbox{\hyperlink{mm_8h_a40c0393d26de8f7768b9f771decf9f1c}{PPFN\_TO\_INDEX}}(pfn);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00408}00408\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00409}00409\ \ \ \ \ \textcolor{comment}{//\ If\ caller\ wants\ a\ zeroed\ page,\ but\ we\ didn't\ get\ one,\ zero\ it\ now.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00410}00410\ \ \ \ \ \textcolor{keywordflow}{if}\ (ListType\ ==\ \mbox{\hyperlink{mm_8h_a12462d873d8d81a717b5a7622091e998a26f8d58b053c67264f771e0e2dbdc38a}{PfnStateZeroed}}\ \&\&\ oldState\ !=\ \mbox{\hyperlink{mm_8h_a12462d873d8d81a717b5a7622091e998a26f8d58b053c67264f771e0e2dbdc38a}{PfnStateZeroed}})\ \{}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00411}00411\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{core_8h_a7258ea91cea6c1c174df48f6225ef4da}{IRQL}}\ hyperIrql;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00412}00412\ \ \ \ \ \ \ \ \ uint8\_t*\ va\ =\ \mbox{\hyperlink{hypermap_8c_a9e3de9aacb781db1acf2815ec071f30e}{MiMapPageInHyperspace}}(pfnIndex,\ \&hyperIrql);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00413}00413\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{mm_8h_a7d9455da4f2ec94a98286a19e7d8e39d}{kmemset}}(va,\ 0,\ \mbox{\hyperlink{mm_8h_acf0ee72c65911c54a418ccefba70ee77}{VirtualPageSize}});}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00414}00414\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{hypermap_8c_ad57ae3b2e037c15c00dfe55b252e7fc8}{MiUnmapHyperSpaceMap}}(hyperIrql);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00415}00415\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00416}00416\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00417}00417\ \ \ \ \ \textcolor{keywordflow}{return}\ pfnIndex;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00418}00418\ \}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00419}00419\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00420}00420\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00421}\mbox{\hyperlink{pfn_8c_a5c45262799a0761469b19a5dd9810947}{00421}}\ \mbox{\hyperlink{pfn_8c_a5c45262799a0761469b19a5dd9810947}{MiReleasePhysicalPage}}(}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00422}00422\ \ \ \ \ \mbox{\hyperlink{annotations_8h_ac2bbd6d630a06a980d9a92ddb9a49928}{IN}}\ \ \mbox{\hyperlink{mm_8h_a7ce93fd02781ab3e20db6b11d7e28395}{PAGE\_INDEX}}\ PfnIndex}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00423}00423\ )}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00424}00424\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00425}00425\ \textcolor{comment}{/*++}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00426}00426\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00427}00427\ \textcolor{comment}{\ \ \ \ Routine\ description:}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00428}00428\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00429}00429\ \textcolor{comment}{\ \ \ \ \ \ \ \ Releases\ a\ physical\ page\ back\ to\ the\ memory\ manager}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00430}00430\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00431}00431\ \textcolor{comment}{\ \ \ \ Arguments:}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00432}00432\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00433}00433\ \textcolor{comment}{\ \ \ \ \ \ \ \ [IN]\ \ \ \ PAGE\_INDEX\ Index\ of\ the\ PFN\ given\ by\ MiRequestPhysicalPage}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00434}00434\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00435}00435\ \textcolor{comment}{\ \ \ \ Return\ Values:}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00436}00436\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00437}00437\ \textcolor{comment}{\ \ \ \ \ \ \ \ None.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00438}00438\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00439}00439\ \textcolor{comment}{-\/-\/*/}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00440}00440\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00441}00441\ \{}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00442}00442\ \ \ \ \ \textcolor{comment}{//\ First,\ access\ the\ PFN\ in\ the\ database\ to\ determine\ its\ staistics.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00443}00443\ \ \ \ \ \mbox{\hyperlink{mm_8h_add4af0c873a7e9aa078742eac12b1879}{PPFN\_ENTRY}}\ pfn\ =\ \mbox{\hyperlink{mm_8h_ad9b99c6be796a28588cd102246ddba8c}{INDEX\_TO\_PPFN}}(PfnIndex);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00444}00444\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00445}00445\ \ \ \ \ \mbox{\hyperlink{assert_8h_a3d4ae9c092e117c836f52dc7d7cee574}{assert}}((pfn-\/>\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_a279682d710d9c634f4a7121f1474c17c}{RefCount}})\ >\ 0,\ \textcolor{stringliteral}{"{}Refcount\ is\ 0\ while\ releasing.\ Double\ Free"{}});}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00446}00446\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00447}00447\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{atomic_8h_a7d155446a14ecbfb5bd6e0abf7b6cb93}{InterlockedDecrementU32}}(\&pfn-\/>\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_a279682d710d9c634f4a7121f1474c17c}{RefCount}})\ ==\ 0)\ \{}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00448}00448\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ This\ is\ the\ last\ reference\ to\ the\ page,\ store\ it\ back\ in\ the\ list.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00449}00449\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (pfn-\/>\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_a9ac4c1f881137da2601ed5d333bb5989}{State}}\ ==\ \mbox{\hyperlink{mm_8h_a12462d873d8d81a717b5a7622091e998a68c66f57633f47bedf7267c068ad1fc9}{PfnStateActive}})\ \{}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00450}00450\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Clear\ mapping\ info.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00451}00451\ \ \ \ \ \ \ \ \ \ \ \ \ pfn-\/>\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_a118ffbb89a3a201c17eae8d00f9e70d7}{Descriptor}}.\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_a968216918d5ebf946c497a66564f1223}{Mapping}}.\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_adb8c0f630bc7f4792c1489a7e8897e5b}{Vad}}\ =\ NULL;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00452}00452\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (pfn-\/>\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_a118ffbb89a3a201c17eae8d00f9e70d7}{Descriptor}}.\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_a968216918d5ebf946c497a66564f1223}{Mapping}}.\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_aaf1a5e1a132630fb917e3fc578d379cb}{PteAddress}}\ !=\ NULL\ \&\&}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00453}00453\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pfn-\/>\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_a118ffbb89a3a201c17eae8d00f9e70d7}{Descriptor}}.\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_a968216918d5ebf946c497a66564f1223}{Mapping}}.\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_aaf1a5e1a132630fb917e3fc578d379cb}{PteAddress}}-\/>\mbox{\hyperlink{struct___m_m_p_t_e_a42f06b61b2dd8128f546b87e48632889}{Hard}}.\mbox{\hyperlink{struct___m_m_p_t_e_a7ef88f60d3f8a185fad0ee172f14d4e0}{Dirty}})\ \{}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00454}00454\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Dirty\ bit\ is\ set,\ we\ throw\ it\ back\ to\ the\ modified\ page\ list.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00455}00455\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{core_8h_a7258ea91cea6c1c174df48f6225ef4da}{IRQL}}\ oldIrql;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00456}00456\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pfn-\/>\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_a9ac4c1f881137da2601ed5d333bb5989}{State}}\ =\ \mbox{\hyperlink{mm_8h_a12462d873d8d81a717b5a7622091e998a55655d53b0a3ae5366fd5d815978e295}{PfnStateModified}};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00457}00457\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{spinlock_8c_a1efc92e3aa7c8ab17da8a844bb9fd129}{MsAcquireSpinlock}}(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.ModifiedPageList.PfnListLock,\ \&oldIrql);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00458}00458\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ TODO\ SET\ FILE\ OFFSET\ PAGING}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00459}00459\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{ms_8h_abc60fab3d33ed1b1c9f11d1ed674a7b3}{InsertTailList}}(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.ModifiedPageList.ListEntry,\ \&pfn-\/>\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_a118ffbb89a3a201c17eae8d00f9e70d7}{Descriptor}}.\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_adc1221f2a2b3fa268f8699acb6fd220e}{ListEntry}});}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00460}00460\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00461}00461\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Increment\ the\ counters}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00462}00462\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{atomic_8h_a417663fb902a228350d64b7ad5e9d6cb}{InterlockedIncrementU64}}(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.ModifiedPageList.Count);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00463}00463\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{atomic_8h_a417663fb902a228350d64b7ad5e9d6cb}{InterlockedIncrementU64}}(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.AvailablePages);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00464}00464\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00465}00465\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{spinlock_8c_ac938b07a766c2e0f5c701f2264e46918}{MsReleaseSpinlock}}(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.ModifiedPageList.PfnListLock,\ oldIrql);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00466}00466\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00467}00467\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00468}00468\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Dirty\ bit\ is\ not\ set,\ we\ throw\ it\ to\ the\ standby\ list.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00469}00469\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{core_8h_a7258ea91cea6c1c174df48f6225ef4da}{IRQL}}\ oldIrql;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00470}00470\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pfn-\/>\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_a9ac4c1f881137da2601ed5d333bb5989}{State}}\ =\ \mbox{\hyperlink{mm_8h_a12462d873d8d81a717b5a7622091e998ac7ce2dd9565e07f38302f67305b7e869}{PfnStateStandby}};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00471}00471\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{spinlock_8c_a1efc92e3aa7c8ab17da8a844bb9fd129}{MsAcquireSpinlock}}(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.StandbyPageList.PfnListLock,\ \&oldIrql);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00472}00472\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ TODO\ SET\ FILE\ OFFSET\ PAGING}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00473}00473\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{ms_8h_abc60fab3d33ed1b1c9f11d1ed674a7b3}{InsertTailList}}(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.StandbyPageList.ListEntry,\ \&pfn-\/>\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_a118ffbb89a3a201c17eae8d00f9e70d7}{Descriptor}}.\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_adc1221f2a2b3fa268f8699acb6fd220e}{ListEntry}});}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00474}00474\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00475}00475\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Increment\ the\ counters}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00476}00476\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{atomic_8h_a417663fb902a228350d64b7ad5e9d6cb}{InterlockedIncrementU64}}(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.StandbyPageList.Count);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00477}00477\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{atomic_8h_a417663fb902a228350d64b7ad5e9d6cb}{InterlockedIncrementU64}}(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.AvailablePages);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00478}00478\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00479}00479\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{spinlock_8c_ac938b07a766c2e0f5c701f2264e46918}{MsReleaseSpinlock}}(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.StandbyPageList.PfnListLock,\ oldIrql);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00480}00480\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00481}00481\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00482}00482\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00483}00483\ \}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00484}00484\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00485}00485\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00486}\mbox{\hyperlink{pfn_8c_a2c570a4f0e97fa11887df60d7a1b502d}{00486}}\ \mbox{\hyperlink{pfn_8c_a2c570a4f0e97fa11887df60d7a1b502d}{MiUnlinkPageFromList}}(}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00487}00487\ \ \ \ \ \mbox{\hyperlink{mm_8h_add4af0c873a7e9aa078742eac12b1879}{PPFN\_ENTRY}}\ pfn}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00488}00488\ )}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00489}00489\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00490}00490\ \textcolor{comment}{//\ Link\ a\ specified\ PPFN\_ENTRY\ from\ its\ PfnDb\ list.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00491}00491\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00492}00492\ \{}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00493}00493\ \ \ \ \ \mbox{\hyperlink{core_8h_a7258ea91cea6c1c174df48f6225ef4da}{IRQL}}\ oldIrql;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00494}00494\ \ \ \ \ \mbox{\hyperlink{ms_8h_adf17fb77fea5ef3f703733414efda5c4}{SPINLOCK}}*\ lock\ =\ NULL;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00495}00495\ \ \ \ \ \textcolor{keyword}{volatile}\ uint64\_t*\ count\ =\ NULL;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00496}00496\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00497}00497\ \ \ \ \ \textcolor{comment}{/*\ Determine\ which\ list\ this\ PFN\ is\ on\ and\ pick\ the\ corresponding\ lock/count\ */}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00498}00498\ \ \ \ \ \textcolor{keywordflow}{switch}\ (pfn-\/>\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_a9ac4c1f881137da2601ed5d333bb5989}{State}})\ \{}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00499}00499\ \ \ \ \ \textcolor{keywordflow}{case}\ \mbox{\hyperlink{mm_8h_a12462d873d8d81a717b5a7622091e998a234f13589416e616e0a90ee46052ea6d}{PfnStateFree}}:}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00500}00500\ \ \ \ \ \ \ \ \ lock\ =\ \&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.FreePageList.PfnListLock;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00501}00501\ \ \ \ \ \ \ \ \ count\ =\ \&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.FreePageList.Count;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00502}00502\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00503}00503\ \ \ \ \ \textcolor{keywordflow}{case}\ \mbox{\hyperlink{mm_8h_a12462d873d8d81a717b5a7622091e998a26f8d58b053c67264f771e0e2dbdc38a}{PfnStateZeroed}}:}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00504}00504\ \ \ \ \ \ \ \ \ lock\ =\ \&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.ZeroedPageList.PfnListLock;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00505}00505\ \ \ \ \ \ \ \ \ count\ =\ \&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.ZeroedPageList.Count;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00506}00506\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00507}00507\ \ \ \ \ \textcolor{keywordflow}{case}\ \mbox{\hyperlink{mm_8h_a12462d873d8d81a717b5a7622091e998ac7ce2dd9565e07f38302f67305b7e869}{PfnStateStandby}}:}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00508}00508\ \ \ \ \ \ \ \ \ lock\ =\ \&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.StandbyPageList.PfnListLock;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00509}00509\ \ \ \ \ \ \ \ \ count\ =\ \&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.StandbyPageList.Count;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00510}00510\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00511}00511\ \ \ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00512}00512\ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ Active/Modified/Bad\ pages\ are\ handled\ elsewhere\ */}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00513}00513\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00514}00514\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00515}00515\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00516}00516\ \ \ \ \ \mbox{\hyperlink{spinlock_8c_a1efc92e3aa7c8ab17da8a844bb9fd129}{MsAcquireSpinlock}}(lock,\ \&oldIrql);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00517}00517\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00518}00518\ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00519}00519\ \textcolor{comment}{\ \ \ \ \ *\ Guard:\ if\ the\ entry\ isn't\ linked\ (both\ pointers\ NULL)\ then\ nothing\ to\ do.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00520}00520\ \textcolor{comment}{\ \ \ \ \ *\ This\ avoids\ calling\ RemoveEntryList\ on\ an\ unlinked\ node.}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00521}00521\ \textcolor{comment}{\ \ \ \ \ */}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00522}00522\ \ \ \ \ \textcolor{keywordflow}{if}\ (pfn-\/>\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_a118ffbb89a3a201c17eae8d00f9e70d7}{Descriptor}}.\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_adc1221f2a2b3fa268f8699acb6fd220e}{ListEntry}}.\mbox{\hyperlink{struct___d_o_u_b_l_y___l_i_n_k_e_d___l_i_s_t_ad730634dba2dfcaef8cb8880cb1e4719}{Flink}}\ ==\ NULL\ \&\&}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00523}00523\ \ \ \ \ \ \ \ \ pfn-\/>\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_a118ffbb89a3a201c17eae8d00f9e70d7}{Descriptor}}.\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_adc1221f2a2b3fa268f8699acb6fd220e}{ListEntry}}.\mbox{\hyperlink{struct___d_o_u_b_l_y___l_i_n_k_e_d___l_i_s_t_a0d08a6f276c5a25d9a16ae91a699d8b3}{Blink}}\ ==\ NULL)\ \{}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00524}00524\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{spinlock_8c_ac938b07a766c2e0f5c701f2264e46918}{MsReleaseSpinlock}}(lock,\ oldIrql);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00525}00525\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00526}00526\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00527}00527\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00528}00528\ \ \ \ \ \textcolor{comment}{/*\ Remove\ this\ node\ from\ whatever\ list\ it\ currently\ sits\ on.\ */}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00529}00529\ \ \ \ \ \mbox{\hyperlink{ms_8h_aebca627613f330873979f93e89dff9d1}{RemoveEntryList}}(\&pfn-\/>\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_a118ffbb89a3a201c17eae8d00f9e70d7}{Descriptor}}.\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_adc1221f2a2b3fa268f8699acb6fd220e}{ListEntry}});}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00530}00530\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00531}00531\ \ \ \ \ \textcolor{comment}{/*\ Clear\ the\ entry's\ links\ to\ mark\ it\ as\ unlinked\ (like\ RemoveHeadList\ does).\ */}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00532}00532\ \ \ \ \ pfn-\/>\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_a118ffbb89a3a201c17eae8d00f9e70d7}{Descriptor}}.\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_adc1221f2a2b3fa268f8699acb6fd220e}{ListEntry}}.\mbox{\hyperlink{struct___d_o_u_b_l_y___l_i_n_k_e_d___l_i_s_t_ad730634dba2dfcaef8cb8880cb1e4719}{Flink}}\ =\ pfn-\/>\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_a118ffbb89a3a201c17eae8d00f9e70d7}{Descriptor}}.\mbox{\hyperlink{struct___p_f_n___e_n_t_r_y_adc1221f2a2b3fa268f8699acb6fd220e}{ListEntry}}.\mbox{\hyperlink{struct___d_o_u_b_l_y___l_i_n_k_e_d___l_i_s_t_a0d08a6f276c5a25d9a16ae91a699d8b3}{Blink}}\ =\ NULL;}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00533}00533\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00534}00534\ \ \ \ \ \textcolor{comment}{/*\ Update\ list\ and\ global\ counts\ while\ holding\ the\ lock.\ */}}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00535}00535\ \ \ \ \ \mbox{\hyperlink{atomic_8h_a7d3179efc4f0416b59ae569a96a33ba2}{InterlockedDecrementU64}}(count);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00536}00536\ \ \ \ \ \mbox{\hyperlink{atomic_8h_a7d3179efc4f0416b59ae569a96a33ba2}{InterlockedDecrementU64}}(\&\mbox{\hyperlink{pfn_8c_a838d2043c92e3267897ecdf7abe262f6}{PfnDatabase}}.AvailablePages);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00537}00537\ }
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00538}00538\ \ \ \ \ \mbox{\hyperlink{spinlock_8c_ac938b07a766c2e0f5c701f2264e46918}{MsReleaseSpinlock}}(lock,\ oldIrql);}
\DoxyCodeLine{\Hypertarget{pfn_8c_source_l00539}00539\ \}}

\end{DoxyCode}

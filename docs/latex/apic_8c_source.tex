\doxysection{apic.\+c}
\hypertarget{apic_8c_source}{}\label{apic_8c_source}\index{C:/Users/matanel/Desktop/Projects/KernelDevelopment/kernel/cpu/apic/apic.c@{C:/Users/matanel/Desktop/Projects/KernelDevelopment/kernel/cpu/apic/apic.c}}
\mbox{\hyperlink{apic_8c}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00001}00001\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{apic_8h}{apic.h}}"{}}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00002}00002\ \textcolor{preprocessor}{\#include\ <stddef.h>}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00003}00003\ \textcolor{preprocessor}{\#include\ <stdint.h>}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00004}00004\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{paging_8h}{../../memory/paging/paging.h}}"{}}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00005}00005\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{allocator_8h}{../../memory/allocator/allocator.h}}"{}}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00006}00006\ }
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00007}\mbox{\hyperlink{apic_8c_a3dac42d568d070ca6f076841c4ef835a}{00007}}\ \textcolor{preprocessor}{\#define\ IA32\_APIC\_BASE\_MSR\ \ \ \ \ 0x1BULL}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00008}\mbox{\hyperlink{apic_8c_a97ed6667474648ccd51bf4a254781506}{00008}}\ \textcolor{preprocessor}{\#define\ APIC\_BASE\_RESERVED\ \ \ \ \ 0xFFF0000000000000ULL}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00009}00009\ }
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00010}\mbox{\hyperlink{apic_8c_a5252dd02afc2f4aa041843fd7ff0f2b6}{00010}}\ \textcolor{preprocessor}{\#define\ LAPIC\_PAGE\_SIZE\ \ \ \ 0x1000}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00011}\mbox{\hyperlink{apic_8c_a3d3809d68e350df64c5c6f863209febe}{00011}}\ \textcolor{preprocessor}{\#define\ LAPIC\_MAP\_FLAGS\ (PAGE\_PRESENT\ |\ PAGE\_RW\ |\ PAGE\_PCD)}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00012}00012\ }
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00013}00013\ \textcolor{comment}{//\ LAPIC\ register\ offsets\ (32-\/bit\ registers)}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00014}00014\ \textcolor{keyword}{enum}\ \{}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00015}\mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0a34b471789f5a5cfe6864bc236ba6f19f}{00015}}\ \ \ \ \ \mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0a34b471789f5a5cfe6864bc236ba6f19f}{LAPIC\_ID}}\ =\ 0x020,}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00016}\mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0ac5f5e483d9265145a380bda5d682927c}{00016}}\ \ \ \ \ \mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0ac5f5e483d9265145a380bda5d682927c}{LAPIC\_VERSION}}\ =\ 0x030,}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00017}\mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0abd2de1774d190821d877777d3f3edc0c}{00017}}\ \ \ \ \ \mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0abd2de1774d190821d877777d3f3edc0c}{LAPIC\_TPR}}\ =\ 0x080,}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00018}\mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0ae1a36b5553b46ac8fe10c198d6b5a340}{00018}}\ \ \ \ \ \mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0ae1a36b5553b46ac8fe10c198d6b5a340}{LAPIC\_EOI}}\ =\ 0x0B0,}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00019}\mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0a1d4914ef1e2fbf9345397c7daddd3298}{00019}}\ \ \ \ \ \mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0a1d4914ef1e2fbf9345397c7daddd3298}{LAPIC\_SVR}}\ =\ 0x0F0,}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00020}\mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0ab2aec9812d250e0d5b8faa1b0af773d9}{00020}}\ \ \ \ \ \mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0ab2aec9812d250e0d5b8faa1b0af773d9}{LAPIC\_ESR}}\ =\ 0x280,}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00021}\mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0ab1da7f704c2bc5e9c718fed2847310e6}{00021}}\ \ \ \ \ \mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0ab1da7f704c2bc5e9c718fed2847310e6}{LAPIC\_ICR\_LOW}}\ =\ 0x300,}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00022}\mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0a93629ad0dae3ee3834231520db31e445}{00022}}\ \ \ \ \ \mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0a93629ad0dae3ee3834231520db31e445}{LAPIC\_ICR\_HIGH}}\ =\ 0x310,}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00023}\mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0ad5042d4497f75075276c20da844ad609}{00023}}\ \ \ \ \ \mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0ad5042d4497f75075276c20da844ad609}{LAPIC\_LVT\_TIMER}}\ =\ 0x320,}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00024}\mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0a2d27c760cddc8cf55e4a980190ccf3d7}{00024}}\ \ \ \ \ \mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0a2d27c760cddc8cf55e4a980190ccf3d7}{LAPIC\_LVT\_THERMAL}}\ =\ 0x330,}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00025}\mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0a4b66a3adc5d580ee3ee1304edd109586}{00025}}\ \ \ \ \ \mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0a4b66a3adc5d580ee3ee1304edd109586}{LAPIC\_LVT\_PCC}}\ =\ 0x340,}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00026}\mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0a422e75e0295550ccf559d1a1ec094c3e}{00026}}\ \ \ \ \ \mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0a422e75e0295550ccf559d1a1ec094c3e}{LAPIC\_LVT\_LINT0}}\ =\ 0x350,}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00027}\mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0a0f304d96b389e3afd828c8f298b4c0aa}{00027}}\ \ \ \ \ \mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0a0f304d96b389e3afd828c8f298b4c0aa}{LAPIC\_LVT\_LINT1}}\ =\ 0x360,}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00028}\mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0adc55a4c44a20a991bf529314f0988dab}{00028}}\ \ \ \ \ \mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0adc55a4c44a20a991bf529314f0988dab}{LAPIC\_LVT\_ERROR}}\ =\ 0x370,}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00029}\mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0a9d40e01ad0976934bc8a1a167e636dd9}{00029}}\ \ \ \ \ \mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0a9d40e01ad0976934bc8a1a167e636dd9}{LAPIC\_TIMER\_INITCNT}}\ =\ 0x380,}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00030}\mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0aab49de53e0071f39721cca0fd83c2bfd}{00030}}\ \ \ \ \ \mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0aab49de53e0071f39721cca0fd83c2bfd}{LAPIC\_TIMER\_CURRCNT}}\ =\ 0x390,}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00031}\mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0ae563d6c7f8ca78e0c6c01e7409afb261}{00031}}\ \ \ \ \ \mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0ae563d6c7f8ca78e0c6c01e7409afb261}{LAPIC\_TIMER\_DIV}}\ =\ 0x3E0}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00032}00032\ \};}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00033}00033\ }
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00034}00034\ }
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00035}\mbox{\hyperlink{apic_8c_aba23777f0905ffa6cf4f963471f835cc}{00035}}\ \textcolor{preprocessor}{\#define\ LAPIC\_DEFAULT\_PADDR\ \ \ \ 0xFEE00000ULL}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00036}00036\ \textcolor{keyword}{static}\ \textcolor{keyword}{volatile}\ uint32\_t*\ lapic\ =\ NULL;}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00037}00037\ \textcolor{keyword}{static}\ uint64\_t\ lapic\_phys\ =\ \mbox{\hyperlink{apic_8c_aba23777f0905ffa6cf4f963471f835cc}{LAPIC\_DEFAULT\_PADDR}};}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00038}00038\ }
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00039}00039\ \textcolor{comment}{//\ -\/-\/-\/\ low-\/level\ mmio\ helpers\ (assumes\ lapic\ mapped\ to\ virtual\ memory)\ -\/-\/-\/}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00040}00040\ \textcolor{keyword}{static}\ \textcolor{keyword}{inline}\ uint32\_t\ lapic\_mmio\_read(uint32\_t\ off)\ \{}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00041}00041\ \ \ \ \ \textcolor{keywordflow}{return}\ lapic[off\ /\ 4];}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00042}00042\ \}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00043}00043\ \textcolor{keyword}{static}\ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{void}\ lapic\_mmio\_write(uint32\_t\ off,\ uint32\_t\ val)\ \{}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00044}00044\ \ \ \ \ tracelast\_func(\textcolor{stringliteral}{"{}lapic\_mmio\_write"{}});}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00045}00045\ \ \ \ \ lapic[off\ /\ 4]\ =\ val;}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00046}00046\ \ \ \ \ (void)lapic\_mmio\_read(\mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0a34b471789f5a5cfe6864bc236ba6f19f}{LAPIC\_ID}});\ \textcolor{comment}{//\ serializing\ read\ to\ ensure\ write\ completes}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00047}00047\ \}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00048}00048\ }
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00049}00049\ \textcolor{comment}{//\ Wait\ for\ ICR\ delivery\ to\ complete\ (ICR\ low:\ bit\ 12\ =\ Delivery\ Status)}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00050}00050\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ lapic\_wait\_icr(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00051}00051\ \ \ \ \ \textcolor{keywordflow}{while}\ (lapic\_mmio\_read(\mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0ab1da7f704c2bc5e9c718fed2847310e6}{LAPIC\_ICR\_LOW}})\ \&\ (1\ <<\ 12))\ \{}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00052}00052\ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ spin\ */}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00053}00053\ \ \ \ \ \ \ \ \ \_\_pause();}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00054}00054\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00055}00055\ \}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00056}00056\ }
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00057}\mbox{\hyperlink{apic_8c_af8c78380c1086feeb42ec83c578b96ad}{00057}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{apic_8c_af8c78380c1086feeb42ec83c578b96ad}{lapic\_write}}(uint32\_t\ reg,\ uint32\_t\ value)\ \{}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00058}00058\ \ \ \ \ *((\textcolor{keyword}{volatile}\ uint32\_t*)(lapic\ +\ reg))\ =\ value;}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00059}00059\ \}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00060}00060\ }
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00061}00061\ \textcolor{comment}{//\ Initialize\ the\ Spurious\ Interrupt\ Vector}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00062}\mbox{\hyperlink{apic_8c_aab69c05c5c2af8abdde2bf3ff76a8327}{00062}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{apic_8c_aab69c05c5c2af8abdde2bf3ff76a8327}{lapic\_init\_siv}}()\ \{}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00063}00063\ \ \ \ \ uint32\_t\ svr\ =\ *((\textcolor{keyword}{volatile}\ uint32\_t*)(lapic\ +\ \mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0a1d4914ef1e2fbf9345397c7daddd3298}{LAPIC\_SVR}}));}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00064}00064\ \ \ \ \ uint32\_t\ vector\ =\ 0xFF;\ \textcolor{comment}{//\ IDT\ Entry}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00065}00065\ \ \ \ \ svr\ =\ (svr\ \&\ 0xFFFFFF00)\ |\ vector;\ \textcolor{comment}{//\ preserve\ enable\ bit,\ update\ vector}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00066}00066\ \ \ \ \ \mbox{\hyperlink{apic_8c_af8c78380c1086feeb42ec83c578b96ad}{lapic\_write}}(\mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0a1d4914ef1e2fbf9345397c7daddd3298}{LAPIC\_SVR}},\ svr);}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00067}00067\ \}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00068}00068\ }
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00069}00069\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ map\_lapic(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00070}00070\ \ \ \ \ \textcolor{keywordflow}{if}\ (lapic)\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00071}00071\ \ \ \ \ tracelast\_func(\textcolor{stringliteral}{"{}map\_lapic"{}});}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00072}00072\ }
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00073}00073\ \ \ \ \ \textcolor{keywordtype}{void}*\ virt\ =\ (\textcolor{keywordtype}{void}*)(lapic\_phys\ +\ \mbox{\hyperlink{allocator_8h_aa884a3bb19dee79e8e3ca8a529726372}{PHYS\_MEM\_OFFSET}});}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00074}00074\ }
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00075}00075\ \ \ \ \ \textcolor{comment}{//\ Map\ the\ single\ LAPIC\ page\ (phys\ -\/>\ virt)}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00076}00076\ \ \ \ \ \mbox{\hyperlink{paging_8c_a8a5e657a727356ab419f20fa707576d5}{map\_page}}(virt,\ lapic\_phys,\ \mbox{\hyperlink{paging_8h_aa3546a49e097b0054378f9ab4fe86aacac5ccf22183fd81d4268d6eb4f3bad604}{PAGE\_PRESENT}}\ |\ \mbox{\hyperlink{paging_8h_aa3546a49e097b0054378f9ab4fe86aaca0e92aa1b5476d7f05fbdf6fe3acfeed6}{PAGE\_RW}}\ |\ \mbox{\hyperlink{paging_8h_aa3546a49e097b0054378f9ab4fe86aacad4e58e6408565ce662ebab863dc92f0f}{PAGE\_PCD}});}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00077}00077\ }
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00078}00078\ \ \ \ \ \textcolor{comment}{//\ store\ the\ mmio\ base\ pointer}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00079}00079\ \ \ \ \ lapic\ =\ (\textcolor{keyword}{volatile}\ uint32\_t*)virt;}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00080}00080\ \}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00081}00081\ }
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00082}00082\ }
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00083}00083\ \textcolor{comment}{//\ Enable\ local\ APIC\ via\ IA32\_APIC\_BASE\ MSR\ and\ set\ SVR}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00084}\mbox{\hyperlink{apic_8c_ac7b59a78aea266f1c387e64bcae6cc51}{00084}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{apic_8c_ac7b59a78aea266f1c387e64bcae6cc51}{lapic\_enable}}(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00085}00085\ \ \ \ \ tracelast\_func(\textcolor{stringliteral}{"{}lapic\_enable"{}});}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00086}00086\ \ \ \ \ uint64\_t\ apic\_msr\ =\ \_\_readmsr(\mbox{\hyperlink{apic_8c_a3dac42d568d070ca6f076841c4ef835a}{IA32\_APIC\_BASE\_MSR}});}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00087}00087\ \ \ \ \ \textcolor{keywordflow}{if}\ (!(apic\_msr\ \&\ (1ULL\ <<\ 11)))\ \{}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00088}00088\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ set\ APIC\ global\ enable}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00089}00089\ \ \ \ \ \ \ \ \ apic\_msr\ |=\ (1ULL\ <<\ 11);}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00090}00090\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ optionally\ set\ a\ custom\ base\ in\ apic\_msr\ bits\ [35:12]\ if\ not\ default}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00091}00091\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ wrmsr(IA32\_APIC\_BASE\_MSR,\ apic\_msr);}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00092}00092\ \ \ \ \ \ \ \ \ \_\_writemsr(\mbox{\hyperlink{apic_8c_a3dac42d568d070ca6f076841c4ef835a}{IA32\_APIC\_BASE\_MSR}},\ apic\_msr);}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00093}00093\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00094}00094\ \ \ \ \ map\_lapic();}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00095}00095\ }
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00096}00096\ \ \ \ \ \textcolor{comment}{//\ Set\ Spurious\ Vector\ Register\ and\ enable\ (bit\ 8\ =\ APIC\ enable)}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00097}00097\ \ \ \ \ \textcolor{comment}{//\ choose\ an\ interrupt\ vector\ for\ spurious\ (e.g.,\ 0xFF).\ Keep\ vector\ values\ consistent\ with\ your\ IDT.}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00098}00098\ \ \ \ \ uint32\_t\ svr\ =\ (0xFF)\ |\ (1\ <<\ 8);}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00099}00099\ \ \ \ \ lapic\_mmio\_write(\mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0a1d4914ef1e2fbf9345397c7daddd3298}{LAPIC\_SVR}},\ svr);}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00100}00100\ \}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00101}00101\ }
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00102}00102\ \textcolor{comment}{//\ Initialize\ BSP's\ LAPIC\ (call\ early\ from\ kernel\ init\ on\ BSP)}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00103}\mbox{\hyperlink{apic_8c_aec4be6fe8565dd53ee1f2b6567d7d3e3}{00103}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{apic_8c_aec4be6fe8565dd53ee1f2b6567d7d3e3}{lapic\_init\_bsp}}(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00104}00104\ \ \ \ \ tracelast\_func(\textcolor{stringliteral}{"{}lapic\_init\_bsp"{}});}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00105}00105\ \ \ \ \ uint64\_t\ apic\_msr\ =\ \_\_readmsr(\mbox{\hyperlink{apic_8c_a3dac42d568d070ca6f076841c4ef835a}{IA32\_APIC\_BASE\_MSR}});}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00106}00106\ \ \ \ \ uint64\_t\ base\ =\ (apic\_msr\ \&\ 0xFFFFF000ULL);}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00107}00107\ \ \ \ \ \textcolor{keywordflow}{if}\ (base)\ lapic\_phys\ =\ base;}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00108}00108\ \ \ \ \ map\_lapic();}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00109}00109\ }
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00110}00110\ \ \ \ \ \mbox{\hyperlink{apic_8c_ac7b59a78aea266f1c387e64bcae6cc51}{lapic\_enable}}();}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00111}00111\ }
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00112}00112\ \ \ \ \ \textcolor{comment}{//\ mask\ LINT0/LINT1\ as\ appropriate,\ clear\ error\ status,\ etc.}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00113}00113\ \ \ \ \ lapic\_mmio\_write(\mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0a422e75e0295550ccf559d1a1ec094c3e}{LAPIC\_LVT\_LINT0}},\ (1U\ <<\ 16));\ \textcolor{comment}{//\ mask}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00114}00114\ \ \ \ \ lapic\_mmio\_write(\mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0a0f304d96b389e3afd828c8f298b4c0aa}{LAPIC\_LVT\_LINT1}},\ (1U\ <<\ 16));\ \textcolor{comment}{//\ mask}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00115}00115\ \ \ \ \ lapic\_mmio\_write(\mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0adc55a4c44a20a991bf529314f0988dab}{LAPIC\_LVT\_ERROR}},\ (1U\ <<\ 16));\ \textcolor{comment}{//\ mask\ (until\ handler\ in\ place)}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00116}00116\ \ \ \ \ lapic\_mmio\_write(\mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0ae1a36b5553b46ac8fe10c198d6b5a340}{LAPIC\_EOI}},\ 0);}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00117}00117\ \}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00118}00118\ }
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00119}00119\ \textcolor{comment}{//\ send\ IPI\ to\ APIC\ id}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00120}\mbox{\hyperlink{apic_8c_a54f251fa242c134d1db5108b5a564b42}{00120}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{apic_8c_a54f251fa242c134d1db5108b5a564b42}{lapic\_send\_ipi}}(uint8\_t\ apic\_id,\ uint8\_t\ vector,\ uint32\_t\ flags)\ \{}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00121}00121\ \ \ \ \ uint32\_t\ high\ =\ ((uint32\_t)apic\_id)\ <<\ 24;}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00122}00122\ \ \ \ \ lapic\_mmio\_write(\mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0a93629ad0dae3ee3834231520db31e445}{LAPIC\_ICR\_HIGH}},\ high);}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00123}00123\ \ \ \ \ lapic\_mmio\_write(\mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0ab1da7f704c2bc5e9c718fed2847310e6}{LAPIC\_ICR\_LOW}},\ (uint32\_t)vector\ |\ flags);}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00124}00124\ \ \ \ \ lapic\_wait\_icr();}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00125}00125\ \}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00126}00126\ }
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00127}\mbox{\hyperlink{apic_8c_a5c673232a19d0c4e78792208eb62f0cc}{00127}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{apic_8c_a5c673232a19d0c4e78792208eb62f0cc}{lapic\_eoi}}(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00128}00128\ \ \ \ \ lapic\_mmio\_write(\mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0ae1a36b5553b46ac8fe10c198d6b5a340}{LAPIC\_EOI}},\ 0);}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00129}00129\ \}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00130}00130\ }
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00131}00131\ \textcolor{comment}{//\ -\/-\/-\/\ Timer\ calibration\ and\ init\ -\/-\/-\/}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00132}00132\ \textcolor{comment}{//\ NOTE:\ the\ APIC\ timer\ is\ a\ downward\ counter.\ Strategy:}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00133}00133\ \textcolor{comment}{//\ \ 1.\ Set\ divide\ to\ known\ divisor.}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00134}00134\ \textcolor{comment}{//\ \ 2.\ Write\ initcount\ =\ 0xFFFFFFFF.}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00135}00135\ \textcolor{comment}{//\ \ 3.\ Wait\ EXACTLY\ 100\ ms\ via\ PIT/HPET.}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00136}00136\ \textcolor{comment}{//\ \ 4.\ curr\ =\ read\ current\ count\ -\/>\ ticks\_in\_100ms\ =\ start\ -\/\ curr}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00137}00137\ \textcolor{comment}{//\ \ 5.\ ticks\_per\_period(10ms)\ =\ ticks\_in\_100ms\ /\ 10}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00138}00138\ \textcolor{comment}{//\ \ 6.\ Program\ LVT\ timer\ to\ periodic\ and\ initial\ count\ =\ ticks\_per\_period}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00139}00139\ \textcolor{comment}{//}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00140}\mbox{\hyperlink{apic_8c_afbe5c3c5e249b35d3230d29faa253475}{00140}}\ \textcolor{preprocessor}{\#define\ APIC\_LVT\_TIMER\_PERIODIC\ (1U\ <<\ 17)}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00141}\mbox{\hyperlink{apic_8c_a15ed1a5c29d526e3faa1e649df0040ab}{00141}}\ \textcolor{preprocessor}{\#define\ APIC\_TIMER\_MASKED\ \ \ \ \ \ \ \ (1U\ <<\ 16)}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00142}00142\ }
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00143}00143\ \textcolor{keyword}{static}\ uint32\_t\ calibrate\_lapic\_ticks\_per\_10ms(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00144}00144\ \ \ \ \ \textcolor{comment}{//\ choose\ divide\ config:\ here\ set\ encode\ 0x3\ (divide\ by\ 16).\ Adjust\ if\ needed.}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00145}00145\ \ \ \ \ lapic\_mmio\_write(\mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0ae563d6c7f8ca78e0c6c01e7409afb261}{LAPIC\_TIMER\_DIV}},\ 0x3);}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00146}00146\ }
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00147}00147\ \ \ \ \ \textcolor{keyword}{const}\ uint32\_t\ start\ =\ 0xFFFFFFFFU;}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00148}00148\ \ \ \ \ lapic\_mmio\_write(\mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0a9d40e01ad0976934bc8a1a167e636dd9}{LAPIC\_TIMER\_INITCNT}},\ start);}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00149}00149\ }
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00150}00150\ \ \ \ \ \mbox{\hyperlink{pit_8c_a9ce3663b57d1010d886159f6ba120e37}{pit\_sleep\_ms}}(100);}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00151}00151\ }
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00152}00152\ \ \ \ \ uint32\_t\ curr\ =\ lapic\_mmio\_read(\mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0aab49de53e0071f39721cca0fd83c2bfd}{LAPIC\_TIMER\_CURRCNT}});}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00153}00153\ \ \ \ \ uint32\_t\ ticks\ =\ start\ -\/\ curr;}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00154}00154\ \ \ \ \ \textcolor{keywordflow}{if}\ (ticks\ ==\ 0)\ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00155}00155\ \ \ \ \ \textcolor{keywordflow}{return}\ ticks\ /\ 10;\ \textcolor{comment}{//\ ticks\ per\ 10ms\ -\/>\ for\ 100Hz\ (10ms\ period)}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00156}00156\ \}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00157}00157\ }
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00158}\mbox{\hyperlink{apic_8c_a1e4c2eac6f54346ca8dd087e24ff420c}{00158}}\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{apic_8c_a1e4c2eac6f54346ca8dd087e24ff420c}{init\_lapic\_timer}}(uint32\_t\ hz)\ \{}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00159}00159\ \ \ \ \ \textcolor{keywordflow}{if}\ (hz\ ==\ 0)\ \textcolor{keywordflow}{return}\ -\/1;}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00160}00160\ \ \ \ \ map\_lapic();}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00161}00161\ }
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00162}00162\ \ \ \ \ \textcolor{comment}{//\ calibrate\ using\ 100ms\ window}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00163}00163\ \ \ \ \ uint32\_t\ ticks\_per\_10ms\ =\ calibrate\_lapic\_ticks\_per\_10ms();}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00164}00164\ \ \ \ \ \textcolor{keywordflow}{if}\ (ticks\_per\_10ms\ ==\ 0)\ \textcolor{keywordflow}{return}\ -\/2;}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00165}00165\ }
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00166}00166\ \ \ \ \ \textcolor{comment}{//\ compute\ target\ initial\ count}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00167}00167\ \ \ \ \ \textcolor{comment}{//\ desired\_period\_ms\ =\ 1000\ /\ hz}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00168}00168\ \ \ \ \ uint32\_t\ period\_ms\ =\ 1000\ /\ hz;}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00169}00169\ \ \ \ \ \textcolor{comment}{//\ ticks\_per\_10ms:\ ticks\ per\ 10ms,\ so\ ticks\_per\_ms\ =\ ticks\_per\_10ms\ /\ 10}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00170}00170\ \ \ \ \ \textcolor{comment}{//\ initial\_count\ =\ ticks\_per\_ms\ *\ period\_ms\ =\ ticks\_per\_10ms\ *\ period\_ms\ /\ 10}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00171}00171\ \ \ \ \ uint64\_t\ initial\ =\ ((uint64\_t)ticks\_per\_10ms\ *\ (uint64\_t)period\_ms)\ /\ 10ULL;}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00172}00172\ \ \ \ \ \textcolor{keywordflow}{if}\ (initial\ ==\ 0)\ initial\ =\ 1;}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00173}00173\ }
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00174}00174\ \ \ \ \ \textcolor{comment}{//\ mask\ the\ timer\ while\ programming}}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00175}00175\ \ \ \ \ lapic\_mmio\_write(\mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0ad5042d4497f75075276c20da844ad609}{LAPIC\_LVT\_TIMER}},\ \mbox{\hyperlink{apic_8c_afbe5c3c5e249b35d3230d29faa253475}{APIC\_LVT\_TIMER\_PERIODIC}}\ |\ 0xEF\ \textcolor{comment}{/*\ IDT\ vector\ 0xEF\ */});}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00176}00176\ \ \ \ \ lapic\_mmio\_write(\mbox{\hyperlink{apic_8c_a2209504e1f764d3d247635b442f628b0a9d40e01ad0976934bc8a1a167e636dd9}{LAPIC\_TIMER\_INITCNT}},\ (uint32\_t)initial);}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00177}00177\ \ \ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{\Hypertarget{apic_8c_source_l00178}00178\ \}}

\end{DoxyCode}

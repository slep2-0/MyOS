\doxysection{attach.\+c}
\hypertarget{attach_8c_source}{}\label{attach_8c_source}\index{C:/Users/matanel/Desktop/Projects/KernelDevelopment/kernel/core/me/attach.c@{C:/Users/matanel/Desktop/Projects/KernelDevelopment/kernel/core/me/attach.c}}
\mbox{\hyperlink{attach_8c}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00001}00001\ \textcolor{comment}{/*++}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00002}00002\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00003}00003\ \textcolor{comment}{Module\ Name:}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00004}00004\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00005}00005\ \textcolor{comment}{\ \ \ \ attach.c}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00006}00006\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00007}00007\ \textcolor{comment}{Purpose:}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00008}00008\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00009}00009\ \textcolor{comment}{\ \ \ \ This\ module\ contains\ the\ implementation\ of\ process\ attaching.}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00010}00010\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00011}00011\ \textcolor{comment}{Author:}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00012}00012\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00013}00013\ \textcolor{comment}{\ \ \ \ slep\ (Matanel)\ 2025.}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00014}00014\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00015}00015\ \textcolor{comment}{Revision\ History:}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00016}00016\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00017}00017\ \textcolor{comment}{-\/-\/*/}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00018}00018\ }
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00019}00019\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{me_8h}{../../includes/me.h}}"{}}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00020}00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{ps_8h}{../../includes/ps.h}}"{}}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00021}00021\ }
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00022}00022\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00023}\mbox{\hyperlink{attach_8c_abe5e1d1426a0f223f346bd763781720d}{00023}}\ \mbox{\hyperlink{attach_8c_abe5e1d1426a0f223f346bd763781720d}{MeAttachProcess}}(}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00024}00024\ \ \ \ \ \mbox{\hyperlink{annotations_8h_ac2bbd6d630a06a980d9a92ddb9a49928}{IN}}\ \mbox{\hyperlink{core_8h_a3e9988613b48cfa96a902fc01b1cf7a0}{PIPROCESS}}\ Process,}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00025}00025\ \ \ \ \ \mbox{\hyperlink{annotations_8h_aec78e7a9e90a406a56f859ee456e8eae}{OUT}}\ \mbox{\hyperlink{me_8h_abb6b658421679a631cefc4fef040e3c6}{PAPC\_STATE}}\ ApcState}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00026}00026\ )}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00027}00027\ }
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00028}00028\ \textcolor{comment}{/*++}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00029}00029\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00030}00030\ \textcolor{comment}{\ \ \ \ Routine\ description:}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00031}00031\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00032}00032\ \textcolor{comment}{\ \ \ \ \ \ \ \ Attach\ to\ a\ process\ address\ space,\ this\ routine\ should\ be\ managed\ carefully,\ and\ have\ simple\ code\ between\ the\ attaching\ and\ detaching.}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00033}00033\ \textcolor{comment}{\ \ \ \ \ \ \ \ }}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00034}00034\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00035}00035\ \textcolor{comment}{\ \ \ \ Arguments:}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00036}00036\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00037}00037\ \textcolor{comment}{\ \ \ \ \ \ \ \ [IN]\ \ \ \ PIPROCESS\ Process\ -\/\ Pointer\ to\ process\ to\ attach\ to\ (IPROCESS)}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00038}00038\ \textcolor{comment}{\ \ \ \ \ \ \ \ [OUT]\ \ \ PAPC\_STATE\ -\/\ Pointer\ to\ store\ the\ state\ in\ resident\ memory.}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00039}00039\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00040}00040\ \textcolor{comment}{\ \ \ \ Return\ Values:}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00041}00041\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00042}00042\ \textcolor{comment}{\ \ \ \ \ \ \ \ None.}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00043}00043\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00044}00044\ \textcolor{comment}{\ \ \ \ Notes:}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00045}00045\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00046}00046\ \textcolor{comment}{\ \ \ \ \ \ \ \ DPCs\ CANNOT\ attach\ to\ a\ different\ process.}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00047}00047\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00048}00048\ \textcolor{comment}{-\/-\/*/}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00049}00049\ }
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00050}00050\ \{}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00051}00051\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{me_8h_a4ae0e23cb957119b31db2a358a009e9b}{MeIsExecutingDpc}}())\ \{}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00052}00052\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ CANNOT\ Attach\ to\ a\ process\ while\ executing\ a\ DPC.}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00053}00053\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{bugcheck_8c_a6ec4513aac495ad65f57eef09b218058}{MeBugCheckEx}}(}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00054}00054\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{me_8h_a3dd6c077b2422dcc0d05246537da5c82ae3d76490c57e3b222c3792456e5f323c}{INVALID\_PROCESS\_ATTACH\_ATTEMPT}},}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00055}00055\ \ \ \ \ \ \ \ \ \ \ \ \ (\textcolor{keywordtype}{void}*)Process,}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00056}00056\ \ \ \ \ \ \ \ \ \ \ \ \ (\textcolor{keywordtype}{void}*)(uintptr\_t)\mbox{\hyperlink{macros_8h_ac404dd901aac7a34d882f63dfdfd0095}{RETADDR}}(0),}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00057}00057\ \ \ \ \ \ \ \ \ \ \ \ \ (\textcolor{keywordtype}{void}*)\mbox{\hyperlink{me_8h_a4ae0e23cb957119b31db2a358a009e9b}{MeIsExecutingDpc}}(),}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00058}00058\ \ \ \ \ \ \ \ \ \ \ \ \ NULL}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00059}00059\ \ \ \ \ \ \ \ \ );}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00060}00060\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00061}00061\ }
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00062}00062\ \ \ \ \ \mbox{\hyperlink{core_8h_aa0a64d5bd95b62dc01f93f880483eed8}{PITHREAD}}\ CurrentThread\ =\ \mbox{\hyperlink{me_8h_a47d6bb330b3f195c125bd452af7031c8}{MeGetCurrentThread}}();}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00063}00063\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{macros_8h_ac6c45889010c1bd68631771b64f18101}{unlikely}}(!CurrentThread))\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00064}00064\ }
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00065}00065\ \ \ \ \ \textcolor{comment}{//\ Save\ the\ process\ we\ were\ running\ on.}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00066}00066\ \ \ \ \ ApcState-\/>SavedApcProcess\ =\ CurrentThread-\/>\mbox{\hyperlink{struct___i_t_h_r_e_a_d_ae9e70a267dbbee57a023a480da6d34a9}{ApcState}}.\mbox{\hyperlink{struct___a_p_c___s_t_a_t_e_aa6bf8b2333758277c1ad3222df0533be}{SavedApcProcess}};}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00067}00067\ \ \ \ \ ApcState-\/>SavedCr3\ =\ \mbox{\hyperlink{intrin_8h_af84468b325aa2ddc225df1b06b4a467b}{\_\_read\_cr3}}();}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00068}00068\ \ \ \ \ ApcState-\/>AttachedToProcess\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00069}00069\ }
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00070}00070\ \ \ \ \ \textcolor{comment}{//\ Raise\ to\ SYNCH\ and\ lock\ scheduler.}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00071}00071\ \ \ \ \ \textcolor{comment}{//\ TODO\ SYNCH}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00072}00072\ \ \ \ \ \mbox{\hyperlink{me_8h_ad4acf6d876082e32015b7e0538f1efaf}{MeAcquireSchedulerLock}}();}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00073}00073\ }
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00074}00074\ \ \ \ \ \textcolor{comment}{//\ Switch\ identity\ to\ new\ process.}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00075}00075\ \ \ \ \ CurrentThread-\/>\mbox{\hyperlink{struct___i_t_h_r_e_a_d_ae9e70a267dbbee57a023a480da6d34a9}{ApcState}}.\mbox{\hyperlink{struct___a_p_c___s_t_a_t_e_aa6bf8b2333758277c1ad3222df0533be}{SavedApcProcess}}\ =\ \mbox{\hyperlink{ps_8h_a5701abbbc2eab354fa851ea094d10283}{PsGetEProcessFromIProcess}}(Process);}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00076}00076\ \ \ \ \ CurrentThread-\/>\mbox{\hyperlink{struct___i_t_h_r_e_a_d_ae9e70a267dbbee57a023a480da6d34a9}{ApcState}}.\mbox{\hyperlink{struct___a_p_c___s_t_a_t_e_a867830641a99405e6236bd768bd2d83a}{AttachedToProcess}}\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00077}00077\ }
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00078}00078\ \ \ \ \ \textcolor{comment}{//\ Switch\ CR3s.}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00079}00079\ \ \ \ \ uint64\_t\ TargetCr3\ =\ Process-\/>PageDirectoryPhysical;}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00080}00080\ \ \ \ \ \textcolor{keywordflow}{if}\ (ApcState-\/>SavedCr3\ !=\ TargetCr3)\ \{}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00081}00081\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{intrin_8h_ac8ff7db1c624708409696db48e2378a8}{\_\_write\_cr3}}(TargetCr3);}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00082}00082\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00083}00083\ \}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00084}00084\ }
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00085}00085\ \textcolor{keywordtype}{void}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00086}\mbox{\hyperlink{attach_8c_a13b3e5dffb1e570758cc8f21b1ac22ad}{00086}}\ \mbox{\hyperlink{attach_8c_a13b3e5dffb1e570758cc8f21b1ac22ad}{MeDetachProcess}}(}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00087}00087\ \ \ \ \ \mbox{\hyperlink{annotations_8h_ac2bbd6d630a06a980d9a92ddb9a49928}{IN}}\ \mbox{\hyperlink{me_8h_abb6b658421679a631cefc4fef040e3c6}{PAPC\_STATE}}\ ApcState}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00088}00088\ )}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00089}00089\ }
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00090}00090\ \textcolor{comment}{/*++}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00091}00091\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00092}00092\ \textcolor{comment}{\ \ \ \ Routine\ description:}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00093}00093\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00094}00094\ \textcolor{comment}{\ \ \ \ \ \ \ \ Detach\ from\ a\ process\ address\ space.}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00095}00095\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00096}00096\ \textcolor{comment}{\ \ \ \ Arguments:}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00097}00097\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00098}00098\ \textcolor{comment}{\ \ \ \ \ \ \ \ [IN]\ \ \ \ PAPC\_STATE\ ApcState\ -\/\ The\ APC\_STATE\ stored\ by\ MeAttachProcess.}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00099}00099\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00100}00100\ \textcolor{comment}{\ \ \ \ Return\ Values:}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00101}00101\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00102}00102\ \textcolor{comment}{\ \ \ \ \ \ \ \ None.}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00103}00103\ \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00104}00104\ \textcolor{comment}{-\/-\/*/}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00105}00105\ }
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00106}00106\ \{}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00107}00107\ \ \ \ \ \mbox{\hyperlink{core_8h_aa0a64d5bd95b62dc01f93f880483eed8}{PITHREAD}}\ CurrentThread\ =\ \mbox{\hyperlink{me_8h_a47d6bb330b3f195c125bd452af7031c8}{MeGetCurrentThread}}();}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00108}00108\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{macros_8h_ac6c45889010c1bd68631771b64f18101}{unlikely}}(!CurrentThread))\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00109}00109\ \ \ \ \ \textcolor{keywordflow}{if}\ (!ApcState-\/>AttachedToProcess)\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00110}00110\ }
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00111}00111\ \ \ \ \ \textcolor{comment}{//\ Restore\ original\ CR3.}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00112}00112\ \ \ \ \ uint64\_t\ CurrentCr3\ =\ \mbox{\hyperlink{intrin_8h_af84468b325aa2ddc225df1b06b4a467b}{\_\_read\_cr3}}();}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00113}00113\ \ \ \ \ \textcolor{keywordflow}{if}\ (CurrentCr3\ !=\ ApcState-\/>SavedCr3)\ \{}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00114}00114\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{intrin_8h_ac8ff7db1c624708409696db48e2378a8}{\_\_write\_cr3}}(ApcState-\/>SavedCr3);}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00115}00115\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00116}00116\ }
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00117}00117\ \ \ \ \ \textcolor{comment}{//\ Restore\ thread's\ identity\ to\ original\ process.}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00118}00118\ \ \ \ \ CurrentThread-\/>\mbox{\hyperlink{struct___i_t_h_r_e_a_d_ae9e70a267dbbee57a023a480da6d34a9}{ApcState}}.\mbox{\hyperlink{struct___a_p_c___s_t_a_t_e_aa6bf8b2333758277c1ad3222df0533be}{SavedApcProcess}}\ =\ ApcState-\/>SavedApcProcess;}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00119}00119\ \ \ \ \ CurrentThread-\/>\mbox{\hyperlink{struct___i_t_h_r_e_a_d_ae9e70a267dbbee57a023a480da6d34a9}{ApcState}}.\mbox{\hyperlink{struct___a_p_c___s_t_a_t_e_a867830641a99405e6236bd768bd2d83a}{AttachedToProcess}}\ =\ ApcState-\/>AttachedToProcess;}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00120}00120\ }
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00121}00121\ \ \ \ \ \textcolor{comment}{//\ Restore\ scheduler\ lock\ /\ IRQL.}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00122}00122\ \ \ \ \ \textcolor{comment}{//\ TODO\ SYNCH\ LEVEL}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00123}00123\ \ \ \ \ \mbox{\hyperlink{me_8h_aa16ee5d986035f7fa834a7cca5168a73}{MeReleaseSchedulerLock}}();}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00124}00124\ }
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00125}00125\ \ \ \ \ \textcolor{comment}{//\ Clear\ attached\ state.}}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00126}00126\ \ \ \ \ ApcState-\/>AttachedToProcess\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{attach_8c_source_l00127}00127\ \}}

\end{DoxyCode}

\doxysection{kernel.\+c}
\hypertarget{kernel_8c_source}{}\label{kernel_8c_source}\index{C:/Users/matanel/Desktop/Projects/KernelDevelopment/kernel/kernel.c@{C:/Users/matanel/Desktop/Projects/KernelDevelopment/kernel/kernel.c}}
\mbox{\hyperlink{kernel_8c}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00001}00001\ \textcolor{comment}{/*}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00002}00002\ \textcolor{comment}{\ *\ PROJECT:\ \ \ \ \ \ MatanelOS\ Kernel}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00003}00003\ \textcolor{comment}{\ *\ LICENSE:\ \ \ \ \ \ GPLv3}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00004}00004\ \textcolor{comment}{\ *\ PURPOSE:\ \ \ \ \ \ Core\ Kernel\ Entry\ Point\ for\ MatanelOS.}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00005}00005\ \textcolor{comment}{\ */}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00006}00006\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00007}00007\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{kernel_8h}{kernel.h}}"{}}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00008}00008\ \textcolor{preprocessor}{\#ifndef\ \_MSC\_VER}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00009}00009\ \textcolor{keyword}{\_Static\_assert}(\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{void}*)\ ==\ 8,\ \textcolor{stringliteral}{"{}This\ Kernel\ is\ 64\ bit\ only!\ The\ 32bit\ version\ is\ deprecated."{}});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00010}00010\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00011}00011\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00012}\mbox{\hyperlink{kernel_8c_a9fed467298b3e70426485013c0caf964}{00012}}\ \textcolor{preprocessor}{\#define\ MAX\_AHCI\_CONTROLLERS\ 32}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00013}\mbox{\hyperlink{kernel_8c_a3764ef588283aaa224d9dd8d89a35c52}{00013}}\ uint64\_t\ \mbox{\hyperlink{kernel_8c_a3764ef588283aaa224d9dd8d89a35c52}{ahci\_bases\_local}}[\mbox{\hyperlink{kernel_8c_a9fed467298b3e70426485013c0caf964}{MAX\_AHCI\_CONTROLLERS}}];}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00014}00014\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00015}\mbox{\hyperlink{kernel_8c_ad8ca0be32b831aec9de80bcf0e22107e}{00015}}\ GOP\_PARAMS\ \mbox{\hyperlink{kernel_8c_ad8ca0be32b831aec9de80bcf0e22107e}{gop\_local}};}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00016}\mbox{\hyperlink{kernel_8c_a5f06053b8248ece91f68e4ae8da74ee4}{00016}}\ \mbox{\hyperlink{kernel_8h_aa7f93145770b2b55fa44fc8b9a2cf58d}{BOOT\_INFO}}\ \mbox{\hyperlink{kernel_8c_a5f06053b8248ece91f68e4ae8da74ee4}{boot\_info\_local}};}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00017}00017\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00018}00018\ \textcolor{comment}{//static\ MUTEX\ mutx;}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00019}00019\ \textcolor{comment}{//MUTEX*\ sharedMutex\ =\ \&mutx;}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00020}00020\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00021}00021\ \textcolor{comment}{/*}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00022}00022\ \textcolor{comment}{Global\ variables\ initialization}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00023}00023\ \textcolor{comment}{*/}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00024}\mbox{\hyperlink{kernel_8c_a3e4cb7a3337aa00fccafe03c7b5a59fc}{00024}}\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{kernel_8c_a3e4cb7a3337aa00fccafe03c7b5a59fc}{isBugChecking}}\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00025}\mbox{\hyperlink{kernel_8c_a84fdaa754c58bd3a02ef7e0c36cfff33}{00025}}\ \mbox{\hyperlink{struct_l_a_s_t_f_u_n_c___h_i_s_t_o_r_y}{LASTFUNC\_HISTORY}}\ \mbox{\hyperlink{kernel_8c_a84fdaa754c58bd3a02ef7e0c36cfff33}{lastfunc\_history}}\ =\ \{\ .current\_index\ =\ -\/1\ \};}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00026}\mbox{\hyperlink{kernel_8c_a0b2a3530e9a5998456be351b4251b878}{00026}}\ CPU\ \mbox{\hyperlink{kernel_8c_a0b2a3530e9a5998456be351b4251b878}{cpu}};}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00027}00027\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00028}00028\ \textcolor{comment}{/*}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00029}00029\ \textcolor{comment}{Ended}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00030}00030\ \textcolor{comment}{*/}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00031}\mbox{\hyperlink{kernel_8c_ad6664187bc75188329b950c21f5f380a}{00031}}\ \textcolor{preprocessor}{\#define\ MAX\_MEMORY\_MAP\_SIZE\ 0x4000\ \ }\textcolor{comment}{//\ 16\ KB,\ enough\ for\ \string~256\ descriptors}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00032}00032\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00033}00033\ \textcolor{keyword}{static}\ EFI\_MEMORY\_DESCRIPTOR\ memory\_map\_copy[\mbox{\hyperlink{kernel_8c_ad6664187bc75188329b950c21f5f380a}{MAX\_MEMORY\_MAP\_SIZE}}\ /\ \textcolor{keyword}{sizeof}(EFI\_MEMORY\_DESCRIPTOR)];}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00034}00034\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00035}\mbox{\hyperlink{kernel_8c_a26b7a33ce7ac27191c39745d6852acd1}{00035}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{kernel_8c_a26b7a33ce7ac27191c39745d6852acd1}{copy\_memory\_map}}(\mbox{\hyperlink{kernel_8h_aa7f93145770b2b55fa44fc8b9a2cf58d}{BOOT\_INFO}}*\ boot\_info)\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00036}00036\ \ \ \ \ \textcolor{keywordflow}{if}\ (!boot\_info\ ||\ !boot\_info-\/>MemoryMap)\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00037}00037\ \ \ \ \ \textcolor{keywordflow}{if}\ (boot\_info-\/>MapSize\ >\ \mbox{\hyperlink{kernel_8c_ad6664187bc75188329b950c21f5f380a}{MAX\_MEMORY\_MAP\_SIZE}})\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00038}00038\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ handle\ error,\ memory\ map\ too\ big}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00039}00039\ \ \ \ \ \ \ \ \ MtBugcheck(NULL,\ NULL,\ MEMORY\_MAP\_SIZE\_OVERRUN,\ 0,\ \textcolor{keyword}{false});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00040}00040\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00041}00041\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00042}00042\ \ \ \ \ \textcolor{comment}{//\ Copy\ the\ entire\ memory\ map\ into\ the\ static\ buffer}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00043}00043\ \ \ \ \ kmemcpy(memory\_map\_copy,\ boot\_info-\/>MemoryMap,\ boot\_info-\/>MapSize);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00044}00044\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00045}00045\ \ \ \ \ \mbox{\hyperlink{kernel_8c_a5f06053b8248ece91f68e4ae8da74ee4}{boot\_info\_local}}.MemoryMap\ =\ memory\_map\_copy;}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00046}00046\ \ \ \ \ \mbox{\hyperlink{kernel_8c_a5f06053b8248ece91f68e4ae8da74ee4}{boot\_info\_local}}.MapSize\ =\ boot\_info-\/>MapSize;}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00047}00047\ \ \ \ \ \mbox{\hyperlink{kernel_8c_a5f06053b8248ece91f68e4ae8da74ee4}{boot\_info\_local}}.DescriptorSize\ =\ boot\_info-\/>DescriptorSize;}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00048}00048\ \ \ \ \ \mbox{\hyperlink{kernel_8c_a5f06053b8248ece91f68e4ae8da74ee4}{boot\_info\_local}}.DescriptorVersion\ =\ boot\_info-\/>DescriptorVersion;}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00049}00049\ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00050}00050\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00051}\mbox{\hyperlink{kernel_8c_a8bf2519b1a607ce677d092c706b92f00}{00051}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{kernel_8c_a8bf2519b1a607ce677d092c706b92f00}{copy\_gop}}(\mbox{\hyperlink{kernel_8h_aa7f93145770b2b55fa44fc8b9a2cf58d}{BOOT\_INFO}}*\ boot\_info)\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00052}00052\ \ \ \ \ \textcolor{keywordflow}{if}\ (!boot\_info\ ||\ !boot\_info-\/>Gop)\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00053}00053\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00054}00054\ \ \ \ \ \textcolor{comment}{//\ Copy\ the\ GOP\ data\ to\ a\ local\ global\ variable}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00055}00055\ \ \ \ \ \mbox{\hyperlink{kernel_8c_ad8ca0be32b831aec9de80bcf0e22107e}{gop\_local}}\ =\ *(boot\_info-\/>Gop);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00056}00056\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00057}00057\ \ \ \ \ \textcolor{comment}{//\ Update\ all\ relevant\ pointers\ to\ point\ to\ the\ local\ copy}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00058}00058\ \ \ \ \ boot\_info-\/>Gop\ =\ \&\mbox{\hyperlink{kernel_8c_ad8ca0be32b831aec9de80bcf0e22107e}{gop\_local}};}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00059}00059\ \ \ \ \ \mbox{\hyperlink{kernel_8c_a5f06053b8248ece91f68e4ae8da74ee4}{boot\_info\_local}}.Gop\ =\ \&\mbox{\hyperlink{kernel_8c_ad8ca0be32b831aec9de80bcf0e22107e}{gop\_local}};}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00060}00060\ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00061}00061\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00062}00062\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00063}\mbox{\hyperlink{kernel_8c_a1aeed12b2d6dcc95b0e4457dab2e891c}{00063}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{kernel_8c_a1aeed12b2d6dcc95b0e4457dab2e891c}{init\_boot\_info}}(\mbox{\hyperlink{kernel_8h_aa7f93145770b2b55fa44fc8b9a2cf58d}{BOOT\_INFO}}*\ boot\_info)\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00064}00064\ \ \ \ \ \textcolor{keywordflow}{if}\ (!boot\_info)\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00065}00065\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00066}00066\ \ \ \ \ \mbox{\hyperlink{kernel_8c_a26b7a33ce7ac27191c39745d6852acd1}{copy\_memory\_map}}(boot\_info);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00067}00067\ \ \ \ \ \mbox{\hyperlink{kernel_8c_a8bf2519b1a607ce677d092c706b92f00}{copy\_gop}}(boot\_info);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00068}00068\ \ \ \ \ \textcolor{keywordflow}{if}\ (boot\_info-\/>AhciCount\ >\ \mbox{\hyperlink{kernel_8c_a9fed467298b3e70426485013c0caf964}{MAX\_AHCI\_CONTROLLERS}})\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00069}00069\ \ \ \ \ \ \ \ \ MtBugcheck(NULL,\ NULL,\ BAD\_AHCI\_COUNT,\ 0,\ \textcolor{keyword}{false});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00070}00070\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00071}00071\ \ \ \ \ \textcolor{keywordflow}{for}\ (uint32\_t\ i\ =\ 0;\ i\ <\ boot\_info-\/>AhciCount;\ i++)\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00072}00072\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{kernel_8c_a3764ef588283aaa224d9dd8d89a35c52}{ahci\_bases\_local}}[i]\ =\ boot\_info-\/>AhciBarBases[i];}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00073}00073\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00074}00074\ \ \ \ \ \mbox{\hyperlink{kernel_8c_a5f06053b8248ece91f68e4ae8da74ee4}{boot\_info\_local}}.AhciBarBases\ =\ \mbox{\hyperlink{kernel_8c_a3764ef588283aaa224d9dd8d89a35c52}{ahci\_bases\_local}};}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00075}00075\ \ \ \ \ \mbox{\hyperlink{kernel_8c_a5f06053b8248ece91f68e4ae8da74ee4}{boot\_info\_local}}.AhciCount\ =\ boot\_info-\/>AhciCount;}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00076}00076\ \ \ \ \ \mbox{\hyperlink{kernel_8c_a5f06053b8248ece91f68e4ae8da74ee4}{boot\_info\_local}}.KernelStackTop\ =\ boot\_info-\/>KernelStackTop;}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00077}00077\ \ \ \ \ \mbox{\hyperlink{kernel_8c_a5f06053b8248ece91f68e4ae8da74ee4}{boot\_info\_local}}.Pml4Phys\ =\ boot\_info-\/>Pml4Phys;}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00078}00078\ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00079}00079\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00080}00080\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ InitialiseControlRegisters(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00081}00081\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00082}00082\ \ \ \ \ \textcolor{comment}{/*\ CR0\ */}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00083}00083\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{long}\ cr0\ =\ \_\_read\_cr0();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00084}00084\ \ \ \ \ cr0\ |=\ (1UL\ <<\ 16);\ \textcolor{comment}{//\ Set\ bit\ 16\ (WRITE\ PROTECT),\ so\ when\ the\ kernel\ touches\ read\ only\ memory\ it\ would\ \#PF.}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00085}00085\ \textcolor{preprocessor}{\#ifdef\ DISABLE\_CACHE}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00086}00086\ \ \ \ \ cr0\ |=\ (1UL\ <<\ 30);\ \textcolor{comment}{//\ Set\ bit\ 30\ (CACHE\ DISABLE).}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00087}00087\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00088}00088\ \ \ \ \ \_\_write\_cr0(cr0);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00089}00089\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00090}00090\ \ \ \ \ \textcolor{comment}{/*\ CR4\ */}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00091}00091\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{long}\ cr4\ =\ \_\_read\_cr4();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00092}00092\ \ \ \ \ cr4\ |=\ (1UL\ <<\ 11);\ \textcolor{comment}{//\ Set\ bit\ 11\ -\/\ User\ Mode\ Instruction\ Prevention.\ This'll\ be\ useful\ against\ user\ mode\ attacks\ to\ locate\ IDT/GDT/LDT...}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00093}00093\ \ \ \ \ \_\_write\_cr4(cr4);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00094}00094\ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00095}00095\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00096}\mbox{\hyperlink{kernel_8c_a4aa078dcf96e9f06ce620519a93593c1}{00096}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{kernel_8c_a4aa078dcf96e9f06ce620519a93593c1}{InitCPU}}(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00097}00097\ \ \ \ \ \mbox{\hyperlink{kernel_8c_a0b2a3530e9a5998456be351b4251b878}{cpu}}.currentIrql\ =\ PASSIVE\_LEVEL;}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00098}00098\ \ \ \ \ \mbox{\hyperlink{kernel_8c_a0b2a3530e9a5998456be351b4251b878}{cpu}}.schedulerEnabled\ =\ NULL;\ \textcolor{comment}{//\ since\ NULL\ is\ 0,\ it\ would\ be\ false.}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00099}00099\ \ \ \ \ \mbox{\hyperlink{kernel_8c_a0b2a3530e9a5998456be351b4251b878}{cpu}}.currentThread\ =\ NULL;}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00100}00100\ \ \ \ \ \mbox{\hyperlink{kernel_8c_a0b2a3530e9a5998456be351b4251b878}{cpu}}.readyQueue.head\ =\ \mbox{\hyperlink{kernel_8c_a0b2a3530e9a5998456be351b4251b878}{cpu}}.readyQueue.tail\ =\ NULL;}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00101}00101\ \ \ \ \ \_\_writemsr(IA32\_KERNEL\_GS\_BASE,\ (uint64\_t)\ \&\ \mbox{\hyperlink{kernel_8c_a0b2a3530e9a5998456be351b4251b878}{cpu}});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00102}00102\ \ \ \ \ spinlock\_init(\&\mbox{\hyperlink{kernel_8c_a0b2a3530e9a5998456be351b4251b878}{cpu}}.readyQueue.lock);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00103}00103\ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00104}00104\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00105}00105\ \textcolor{keyword}{static}\ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{bool}\ interrupts\_enabled(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00106}00106\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{long}\ flags;}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00107}00107\ \ \ \ \ \_\_asm\_\_\ \_\_volatile\_\_(\textcolor{stringliteral}{"{}pushfq;\ popq\ \%0"{}}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00108}00108\ \ \ \ \ \ \ \ \ :\ \textcolor{stringliteral}{"{}=r"{}}(flags)}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00109}00109\ \ \ \ \ \ \ \ \ :}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00110}00110\ \ \ \ \ \ \ \ \ :\ \textcolor{stringliteral}{"{}memory"{}},\ \textcolor{stringliteral}{"{}cc"{}});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00111}00111\ \ \ \ \ \textcolor{keywordflow}{return}\ (flags\ \&\ (1UL\ <<\ 9))\ !=\ 0;\ \textcolor{comment}{//\ IF\ is\ bit\ 9}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00112}00112\ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00113}00113\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00114}\mbox{\hyperlink{kernel_8c_a9ce2606c20ea524922906d7816228c26}{00114}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{kernel_8c_a9ce2606c20ea524922906d7816228c26}{kernel\_idle\_checks}}(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00115}00115\ \ \ \ \ tracelast\_func(\textcolor{stringliteral}{"{}kernel\_idle\_checks\ -\/\ Thread"{}});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00116}00116\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{volatile}\ \textcolor{keywordtype}{bool}\ first\_time\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00117}00117\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00118}00118\ \ \ \ \ \textcolor{keywordflow}{if}\ (first\_time)\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00119}00119\ \ \ \ \ \ \ \ \ first\_time\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00120}00120\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{kernel_8h_a29f75e67ea1a76410256bf17f8226e05}{gop\_printf\_forced}}(0xFF000FF0,\ \textcolor{stringliteral}{"{}Reached\ the\ scheduler!\(\backslash\)n"{}});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00121}00121\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keyword}{volatile}\ uint64\_t\ i\ =\ 0;\ i\ <\ 100000000ULL;\ ++i)\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00122}00122\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ delay\ loop\ */}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00123}00123\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00124}00124\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00125}00125\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{kernel_8h_a29f75e67ea1a76410256bf17f8226e05}{gop\_printf\_forced}}(0xFF000FF0,\ \textcolor{stringliteral}{"{}**Ended\ Testing\ Thread\ Execution**\(\backslash\)n"{}});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00126}00126\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00127}00127\ \ \ \ \ \mbox{\hyperlink{assert_8h_a3d4ae9c092e117c836f52dc7d7cee574}{assert}}((interrupts\_enabled())\ ==\ \textcolor{keyword}{true},\ \textcolor{stringliteral}{"{}Interrupts\ are\ not\ enabled..."{}});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00128}00128\ \ \ \ \ \textcolor{keywordflow}{while}\ (1)\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00129}00129\ \ \ \ \ \ \ \ \ \_\_hlt();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00130}00130\ \ \ \ \ \ \ \ \ \textcolor{comment}{//Schedule();}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00131}00131\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00132}00132\ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00133}00133\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00134}00134\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ test(MUTEX*\ mut)\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00135}00135\ \ \ \ \ tracelast\_func(\textcolor{stringliteral}{"{}test\ -\/\ Thread"{}});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00136}00136\ \ \ \ \ Thread*\ currentThread\ =\ MtGetCurrentThread();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00137}00137\ \ \ \ \ \mbox{\hyperlink{kernel_8h_a29f75e67ea1a76410256bf17f8226e05}{gop\_printf\_forced}}(0xFF00FF00,\ \textcolor{stringliteral}{"{}Hit\ Test!\ test\ thread\ ptr:\ \%p\(\backslash\)n"{}},\ currentThread);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00138}00138\ \ \ \ \ gop\_printf(COLOR\_GREEN,\ \textcolor{stringliteral}{"{}(test)\ Acquiring\ Mutex\ Object:\ \%p\(\backslash\)n"{}},\ mut);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00139}00139\ \ \ \ \ \mbox{\hyperlink{mtstatus_8h_a7c794b38d203a5b842f27b12fb55495a}{MTSTATUS}}\ status\ =\ MtAcquireMutexObject(mut);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00140}00140\ \ \ \ \ gop\_printf(COLOR\_GREEN,\ \textcolor{stringliteral}{"{}(test)\ status\ returned:\ \%p\(\backslash\)n"{}},\ status);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00141}00141\ \ \ \ \ \textcolor{keyword}{volatile}\ uint64\_t\ z\ =\ 0;}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00142}00142\ \ \ \ \ \textcolor{keywordflow}{for}\ (uint64\_t\ i\ =\ 0;\ i\ <\ 0xFFFFFFF;\ i++)\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00143}00143\ \ \ \ \ \ \ \ \ z++;}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00144}00144\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00145}00145\ \ \ \ \ gop\_printf(COLOR\_GREEN,\ \textcolor{stringliteral}{"{}(test)\ Releasing\ Mutex\ Object:\ \%p\(\backslash\)n"{}},\ mut);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00146}00146\ \ \ \ \ MtReleaseMutexObject(mut);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00147}00147\ \ \ \ \ \mbox{\hyperlink{kernel_8h_a29f75e67ea1a76410256bf17f8226e05}{gop\_printf\_forced}}(0xFFA020F0,\ \textcolor{stringliteral}{"{}**Ended\ Test.**\(\backslash\)n"{}});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00148}00148\ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00149}00149\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00150}00150\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ funcWithParam(MUTEX*\ mut)\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00151}00151\ \ \ \ \ tracelast\_func(\textcolor{stringliteral}{"{}funcWithParam\ -\/\ Thread"{}});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00152}00152\ \ \ \ \ \textcolor{comment}{//gop\_printf\_forced(COLOR\_OLIVE,\ "{}Hit\ funcWithParam,\ Integer:\ \%d\(\backslash\)n"{},\ *integer);}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00153}00153\ \ \ \ \ gop\_printf(COLOR\_OLIVE,\ \textcolor{stringliteral}{"{}Hit\ funcWithParam\ -\/\ funcWithParam\ threadptr:\ \%p\(\backslash\)n"{}},\ MtGetCurrentThread());}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00154}00154\ \ \ \ \ \textcolor{keywordtype}{char}\ buf[256];}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00155}00155\ \ \ \ \ ksnprintf(buf,\ \textcolor{keyword}{sizeof}(buf),\ \textcolor{stringliteral}{"{}In\ funcwithParam!\ -\/\ thread\ ptr:\ \%p,\ mutex\ ptr:\ \%p"{}},\ MtGetCurrentThread(),\ mut);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00156}00156\ \ \ \ \ vfs\_write(\textcolor{stringliteral}{"{}/test.txt"{}},\ buf,\ kstrlen(buf),\ WRITE\_MODE\_CREATE\_OR\_REPLACE);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00157}00157\ \ \ \ \ gop\_printf(COLOR\_OLIVE,\ \textcolor{stringliteral}{"{}(funcWithParam)\ Acquiring\ Mutex\ Object:\ \%p\(\backslash\)n"{}},\ mut);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00158}00158\ \ \ \ \ MtAcquireMutexObject(mut);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00159}00159\ \ \ \ \ \textcolor{keyword}{volatile}\ uint64\_t\ z\ =\ 0;}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00160}00160\ \ \ \ \ \textcolor{keywordflow}{for}\ (uint64\_t\ i\ =\ 0;\ i\ <\ 0xFFFFFFF;\ i++)\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00161}00161\ \ \ \ \ \ \ \ \ z++;}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00162}00162\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00163}00163\ \ \ \ \ gop\_printf(COLOR\_OLIVE,\ \textcolor{stringliteral}{"{}(funcWithParam)\ Releasing\ Mutex\ Object:\ \%p\(\backslash\)n"{}},\ mut);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00164}00164\ \ \ \ \ MtReleaseMutexObject(mut);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00165}00165\ \ \ \ \ Thread*\ currentThread\ =\ MtGetCurrentThread();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00166}00166\ \ \ \ \ gop\_printf(COLOR\_OLIVE,\ \textcolor{stringliteral}{"{}Current\ thread\ in\ funcWithParam:\ \%p\(\backslash\)n"{}},\ currentThread);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00167}00167\ \ \ \ \ \mbox{\hyperlink{kernel_8h_a29f75e67ea1a76410256bf17f8226e05}{gop\_printf\_forced}}(COLOR\_OLIVE,\ \textcolor{stringliteral}{"{}**Ended\ funcWithParam.**\(\backslash\)n"{}});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00168}00168\ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00169}00169\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00171}\mbox{\hyperlink{kernel_8c_a290306ce314d46bd369c185b7b95db40}{00171}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{kernel_8c_a290306ce314d46bd369c185b7b95db40}{kernel\_main}}(\mbox{\hyperlink{kernel_8h_aa7f93145770b2b55fa44fc8b9a2cf58d}{BOOT\_INFO}}*\ boot\_info)\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00172}00172\ \ \ \ \ \textcolor{comment}{//tracelast\_func("{}kernel\_main"{});}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00173}00173\ \ \ \ \ \textcolor{comment}{//\ 1.\ CORE\ SYSTEM\ INITIALIZATION}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00174}00174\ \ \ \ \ \_\_cli();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00175}00175\ \ \ \ \ \textcolor{comment}{//\ Initialize\ the\ CR\ (Control\ Registers)\ registers\ to\ our\ settings.}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00176}00176\ \ \ \ \ InitialiseControlRegisters();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00177}00177\ \ \ \ \ \textcolor{comment}{//\ Zero\ the\ BSS.}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00178}00178\ \ \ \ \ zero\_bss();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00179}00179\ \ \ \ \ \textcolor{comment}{//\ Create\ the\ local\ boot\ struct.}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00180}00180\ \ \ \ \ \mbox{\hyperlink{kernel_8c_a1aeed12b2d6dcc95b0e4457dab2e891c}{init\_boot\_info}}(boot\_info);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00181}00181\ \ \ \ \ \textcolor{comment}{//\ Initialize\ the\ global\ CPU\ struct.}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00182}00182\ \ \ \ \ \mbox{\hyperlink{kernel_8c_a4aa078dcf96e9f06ce620519a93593c1}{InitCPU}}();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00183}00183\ \ \ \ \ \textcolor{comment}{//\ Initialize\ interrupts\ \&\ exceptions.}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00184}00184\ \ \ \ \ init\_interrupts();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00185}00185\ \ \ \ \ \textcolor{comment}{//\ Initialize\ the\ frame\ bitmaps\ for\ dynamic\ frame\ allocation.}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00186}00186\ \ \ \ \ frame\_bitmap\_init();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00187}00187\ \ \ \ \ \textcolor{comment}{//\ Finally,\ initialize\ our\ heap\ for\ memory\ allocation\ (like\ threads,\ processes,\ structs..)}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00188}00188\ \ \ \ \ init\_heap();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00189}00189\ \ \ \ \ \_MtSetIRQL(PASSIVE\_LEVEL);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00190}00190\ \ \ \ \ \textcolor{comment}{/*\ Initiate\ Scheduler\ and\ DPCs\ */}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00191}00191\ \ \ \ \ InitScheduler();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00192}00192\ \ \ \ \ init\_dpc\_system();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00193}00193\ \ \ \ \ gop\_clear\_screen(\&\mbox{\hyperlink{kernel_8c_ad8ca0be32b831aec9de80bcf0e22107e}{gop\_local}},\ 0);\ \textcolor{comment}{//\ 0\ is\ just\ black.\ (0x0000000)}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00194}00194\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00195}00195\ \ \ \ \ \textcolor{comment}{//MemoryTestStable();}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00196}00196\ \ \ \ \ \textcolor{comment}{//\_\_cli();}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00197}00197\ \ \ \ \ \textcolor{comment}{//\_\_hlt();}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00198}00198\ \ \ \ \ \textcolor{keyword}{extern}\ uint32\_t\ cursor\_x,\ cursor\_y;}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00199}00199\ \ \ \ \ cursor\_x\ =\ cursor\_y\ =\ 0;\ \textcolor{comment}{//\ set\ to\ 0,\ since\ it\ somehow\ decrements\ them.}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00200}00200\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00201}00201\ \ \ \ \ uint64\_t\ rip;}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00202}00202\ \ \ \ \ \_\_asm\_\_\ \textcolor{keyword}{volatile}\ (}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00203}00203\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}lea\ 1f(\%\%rip),\ \%0\(\backslash\)n\(\backslash\)t"{}}\ \ \textcolor{comment}{//\ Calculate\ the\ address\ of\ label\ 1\ relative\ to\ RIP}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00204}00204\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}1:"{}}\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ The\ label\ whose\ address\ we\ want}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00205}00205\ \ \ \ \ \ \ \ \ :\ \textcolor{stringliteral}{"{}=r"{}}(rip)\ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Output\ to\ the\ 'rip'\ variable}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00206}00206\ \ \ \ \ \ \ \ \ );}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00207}00207\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00208}00208\ \ \ \ \ \mbox{\hyperlink{kernel_8h_a29f75e67ea1a76410256bf17f8226e05}{gop\_printf\_forced}}(0xFFFFFF00,\ \textcolor{stringliteral}{"{}Current\ RIP:\ \%p\(\backslash\)n"{}},\ rip);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00209}00209\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00210}00210\ \ \ \ \ \textcolor{keywordflow}{if}\ (rip\ >=\ KERNEL\_VA\_START)\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00211}00211\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{kernel_8h_a29f75e67ea1a76410256bf17f8226e05}{gop\_printf\_forced}}(0x00FF00FF,\ \textcolor{stringliteral}{"{}**[+]\ Running\ in\ higher-\/half**\(\backslash\)n"{}});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00212}00212\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00213}00213\ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00214}00214\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{kernel_8h_a29f75e67ea1a76410256bf17f8226e05}{gop\_printf\_forced}}(0xFF0000FF,\ \textcolor{stringliteral}{"{}[-\/]\ Still\ identity-\/mapped\(\backslash\)n"{}});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00215}00215\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00216}00216\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00217}00217\ \ \ \ \ \textcolor{keywordtype}{void}*\ buf\ =\ MtAllocateVirtualMemory(64,\ 16);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00218}00218\ \ \ \ \ \mbox{\hyperlink{kernel_8h_a29f75e67ea1a76410256bf17f8226e05}{gop\_printf\_forced}}(0xFFFFFF00,\ \textcolor{stringliteral}{"{}buf\ addr:\ \%p\(\backslash\)n"{}},\ buf);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00219}00219\ \ \ \ \ \textcolor{keywordtype}{void}*\ buf2\ =\ MtAllocateVirtualMemory(128,\ 16);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00220}00220\ \ \ \ \ \mbox{\hyperlink{kernel_8h_a29f75e67ea1a76410256bf17f8226e05}{gop\_printf\_forced}}(0xFFFFFF00,\ \textcolor{stringliteral}{"{}buf2\ addr:\ \%p\(\backslash\)n"{}},\ buf2);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00221}00221\ \ \ \ \ MtFreeVirtualMemory(buf2);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00222}00222\ \ \ \ \ \textcolor{keywordtype}{void}*\ buf3\ =\ MtAllocateVirtualMemory(128,\ 16);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00223}00223\ \ \ \ \ \mbox{\hyperlink{kernel_8h_a29f75e67ea1a76410256bf17f8226e05}{gop\_printf\_forced}}(0xFFFFFF00,\ \textcolor{stringliteral}{"{}buf3\ addr\ (should\ be\ same\ as\ buf2):\ \%p\(\backslash\)n"{}},\ buf3);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00224}00224\ \ \ \ \ \textcolor{keywordtype}{void}*\ buf4\ =\ MtAllocateVirtualMemory(2048,\ 16);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00225}00225\ \ \ \ \ \mbox{\hyperlink{kernel_8h_a29f75e67ea1a76410256bf17f8226e05}{gop\_printf\_forced}}(0xFF964B00,\ \textcolor{stringliteral}{"{}buf4\ addr\ (should\ reside\ after\ buf3,\ allocated\ 2048\ bytes):\ \%p\(\backslash\)n"{}},\ buf4);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00226}00226\ \ \ \ \ \textcolor{keywordtype}{void}*\ buf5\ =\ MtAllocateVirtualMemory(64,\ 16);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00227}00227\ \ \ \ \ \mbox{\hyperlink{kernel_8h_a29f75e67ea1a76410256bf17f8226e05}{gop\_printf\_forced}}(0xFF964B00,\ \textcolor{stringliteral}{"{}buf5\ addr\ (should\ be\ a\ larger\ addr):\ \%p\(\backslash\)n"{}},\ buf5);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00228}00228\ \ \ \ \ \textcolor{keywordtype}{void}*\ buf6\ =\ MtAllocateVirtualMemory(5000,\ 64);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00229}00229\ \ \ \ \ \mbox{\hyperlink{kernel_8h_a29f75e67ea1a76410256bf17f8226e05}{gop\_printf\_forced}}(0xFFFFFF00,\ \textcolor{stringliteral}{"{}buf6\ addr\ (should\ use\ dynamic\ memory):\ \%p\(\backslash\)n"{}},\ buf6);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00230}00230\ \ \ \ \ \textcolor{keywordtype}{void}*\ buf7\ =\ MtAllocateVirtualMemory(10000,\ 128);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00231}00231\ \ \ \ \ \mbox{\hyperlink{kernel_8h_a29f75e67ea1a76410256bf17f8226e05}{gop\_printf\_forced}}(0xFFFFFF00,\ \textcolor{stringliteral}{"{}buf7\ addr\ (should\ use\ dynamic\ memory,\ extremely\ larger):\ \%p\(\backslash\)n"{}},\ buf7);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00232}00232\ \ \ \ \ \textcolor{comment}{//\ check}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00233}00233\ \ \ \ \ \textcolor{keywordtype}{void}*\ addr\ =\ 0;}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00234}00234\ \ \ \ \ gop\_printf(COLOR\_ORANGE,\ \textcolor{stringliteral}{"{}Address:\ \%p\ is\ \%s\(\backslash\)n"{}},\ addr,\ MtIsAddressValid(addr)\ ?\ \textcolor{stringliteral}{"{}Valid"{}}\ :\ \textcolor{stringliteral}{"{}Invalid"{}});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00235}00235\ \ \ \ \ gop\_printf(COLOR\_ORANGE,\ \textcolor{stringliteral}{"{}Address\ \%p\ (buf7)\ is\ \%s\(\backslash\)n"{}},\ buf7,\ MtIsAddressValid(buf7)\ ?\ \textcolor{stringliteral}{"{}Valid"{}}\ :\ \textcolor{stringliteral}{"{}Invalid"{}});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00236}00236\ \ \ \ \ gop\_printf(COLOR\_MAGENTA,\ \textcolor{stringliteral}{"{}BUF7\ (VIRT):\ \%p\ |\ (PHYS):\ \%p\(\backslash\)n"{}},\ buf7,\ MtTranslateVirtualToPhysical(buf7));}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00237}00237\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00238}00238\ \textcolor{preprocessor}{\#ifdef\ CAUSE\_BUGCHECK}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00239}00239\ \ \ \ \ \mbox{\hyperlink{kernel_8h_ac240bdf341c5e0ae333252cd5ecf0261}{CTX\_FRAME}}\ regs;}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00240}00240\ \ \ \ \ SAVE\_CTX\_FRAME(\&regs);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00241}00241\ \ \ \ \ MtBugcheck(\&regs,\ NULL,\ MANUALLY\_INITIATED\_CRASH,\ 0xDEADBEEF,\ \textcolor{keyword}{true});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00242}00242\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00243}00243\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00244}00244\ \ \ \ \ \textcolor{keywordflow}{if}\ (checkcpuid())\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00245}00245\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{char}\ str[256];}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00246}00246\ \ \ \ \ \ \ \ \ getCpuName(str);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00247}00247\ \ \ \ \ \ \ \ \ gop\_printf(COLOR\_GREEN,\ \textcolor{stringliteral}{"{}CPU\ Identified:\ \%s\(\backslash\)n"{}},\ str);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00248}00248\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00249}00249\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00250}00250\ \ \ \ \ \mbox{\hyperlink{mtstatus_8h_a7c794b38d203a5b842f27b12fb55495a}{MTSTATUS}}\ status;}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00251}00251\ \ \ \ \ status\ =\ vfs\_init();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00252}00252\ \ \ \ \ gop\_printf(COLOR\_RED,\ \textcolor{stringliteral}{"{}vfs\_init\ returned:\ \%s\(\backslash\)n"{}},\ \mbox{\hyperlink{mtstatus_8h_ab1c4c30274cca0fd5c0920b0df2ad26c}{MT\_SUCCEEDED}}(status)\ ?\ \textcolor{stringliteral}{"{}Success"{}}\ :\ \textcolor{stringliteral}{"{}Unsuccessful"{}});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00253}00253\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{mtstatus_8h_a51b65f92cdedadf23a01dff0f9f4fac7}{MT\_FAILURE}}(status))\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00254}00254\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{kernel_8h_ac240bdf341c5e0ae333252cd5ecf0261}{CTX\_FRAME}}\ ctx;}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00255}00255\ \ \ \ \ \ \ \ \ SAVE\_CTX\_FRAME(\&ctx);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00256}00256\ \ \ \ \ \ \ \ \ MtBugcheck(\&ctx,\ NULL,\ FILESYSTEM\_PANIC,\ 0,\ \textcolor{keyword}{false});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00257}00257\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00258}00258\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00259}00259\ \ \ \ \ \mbox{\hyperlink{struct_t_i_m_e___e_n_t_r_y}{TIME\_ENTRY}}\ currTime\ =\ get\_time();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00260}00260\ \textcolor{preprocessor}{\#define\ ISRAEL\_UTC\_OFFSET\ 3}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00261}00261\ \ \ \ \ gop\_printf(COLOR\_GREEN,\ \textcolor{stringliteral}{"{}Current\ Time:\ \%d/\%d/\%d\ |\ \%d:\%d:\%d\(\backslash\)n"{}},\ currTime.\mbox{\hyperlink{struct_t_i_m_e___e_n_t_r_y_a57ca98d8f6d4baf0fe41c583c7dcb0d5}{year}},\ currTime.\mbox{\hyperlink{struct_t_i_m_e___e_n_t_r_y_a3e00faf7fbf9805e9ec4d2edd6339050}{month}},\ currTime.\mbox{\hyperlink{struct_t_i_m_e___e_n_t_r_y_a72369a1087b2aeffe374bb054cb97c12}{day}},\ currTime.\mbox{\hyperlink{struct_t_i_m_e___e_n_t_r_y_ae5af4ff48939d13d480f87e56a9385d6}{hour}}\ +\ \mbox{\hyperlink{kernel_8c_a2d000697316631e744359a19471179c9}{ISRAEL\_UTC\_OFFSET}},\ currTime.\mbox{\hyperlink{struct_t_i_m_e___e_n_t_r_y_a8ff981ec55c945940f4a0da7d8709b3c}{minute}},\ currTime.\mbox{\hyperlink{struct_t_i_m_e___e_n_t_r_y_a8459fc4e94de7eefc74991e41779c8fc}{second}});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00262}00262\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00263}00263\ \ \ \ \ \textcolor{keywordtype}{char}\ listings[256];}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00264}00264\ \ \ \ \ status\ =\ vfs\_listdir(\textcolor{stringliteral}{"{}/"{}},\ listings,\ \textcolor{keyword}{sizeof}(listings));}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00265}00265\ \ \ \ \ gop\_printf(COLOR\_RED,\ \textcolor{stringliteral}{"{}vfs\_listdir\ returned:\ \%p\(\backslash\)n"{}},\ status);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00266}00266\ \ \ \ \ gop\_printf(COLOR\_RED,\ \textcolor{stringliteral}{"{}root\ directory\ is:\ \%s\(\backslash\)n"{}},\ vfs\_is\_dir\_empty(\textcolor{stringliteral}{"{}/"{}})\ ?\ \textcolor{stringliteral}{"{}Empty"{}}\ :\ \textcolor{stringliteral}{"{}Not\ Empty"{}});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00267}00267\ \ \ \ \ gop\_printf(COLOR\_CYAN,\ \textcolor{stringliteral}{"{}\%s"{}},\ listings);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00268}00268\ \ \ \ \ MUTEX*\ sharedMutex\ =\ MtAllocateVirtualMemory(\textcolor{keyword}{sizeof}(MUTEX),\ \_Alignof(MUTEX));}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00269}00269\ \ \ \ \ \textcolor{keywordflow}{if}\ (!sharedMutex)\ \{\ gop\_printf(COLOR\_RED,\ \textcolor{stringliteral}{"{}It's\ null\(\backslash\)n"{}});\ \_\_hlt();\ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00270}00270\ \ \ \ \ status\ =\ MtInitializeMutexObject(sharedMutex);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00271}00271\ \ \ \ \ gop\_printf(COLOR\_RED,\ \textcolor{stringliteral}{"{}[MTSTATUS]\ MtInitializeObject\ Returned:\ \%p\(\backslash\)n"{}},\ status);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00272}00272\ \ \ \ \ MtCreateThread((ThreadEntry)test,\ sharedMutex,\ DEFAULT\_TIMESLICE\_TICKS,\ \textcolor{keyword}{true});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00273}00273\ \ \ \ \ \textcolor{comment}{//int\ integer\ =\ 1234;}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00274}00274\ \ \ \ \ MtCreateThread((ThreadEntry)funcWithParam,\ sharedMutex,\ DEFAULT\_TIMESLICE\_TICKS,\ \textcolor{keyword}{true});\ \textcolor{comment}{//\ I\ have\ tested\ 5+\ threads,\ works\ perfectly\ as\ it\ should.}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00275}00275\ \ \ \ \ \textcolor{comment}{/*\ Enable\ LAPIC\ Now.\ */}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00276}00276\ \ \ \ \ lapic\_init\_bsp();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00277}00277\ \ \ \ \ lapic\_enable();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00278}00278\ \ \ \ \ init\_lapic\_timer(100);\ \textcolor{comment}{//\ 10ms}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00279}00279\ \ \ \ \ \_\_sti();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00280}00280\ \ \ \ \ Schedule();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00281}00281\ \}}

\end{DoxyCode}

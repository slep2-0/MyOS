\doxysection{kernel.\+c}
\hypertarget{kernel_8c_source}{}\label{kernel_8c_source}\index{C:/Users/matanel/Desktop/Projects/KernelDevelopment/kernel/kernel.c@{C:/Users/matanel/Desktop/Projects/KernelDevelopment/kernel/kernel.c}}
\mbox{\hyperlink{kernel_8c}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00001}00001\ \textcolor{comment}{/*}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00002}00002\ \textcolor{comment}{\ *\ PROJECT:\ \ \ \ \ \ MatanelOS\ Kernel}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00003}00003\ \textcolor{comment}{\ *\ LICENSE:\ \ \ \ \ \ GPLv3}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00004}00004\ \textcolor{comment}{\ *\ PURPOSE:\ \ \ \ \ \ Core\ Kernel\ Entry\ Point\ for\ MatanelOS.}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00005}00005\ \textcolor{comment}{\ */}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00006}00006\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00007}00007\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{kernel_8h}{kernel.h}}"{}}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00008}00008\ \textcolor{preprocessor}{\#ifndef\ \_MSC\_VER}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00009}00009\ \textcolor{keyword}{\_Static\_assert}(\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{void}*)\ ==\ 8,\ \textcolor{stringliteral}{"{}This\ Kernel\ is\ 64\ bit\ only!\ The\ 32bit\ version\ is\ deprecated."{}});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00010}00010\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00011}00011\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00012}\mbox{\hyperlink{kernel_8c_a9fed467298b3e70426485013c0caf964}{00012}}\ \textcolor{preprocessor}{\#define\ MAX\_AHCI\_CONTROLLERS\ 32}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00013}\mbox{\hyperlink{kernel_8c_a3764ef588283aaa224d9dd8d89a35c52}{00013}}\ uint64\_t\ \mbox{\hyperlink{kernel_8c_a3764ef588283aaa224d9dd8d89a35c52}{ahci\_bases\_local}}[\mbox{\hyperlink{kernel_8c_a9fed467298b3e70426485013c0caf964}{MAX\_AHCI\_CONTROLLERS}}];}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00014}00014\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00015}\mbox{\hyperlink{ahci_8c_ad8ca0be32b831aec9de80bcf0e22107e}{00015}}\ \mbox{\hyperlink{uefi__memory_8h_a76f436ea56fd593cab07a6800d630828}{GOP\_PARAMS}}\ \mbox{\hyperlink{bugcheck_8c_ad8ca0be32b831aec9de80bcf0e22107e}{gop\_local}};}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00016}\mbox{\hyperlink{ahci_8c_a5f06053b8248ece91f68e4ae8da74ee4}{00016}}\ \mbox{\hyperlink{kernel_8h_aa7f93145770b2b55fa44fc8b9a2cf58d}{BOOT\_INFO}}\ \mbox{\hyperlink{ahci_8c_a5f06053b8248ece91f68e4ae8da74ee4}{boot\_info\_local}};}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00017}00017\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00018}00018\ \textcolor{comment}{/*}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00019}00019\ \textcolor{comment}{Global\ variables\ initialization}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00020}00020\ \textcolor{comment}{*/}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00021}\mbox{\hyperlink{bugcheck_8c_a3e4cb7a3337aa00fccafe03c7b5a59fc}{00021}}\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{bugcheck_8c_a3e4cb7a3337aa00fccafe03c7b5a59fc}{isBugChecking}}\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00022}\mbox{\hyperlink{bugcheck_8c_a84fdaa754c58bd3a02ef7e0c36cfff33}{00022}}\ \mbox{\hyperlink{struct_l_a_s_t_f_u_n_c___h_i_s_t_o_r_y}{LASTFUNC\_HISTORY}}\ \mbox{\hyperlink{bugcheck_8c_a84fdaa754c58bd3a02ef7e0c36cfff33}{lastfunc\_history}}\ =\ \{\ .current\_index\ =\ -\/1\ \};}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00023}\mbox{\hyperlink{bugcheck_8c_a0b2a3530e9a5998456be351b4251b878}{00023}}\ \mbox{\hyperlink{cpu__types_8h_a9bb4e76feb6dc6ad7a88c5a7cab56467}{CPU}}\ \mbox{\hyperlink{bugcheck_8c_a0b2a3530e9a5998456be351b4251b878}{cpu}};}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00024}00024\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00025}00025\ \textcolor{comment}{//DECLARE\_THREAD(workerThread,\ 4096)}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00026}00026\ \textcolor{comment}{/*}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00027}00027\ \textcolor{comment}{Ended}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00028}00028\ \textcolor{comment}{*/}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00029}\mbox{\hyperlink{kernel_8c_ad6664187bc75188329b950c21f5f380a}{00029}}\ \textcolor{preprocessor}{\#define\ MAX\_MEMORY\_MAP\_SIZE\ 0x4000\ \ }\textcolor{comment}{//\ 16\ KB,\ enough\ for\ \string~256\ descriptors}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00030}00030\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00031}00031\ \textcolor{keyword}{static}\ \mbox{\hyperlink{uefi__memory_8h_ae2b15dcae1dcf3876131751b232dc591}{EFI\_MEMORY\_DESCRIPTOR}}\ memory\_map\_copy[\mbox{\hyperlink{kernel_8c_ad6664187bc75188329b950c21f5f380a}{MAX\_MEMORY\_MAP\_SIZE}}\ /\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{uefi__memory_8h_ae2b15dcae1dcf3876131751b232dc591}{EFI\_MEMORY\_DESCRIPTOR}})];}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00032}00032\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00033}\mbox{\hyperlink{kernel_8c_a26b7a33ce7ac27191c39745d6852acd1}{00033}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{kernel_8c_a26b7a33ce7ac27191c39745d6852acd1}{copy\_memory\_map}}(\mbox{\hyperlink{kernel_8h_aa7f93145770b2b55fa44fc8b9a2cf58d}{BOOT\_INFO}}*\ boot\_info)\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00034}00034\ \ \ \ \ \textcolor{keywordflow}{if}\ (!boot\_info\ ||\ !boot\_info-\/>\mbox{\hyperlink{struct___b_o_o_t___i_n_f_o_a43e384015b713dc64d7f8a59ad452622}{MemoryMap}})\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00035}00035\ \ \ \ \ \textcolor{keywordflow}{if}\ (boot\_info-\/>\mbox{\hyperlink{struct___b_o_o_t___i_n_f_o_a9bec53c13537ffc17434fc3db3f36f0d}{MapSize}}\ >\ \mbox{\hyperlink{kernel_8c_ad6664187bc75188329b950c21f5f380a}{MAX\_MEMORY\_MAP\_SIZE}})\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00036}00036\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ handle\ error,\ memory\ map\ too\ big}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00037}00037\ \ \ \ \ \ \ \ \ MtBugcheck(NULL,\ NULL,\ \mbox{\hyperlink{bugcheck_8h_a3dd6c077b2422dcc0d05246537da5c82a4a2640e8c7cdd34c55bb095e68507dd5}{MEMORY\_MAP\_SIZE\_OVERRUN}},\ 0,\ \textcolor{keyword}{false});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00038}00038\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00039}00039\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00040}00040\ \ \ \ \ \textcolor{comment}{//\ Copy\ the\ entire\ memory\ map\ into\ the\ static\ buffer}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00041}00041\ \ \ \ \ \mbox{\hyperlink{memory_8c_ab39f87327d3ce3e35d369e4e9f7a4c69}{kmemcpy}}(memory\_map\_copy,\ boot\_info-\/>\mbox{\hyperlink{struct___b_o_o_t___i_n_f_o_a43e384015b713dc64d7f8a59ad452622}{MemoryMap}},\ boot\_info-\/>\mbox{\hyperlink{struct___b_o_o_t___i_n_f_o_a9bec53c13537ffc17434fc3db3f36f0d}{MapSize}});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00042}00042\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00043}00043\ \ \ \ \ \mbox{\hyperlink{ahci_8c_a5f06053b8248ece91f68e4ae8da74ee4}{boot\_info\_local}}.MemoryMap\ =\ memory\_map\_copy;}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00044}00044\ \ \ \ \ \mbox{\hyperlink{ahci_8c_a5f06053b8248ece91f68e4ae8da74ee4}{boot\_info\_local}}.MapSize\ =\ boot\_info-\/>\mbox{\hyperlink{struct___b_o_o_t___i_n_f_o_a9bec53c13537ffc17434fc3db3f36f0d}{MapSize}};}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00045}00045\ \ \ \ \ \mbox{\hyperlink{ahci_8c_a5f06053b8248ece91f68e4ae8da74ee4}{boot\_info\_local}}.DescriptorSize\ =\ boot\_info-\/>\mbox{\hyperlink{struct___b_o_o_t___i_n_f_o_a8bc89261b88b97450ff261d153d0bbdb}{DescriptorSize}};}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00046}00046\ \ \ \ \ \mbox{\hyperlink{ahci_8c_a5f06053b8248ece91f68e4ae8da74ee4}{boot\_info\_local}}.DescriptorVersion\ =\ boot\_info-\/>\mbox{\hyperlink{struct___b_o_o_t___i_n_f_o_a9bd937b7be27174d2dc8180375fec3b8}{DescriptorVersion}};}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00047}00047\ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00048}00048\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00049}\mbox{\hyperlink{kernel_8c_a8bf2519b1a607ce677d092c706b92f00}{00049}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{kernel_8c_a8bf2519b1a607ce677d092c706b92f00}{copy\_gop}}(\mbox{\hyperlink{kernel_8h_aa7f93145770b2b55fa44fc8b9a2cf58d}{BOOT\_INFO}}*\ boot\_info)\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00050}00050\ \ \ \ \ \textcolor{keywordflow}{if}\ (!boot\_info\ ||\ !boot\_info-\/>\mbox{\hyperlink{struct___b_o_o_t___i_n_f_o_aab6f1679f3c12592a766d2f3078ef80d}{Gop}})\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00051}00051\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00052}00052\ \ \ \ \ \textcolor{comment}{//\ Copy\ the\ GOP\ data\ to\ a\ local\ global\ variable}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00053}00053\ \ \ \ \ \mbox{\hyperlink{bugcheck_8c_ad8ca0be32b831aec9de80bcf0e22107e}{gop\_local}}\ =\ *(boot\_info-\/>\mbox{\hyperlink{struct___b_o_o_t___i_n_f_o_aab6f1679f3c12592a766d2f3078ef80d}{Gop}});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00054}00054\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00055}00055\ \ \ \ \ \textcolor{comment}{//\ Update\ all\ relevant\ pointers\ to\ point\ to\ the\ local\ copy}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00056}00056\ \ \ \ \ boot\_info-\/>\mbox{\hyperlink{struct___b_o_o_t___i_n_f_o_aab6f1679f3c12592a766d2f3078ef80d}{Gop}}\ =\ \&\mbox{\hyperlink{bugcheck_8c_ad8ca0be32b831aec9de80bcf0e22107e}{gop\_local}};}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00057}00057\ \ \ \ \ \mbox{\hyperlink{ahci_8c_a5f06053b8248ece91f68e4ae8da74ee4}{boot\_info\_local}}.Gop\ =\ \&\mbox{\hyperlink{bugcheck_8c_ad8ca0be32b831aec9de80bcf0e22107e}{gop\_local}};}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00058}00058\ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00059}00059\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00060}00060\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00061}\mbox{\hyperlink{kernel_8c_a1aeed12b2d6dcc95b0e4457dab2e891c}{00061}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{kernel_8c_a1aeed12b2d6dcc95b0e4457dab2e891c}{init\_boot\_info}}(\mbox{\hyperlink{kernel_8h_aa7f93145770b2b55fa44fc8b9a2cf58d}{BOOT\_INFO}}*\ boot\_info)\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00062}00062\ \ \ \ \ \textcolor{keywordflow}{if}\ (!boot\_info)\ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00063}00063\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00064}00064\ \ \ \ \ \mbox{\hyperlink{kernel_8c_a26b7a33ce7ac27191c39745d6852acd1}{copy\_memory\_map}}(boot\_info);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00065}00065\ \ \ \ \ \mbox{\hyperlink{kernel_8c_a8bf2519b1a607ce677d092c706b92f00}{copy\_gop}}(boot\_info);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00066}00066\ \ \ \ \ \textcolor{keywordflow}{if}\ (boot\_info-\/>\mbox{\hyperlink{struct___b_o_o_t___i_n_f_o_a23b3867b03377e742e1537a995614d4a}{AhciCount}}\ >\ \mbox{\hyperlink{kernel_8c_a9fed467298b3e70426485013c0caf964}{MAX\_AHCI\_CONTROLLERS}})\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00067}00067\ \ \ \ \ \ \ \ \ MtBugcheck(NULL,\ NULL,\ \mbox{\hyperlink{bugcheck_8h_a3dd6c077b2422dcc0d05246537da5c82a9ff084588ec0461c821ca07a6efbe62f}{BAD\_AHCI\_COUNT}},\ 0,\ \textcolor{keyword}{false});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00068}00068\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00069}00069\ \ \ \ \ \textcolor{keywordflow}{for}\ (uint32\_t\ i\ =\ 0;\ i\ <\ boot\_info-\/>\mbox{\hyperlink{struct___b_o_o_t___i_n_f_o_a23b3867b03377e742e1537a995614d4a}{AhciCount}};\ i++)\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00070}00070\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{kernel_8c_a3764ef588283aaa224d9dd8d89a35c52}{ahci\_bases\_local}}[i]\ =\ boot\_info-\/>\mbox{\hyperlink{struct___b_o_o_t___i_n_f_o_a5f8313f482578def454206464500791f}{AhciBarBases}}[i];}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00071}00071\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00072}00072\ \ \ \ \ \mbox{\hyperlink{ahci_8c_a5f06053b8248ece91f68e4ae8da74ee4}{boot\_info\_local}}.AhciBarBases\ =\ \mbox{\hyperlink{kernel_8c_a3764ef588283aaa224d9dd8d89a35c52}{ahci\_bases\_local}};}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00073}00073\ \ \ \ \ \mbox{\hyperlink{ahci_8c_a5f06053b8248ece91f68e4ae8da74ee4}{boot\_info\_local}}.AhciCount\ =\ boot\_info-\/>\mbox{\hyperlink{struct___b_o_o_t___i_n_f_o_a23b3867b03377e742e1537a995614d4a}{AhciCount}};}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00074}00074\ \ \ \ \ \mbox{\hyperlink{ahci_8c_a5f06053b8248ece91f68e4ae8da74ee4}{boot\_info\_local}}.KernelStackTop\ =\ boot\_info-\/>\mbox{\hyperlink{struct___b_o_o_t___i_n_f_o_a61086e11b571ce7c7b87cc71149f142f}{KernelStackTop}};}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00075}00075\ \ \ \ \ \mbox{\hyperlink{ahci_8c_a5f06053b8248ece91f68e4ae8da74ee4}{boot\_info\_local}}.Pml4Phys\ =\ boot\_info-\/>\mbox{\hyperlink{struct___b_o_o_t___i_n_f_o_a090449e0fb7c66ee9dbf612ea681ba07}{Pml4Phys}};}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00076}00076\ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00077}00077\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00078}00078\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ InitialiseControlRegisters(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00079}00079\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00080}00080\ \ \ \ \ \textcolor{comment}{/*\ CR0\ */}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00081}00081\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{long}\ cr0\ =\ \_\_read\_cr0();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00082}00082\ \ \ \ \ cr0\ |=\ (1UL\ <<\ 16);\ \textcolor{comment}{//\ Set\ bit\ 16\ (WRITE\ PROTECT),\ so\ when\ the\ kernel\ touches\ read\ only\ memory\ it\ would\ \#PF.}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00083}00083\ \textcolor{preprocessor}{\#ifdef\ DEBUG}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00084}00084\ \ \ \ \ cr0\ |=\ (1UL\ <<\ 30);\ \textcolor{comment}{//\ Set\ bit\ 30\ (CACHE\ DISABLE).}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00085}00085\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00086}00086\ \ \ \ \ \_\_write\_cr0(cr0);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00087}00087\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00088}00088\ \ \ \ \ \textcolor{comment}{/*\ CR4\ */}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00089}00089\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{long}\ cr4\ =\ \_\_read\_cr4();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00090}00090\ \ \ \ \ cr4\ |=\ (1UL\ <<\ 11);\ \textcolor{comment}{//\ Set\ bit\ 11\ -\/\ User\ Mode\ Instruction\ Prevention.\ This'll\ be\ useful\ against\ user\ mode\ attacks\ to\ locate\ IDT/GDT/LDT...}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00091}00091\ \ \ \ \ \_\_write\_cr4(cr4);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00092}00092\ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00093}00093\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00094}\mbox{\hyperlink{cpu_8h_a4aa078dcf96e9f06ce620519a93593c1}{00094}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{kernel_8c_a4aa078dcf96e9f06ce620519a93593c1}{InitCPU}}(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00095}00095\ \ \ \ \ \mbox{\hyperlink{bugcheck_8c_a0b2a3530e9a5998456be351b4251b878}{cpu}}.currentIrql\ =\ \mbox{\hyperlink{cpu__types_8h_a6ff101fd8adf1c79792d98893f8dee3eacf81bceb86f53bdf373ff56d5f6e179f}{PASSIVE\_LEVEL}};}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00096}00096\ \ \ \ \ \mbox{\hyperlink{bugcheck_8c_a0b2a3530e9a5998456be351b4251b878}{cpu}}.schedulerEnabled\ =\ NULL;\ \textcolor{comment}{//\ since\ NULL\ is\ 0,\ it\ would\ be\ false.}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00097}00097\ \ \ \ \ \mbox{\hyperlink{bugcheck_8c_a0b2a3530e9a5998456be351b4251b878}{cpu}}.currentThread\ =\ NULL;}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00098}00098\ \ \ \ \ \mbox{\hyperlink{bugcheck_8c_a0b2a3530e9a5998456be351b4251b878}{cpu}}.readyQueue.head\ =\ \mbox{\hyperlink{bugcheck_8c_a0b2a3530e9a5998456be351b4251b878}{cpu}}.readyQueue.tail\ =\ NULL;}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00099}00099\ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00100}00100\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00101}00101\ \textcolor{keyword}{static}\ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{bool}\ interrupts\_enabled(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00102}00102\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{long}\ flags;}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00103}00103\ \ \ \ \ \_\_asm\_\_\ \_\_volatile\_\_(\textcolor{stringliteral}{"{}pushfq;\ popq\ \%0"{}}\ :\ \textcolor{stringliteral}{"{}=r"{}}(flags));}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00104}00104\ \ \ \ \ \textcolor{keywordflow}{return}\ (flags\ \&\ (1UL\ <<\ 9))\ !=\ 0;\ \textcolor{comment}{//\ IF\ is\ bit\ 9}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00105}00105\ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00106}00106\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00107}\mbox{\hyperlink{scheduler_8c_a9ce2606c20ea524922906d7816228c26}{00107}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{kernel_8c_a9ce2606c20ea524922906d7816228c26}{kernel\_idle\_checks}}(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00108}00108\ \ \ \ \ tracelast\_func(\textcolor{stringliteral}{"{}kernel\_idle\_checks\ -\/\ Thread"{}});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00109}00109\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{volatile}\ \textcolor{keywordtype}{bool}\ first\_time\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00110}00110\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00111}00111\ \ \ \ \ \textcolor{keywordflow}{if}\ (first\_time)\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00112}00112\ \ \ \ \ \ \ \ \ first\_time\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00113}00113\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{gop_8h_a29f75e67ea1a76410256bf17f8226e05}{gop\_printf\_forced}}(0xFF000FF0,\ \textcolor{stringliteral}{"{}Reached\ the\ scheduler!\(\backslash\)n"{}});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00114}00114\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keyword}{volatile}\ uint64\_t\ i\ =\ 0;\ i\ <\ 100000000ULL;\ ++i)\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00115}00115\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ delay\ loop\ */}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00116}00116\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00117}00117\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00118}00118\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{gop_8h_a29f75e67ea1a76410256bf17f8226e05}{gop\_printf\_forced}}(0xFF000FF0,\ \textcolor{stringliteral}{"{}**Ended\ Testing\ Thread\ Execution**\(\backslash\)n"{}});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00119}00119\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00120}00120\ \ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00121}00121\ \textcolor{comment}{\ \ \ \ assert((interrupts\_enabled())\ ==\ true,\ "{}Interrupts\ are\ not\ enabled..."{});}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00122}00122\ \textcolor{comment}{\ \ \ \ */}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00123}00123\ \ \ \ \ \textcolor{keywordflow}{while}\ (1)\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00124}00124\ \ \ \ \ \ \ \ \ \_\_hlt();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00125}00125\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00126}00126\ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00127}00127\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00128}00128\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ test(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00129}00129\ \ \ \ \ tracelast\_func(\textcolor{stringliteral}{"{}test\ -\/\ Thread"{}});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00130}00130\ \ \ \ \ \mbox{\hyperlink{gop_8h_a29f75e67ea1a76410256bf17f8226e05}{gop\_printf\_forced}}(0xFF00FF00,\ \textcolor{stringliteral}{"{}Hit\ Test!\(\backslash\)n"{}});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00131}00131\ \ \ \ \ \textcolor{keyword}{volatile}\ uint64\_t\ z\ =\ 0;}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00132}00132\ \ \ \ \ \textcolor{keywordflow}{for}\ (uint64\_t\ i\ =\ 0;\ i\ <\ 0xFFFFFFF;\ i++)\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00133}00133\ \ \ \ \ \ \ \ \ z++;}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00134}00134\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00135}00135\ \ \ \ \ \mbox{\hyperlink{cpu__types_8h_ad4bfc71eef5e5a6bb0806753203c7a48}{Thread}}*\ currentThread\ =\ \mbox{\hyperlink{thread_8c_a7f9170ee1211630dae69017a9c39f9e8}{MtGetCurrentThread}}();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00136}00136\ \ \ \ \ \mbox{\hyperlink{gop_8c_a41ff1165c1969706dadb5b409ae082e9}{gop\_printf}}(\mbox{\hyperlink{gop_8h_a3d28ef5dfbf3f7af50d52bff322a6c01}{COLOR\_OLIVE}},\ \textcolor{stringliteral}{"{}Current\ thread\ in\ test:\ \%p\(\backslash\)n"{}},\ currentThread);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00137}00137\ \ \ \ \ \mbox{\hyperlink{gop_8h_a29f75e67ea1a76410256bf17f8226e05}{gop\_printf\_forced}}(0xFFA020F0,\ \textcolor{stringliteral}{"{}**Ended\ Test.**\(\backslash\)n"{}});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00138}00138\ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00139}00139\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00140}00140\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ funcWithParam(\textcolor{keywordtype}{int}*\ integer)\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00141}00141\ \ \ \ \ tracelast\_func(\textcolor{stringliteral}{"{}funcWithParam\ -\/\ Thread"{}});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00142}00142\ \ \ \ \ \mbox{\hyperlink{gop_8h_a29f75e67ea1a76410256bf17f8226e05}{gop\_printf\_forced}}(\mbox{\hyperlink{gop_8h_a3d28ef5dfbf3f7af50d52bff322a6c01}{COLOR\_OLIVE}},\ \textcolor{stringliteral}{"{}Hit\ funcWithParam,\ Integer:\ \%d\(\backslash\)n"{}},\ *integer);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00143}00143\ \ \ \ \ \textcolor{keyword}{volatile}\ uint64\_t\ z\ =\ 0;}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00144}00144\ \ \ \ \ \textcolor{keywordflow}{for}\ (uint64\_t\ i\ =\ 0;\ i\ <\ 0xFFFFFFF;\ i++)\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00145}00145\ \ \ \ \ \ \ \ \ z++;}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00146}00146\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00147}00147\ \ \ \ \ \mbox{\hyperlink{cpu__types_8h_ad4bfc71eef5e5a6bb0806753203c7a48}{Thread}}*\ currentThread\ =\ \mbox{\hyperlink{thread_8c_a7f9170ee1211630dae69017a9c39f9e8}{MtGetCurrentThread}}();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00148}00148\ \ \ \ \ \mbox{\hyperlink{gop_8c_a41ff1165c1969706dadb5b409ae082e9}{gop\_printf}}(\mbox{\hyperlink{gop_8h_a3d28ef5dfbf3f7af50d52bff322a6c01}{COLOR\_OLIVE}},\ \textcolor{stringliteral}{"{}Current\ thread\ in\ funcWithParam:\ \%p\(\backslash\)n"{}},\ currentThread);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00149}00149\ \ \ \ \ \mbox{\hyperlink{gop_8h_a29f75e67ea1a76410256bf17f8226e05}{gop\_printf\_forced}}(\mbox{\hyperlink{gop_8h_a3d28ef5dfbf3f7af50d52bff322a6c01}{COLOR\_OLIVE}},\ \textcolor{stringliteral}{"{}**Ended\ funcWithParam.**\(\backslash\)n"{}});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00150}00150\ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00151}00151\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00153}\mbox{\hyperlink{kernel_8c_a290306ce314d46bd369c185b7b95db40}{00153}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{kernel_8c_a290306ce314d46bd369c185b7b95db40}{kernel\_main}}(\mbox{\hyperlink{kernel_8h_aa7f93145770b2b55fa44fc8b9a2cf58d}{BOOT\_INFO}}*\ boot\_info)\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00154}00154\ \ \ \ \ \textcolor{comment}{//tracelast\_func("{}kernel\_main"{});}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00155}00155\ \ \ \ \ \textcolor{comment}{//\ 1.\ CORE\ SYSTEM\ INITIALIZATION}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00156}00156\ \ \ \ \ \_\_cli();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00157}00157\ \ \ \ \ \textcolor{comment}{//\ Initialize\ the\ CR\ (Control\ Registers)\ registers\ to\ our\ settings.}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00158}00158\ \ \ \ \ InitialiseControlRegisters();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00159}00159\ \ \ \ \ \textcolor{comment}{//\ Zero\ the\ BSS.}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00160}00160\ \ \ \ \ \mbox{\hyperlink{memory_8c_aa1c249f197a325121cc9678b1665c29b}{zero\_bss}}();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00161}00161\ \ \ \ \ \textcolor{comment}{//\ Create\ the\ local\ boot\ struct.}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00162}00162\ \ \ \ \ \mbox{\hyperlink{kernel_8c_a1aeed12b2d6dcc95b0e4457dab2e891c}{init\_boot\_info}}(boot\_info);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00163}00163\ \ \ \ \ \textcolor{comment}{//\ Initialize\ the\ global\ CPU\ struct.}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00164}00164\ \ \ \ \ \mbox{\hyperlink{kernel_8c_a4aa078dcf96e9f06ce620519a93593c1}{InitCPU}}();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00165}00165\ \ \ \ \ \textcolor{comment}{//\ Initialize\ interrupts\ \&\ exceptions.}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00166}00166\ \ \ \ \ \mbox{\hyperlink{idt_8h_a657e2cb18189e638d49a59d6472f91e1}{init\_interrupts}}();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00167}00167\ \ \ \ \ \textcolor{comment}{//\ Initialize\ the\ frame\ bitmaps\ for\ dynamic\ frame\ allocation.}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00168}00168\ \ \ \ \ \mbox{\hyperlink{allocator_8c_af4512add62b5d487bf56ff115f3e16d7}{frame\_bitmap\_init}}();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00169}00169\ \ \ \ \ \textcolor{comment}{//\ Finally,\ initialize\ our\ heap\ for\ memory\ allocation\ (like\ threads,\ processes,\ structs..)}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00170}00170\ \ \ \ \ \mbox{\hyperlink{memory_8c_ae9571189e4229763c03dbf08f551f33f}{init\_heap}}();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00171}00171\ \ \ \ \ \mbox{\hyperlink{irql_8c_a4fb94a50a85a92c8939fa2201c5ba0d8}{\_MtSetIRQL}}(\mbox{\hyperlink{cpu__types_8h_a6ff101fd8adf1c79792d98893f8dee3eacf81bceb86f53bdf373ff56d5f6e179f}{PASSIVE\_LEVEL}});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00172}00172\ \ \ \ \ \textcolor{comment}{/*\ Initiate\ Scheduler\ and\ DPCs\ */}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00173}00173\ \ \ \ \ \mbox{\hyperlink{scheduler_8c_aeeccb93d922e4fb825916b6ca880ec10}{InitScheduler}}();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00174}00174\ \ \ \ \ \mbox{\hyperlink{dpc_8c_a2d28c37bcaae170ce51557a6a7355e78}{init\_dpc\_system}}();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00175}00175\ \ \ \ \ \mbox{\hyperlink{gop_8c_a99f29e094035e6b5420d63874004ed9f}{gop\_clear\_screen}}(\&\mbox{\hyperlink{bugcheck_8c_ad8ca0be32b831aec9de80bcf0e22107e}{gop\_local}},\ 0);\ \textcolor{comment}{//\ 0\ is\ just\ black.\ (0x0000000)}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00176}00176\ \ \ \ \ \textcolor{comment}{//MemoryTest();}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00177}00177\ \ \ \ \ \textcolor{comment}{//\_\_cli();}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00178}00178\ \ \ \ \ \textcolor{comment}{//\_\_hlt();}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00179}00179\ \ \ \ \ \textcolor{keyword}{extern}\ uint32\_t\ \mbox{\hyperlink{bugcheck_8c_aed43839a3c8b74504a97930edbe8b735}{cursor\_x}},\ \mbox{\hyperlink{bugcheck_8c_ad3e70ba50f805f295792f5dc66599d51}{cursor\_y}};}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00180}00180\ \ \ \ \ \mbox{\hyperlink{bugcheck_8c_aed43839a3c8b74504a97930edbe8b735}{cursor\_x}}\ =\ \mbox{\hyperlink{bugcheck_8c_ad3e70ba50f805f295792f5dc66599d51}{cursor\_y}}\ =\ 0;\ \textcolor{comment}{//\ set\ to\ 0,\ since\ it\ somehow\ decrements\ them.}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00181}00181\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00182}00182\ \ \ \ \ uint64\_t\ rip;}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00183}00183\ \ \ \ \ \_\_asm\_\_\ \textcolor{keyword}{volatile}\ (}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00184}00184\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}lea\ 1f(\%\%rip),\ \%0\(\backslash\)n\(\backslash\)t"{}}\ \ \textcolor{comment}{//\ Calculate\ the\ address\ of\ label\ 1\ relative\ to\ RIP}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00185}00185\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}1:"{}}\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ The\ label\ whose\ address\ we\ want}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00186}00186\ \ \ \ \ \ \ \ \ :\ \textcolor{stringliteral}{"{}=r"{}}(rip)\ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Output\ to\ the\ 'rip'\ variable}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00187}00187\ \ \ \ \ \ \ \ \ );}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00188}00188\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00189}00189\ \ \ \ \ \mbox{\hyperlink{gop_8h_a29f75e67ea1a76410256bf17f8226e05}{gop\_printf\_forced}}(0xFFFFFF00,\ \textcolor{stringliteral}{"{}Current\ RIP:\ \%p\(\backslash\)n"{}},\ rip);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00190}00190\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00191}00191\ \ \ \ \ \textcolor{keywordflow}{if}\ (rip\ >=\ \mbox{\hyperlink{paging_8h_a700f17da9a6192abc6b07ea137e1eb21}{KERNEL\_VA\_START}})\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00192}00192\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{gop_8h_a29f75e67ea1a76410256bf17f8226e05}{gop\_printf\_forced}}(0x00FF00FF,\ \textcolor{stringliteral}{"{}**[+]\ Running\ in\ higher-\/half**\(\backslash\)n"{}});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00193}00193\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00194}00194\ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00195}00195\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{gop_8h_a29f75e67ea1a76410256bf17f8226e05}{gop\_printf\_forced}}(0xFF0000FF,\ \textcolor{stringliteral}{"{}[-\/]\ Still\ identity-\/mapped\(\backslash\)n"{}});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00196}00196\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00197}00197\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00198}00198\ \ \ \ \ \textcolor{keywordtype}{void}*\ buf\ =\ \mbox{\hyperlink{memory_8c_a75f54e39669f1008f885acebe11d6e37}{MtAllocateVirtualMemory}}(64,\ 16);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00199}00199\ \ \ \ \ \mbox{\hyperlink{gop_8h_a29f75e67ea1a76410256bf17f8226e05}{gop\_printf\_forced}}(0xFFFFFF00,\ \textcolor{stringliteral}{"{}buf\ addr:\ \%p\(\backslash\)n"{}},\ buf);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00200}00200\ \ \ \ \ \textcolor{keywordtype}{void}*\ buf2\ =\ \mbox{\hyperlink{memory_8c_a75f54e39669f1008f885acebe11d6e37}{MtAllocateVirtualMemory}}(128,\ 16);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00201}00201\ \ \ \ \ \mbox{\hyperlink{gop_8h_a29f75e67ea1a76410256bf17f8226e05}{gop\_printf\_forced}}(0xFFFFFF00,\ \textcolor{stringliteral}{"{}buf2\ addr:\ \%p\(\backslash\)n"{}},\ buf2);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00202}00202\ \ \ \ \ \mbox{\hyperlink{memory_8c_af1b9597857f95921e2e2dc63e84394fa}{MtFreeVirtualMemory}}(buf2);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00203}00203\ \ \ \ \ \textcolor{keywordtype}{void}*\ buf3\ =\ \mbox{\hyperlink{memory_8c_a75f54e39669f1008f885acebe11d6e37}{MtAllocateVirtualMemory}}(128,\ 16);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00204}00204\ \ \ \ \ \mbox{\hyperlink{gop_8h_a29f75e67ea1a76410256bf17f8226e05}{gop\_printf\_forced}}(0xFFFFFF00,\ \textcolor{stringliteral}{"{}buf3\ addr\ (should\ be\ same\ as\ buf2):\ \%p\(\backslash\)n"{}},\ buf3);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00205}00205\ \ \ \ \ \textcolor{keywordtype}{void}*\ buf4\ =\ \mbox{\hyperlink{memory_8c_a75f54e39669f1008f885acebe11d6e37}{MtAllocateVirtualMemory}}(2048,\ 16);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00206}00206\ \ \ \ \ \mbox{\hyperlink{gop_8h_a29f75e67ea1a76410256bf17f8226e05}{gop\_printf\_forced}}(0xFF964B00,\ \textcolor{stringliteral}{"{}buf4\ addr\ (should\ reside\ after\ buf3,\ allocated\ 2048\ bytes):\ \%p\(\backslash\)n"{}},\ buf4);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00207}00207\ \ \ \ \ \textcolor{keywordtype}{void}*\ buf5\ =\ \mbox{\hyperlink{memory_8c_a75f54e39669f1008f885acebe11d6e37}{MtAllocateVirtualMemory}}(64,\ 16);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00208}00208\ \ \ \ \ \mbox{\hyperlink{gop_8h_a29f75e67ea1a76410256bf17f8226e05}{gop\_printf\_forced}}(0xFF964B00,\ \textcolor{stringliteral}{"{}buf5\ addr\ (should\ be\ a\ larger\ addr):\ \%p\(\backslash\)n"{}},\ buf5);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00209}00209\ \ \ \ \ \textcolor{keywordtype}{void}*\ buf6\ =\ \mbox{\hyperlink{memory_8c_a75f54e39669f1008f885acebe11d6e37}{MtAllocateVirtualMemory}}(5000,\ 64);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00210}00210\ \ \ \ \ \mbox{\hyperlink{gop_8h_a29f75e67ea1a76410256bf17f8226e05}{gop\_printf\_forced}}(0xFFFFFF00,\ \textcolor{stringliteral}{"{}buf6\ addr\ (should\ use\ dynamic\ memory):\ \%p\(\backslash\)n"{}},\ buf6);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00211}00211\ \ \ \ \ \textcolor{keywordtype}{void}*\ buf7\ =\ \mbox{\hyperlink{memory_8c_a75f54e39669f1008f885acebe11d6e37}{MtAllocateVirtualMemory}}(10000,\ 128);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00212}00212\ \ \ \ \ \mbox{\hyperlink{gop_8h_a29f75e67ea1a76410256bf17f8226e05}{gop\_printf\_forced}}(0xFFFFFF00,\ \textcolor{stringliteral}{"{}buf7\ addr\ (should\ use\ dynamic\ memory,\ extremely\ larger):\ \%p\(\backslash\)n"{}},\ buf7);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00213}00213\ \ \ \ \ \textcolor{comment}{//\ check}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00214}00214\ \ \ \ \ \textcolor{keywordtype}{void}*\ addr\ =\ 0;}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00215}00215\ \ \ \ \ \mbox{\hyperlink{gop_8c_a41ff1165c1969706dadb5b409ae082e9}{gop\_printf}}(\mbox{\hyperlink{gop_8h_aef75f616b9a3fdb10d38395dfb996873}{COLOR\_ORANGE}},\ \textcolor{stringliteral}{"{}Address:\ \%p\ is\ \%s\(\backslash\)n"{}},\ addr,\ \mbox{\hyperlink{paging_8c_aeed6cb9923e09f06a5e24339fb3dd62e}{MtIsAddressValid}}(addr)\ ?\ \textcolor{stringliteral}{"{}Valid"{}}\ :\ \textcolor{stringliteral}{"{}Invalid"{}});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00216}00216\ \ \ \ \ \mbox{\hyperlink{gop_8c_a41ff1165c1969706dadb5b409ae082e9}{gop\_printf}}(\mbox{\hyperlink{gop_8h_aef75f616b9a3fdb10d38395dfb996873}{COLOR\_ORANGE}},\ \textcolor{stringliteral}{"{}Address\ \%p\ (buf7)\ is\ \%s\(\backslash\)n"{}},\ buf7,\ \mbox{\hyperlink{paging_8c_aeed6cb9923e09f06a5e24339fb3dd62e}{MtIsAddressValid}}(buf7)\ ?\ \textcolor{stringliteral}{"{}Valid"{}}\ :\ \textcolor{stringliteral}{"{}Invalid"{}});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00217}00217\ \ \ \ \ \mbox{\hyperlink{gop_8c_a41ff1165c1969706dadb5b409ae082e9}{gop\_printf}}(\mbox{\hyperlink{gop_8h_a8deb0beccea721b35bdb1b4f7264fe75}{COLOR\_MAGENTA}},\ \textcolor{stringliteral}{"{}BUF7\ (VIRT):\ \%p\ |\ (PHYS):\ \%p\(\backslash\)n"{}},\ buf7,\ \mbox{\hyperlink{paging_8c_a7359fbe284826fefffe68a4b13305e4f}{MtTranslateVirtualToPhysical}}(buf7));}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00218}00218\ \textcolor{preprocessor}{\#ifdef\ CAUSE\_BUGCHECK}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00219}00219\ \ \ \ \ \mbox{\hyperlink{cpu__types_8h_ac240bdf341c5e0ae333252cd5ecf0261}{CTX\_FRAME}}\ regs;}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00220}00220\ \ \ \ \ \mbox{\hyperlink{cpu_8h_a4cb54878e75e454401e12e4865c7d122}{SAVE\_CTX\_FRAME}}(\&regs);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00221}00221\ \ \ \ \ MtBugcheck(\&regs,\ NULL,\ \mbox{\hyperlink{bugcheck_8h_a3dd6c077b2422dcc0d05246537da5c82a004606430fc1208a6ca0e03f033d0867}{MANUALLY\_INITIATED\_CRASH}},\ 0xDEADBEEF,\ \textcolor{keyword}{true});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00222}00222\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00223}00223\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00224}00224\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{cpuid_8h_a07baaa0cfda9434c8ac886b455ca685f}{checkcpuid}}())\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00225}00225\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{char}\ str[256];}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00226}00226\ \ \ \ \ \ \ \ \ getCpuName(str);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00227}00227\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{gop_8c_a41ff1165c1969706dadb5b409ae082e9}{gop\_printf}}(\mbox{\hyperlink{gop_8h_afc9149f5de51bd9ac4f5ebbfa153f018}{COLOR\_GREEN}},\ \textcolor{stringliteral}{"{}CPU\ Identified:\ \%s\(\backslash\)n"{}},\ str);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00228}00228\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00229}00229\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00230}00230\ \ \ \ \ \mbox{\hyperlink{mtstatus_8h_a7c794b38d203a5b842f27b12fb55495a}{MTSTATUS}}\ status;}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00231}00231\ \ \ \ \ status\ =\ \mbox{\hyperlink{vfs_8c_a90195d6c95683c2134cca9f87446be38}{vfs\_init}}();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00232}00232\ \ \ \ \ \mbox{\hyperlink{gop_8c_a41ff1165c1969706dadb5b409ae082e9}{gop\_printf}}(\mbox{\hyperlink{gop_8h_ad86358bf19927183dd7b4ae215a29731}{COLOR\_RED}},\ \textcolor{stringliteral}{"{}vfs\_init\ returned:\ \%s\(\backslash\)n"{}},\ \mbox{\hyperlink{mtstatus_8h_ab1c4c30274cca0fd5c0920b0df2ad26c}{MT\_SUCCEEDED}}(status)\ ?\ \textcolor{stringliteral}{"{}Success"{}}\ :\ \textcolor{stringliteral}{"{}Unsuccessful"{}});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00233}00233\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{mtstatus_8h_a51b65f92cdedadf23a01dff0f9f4fac7}{MT\_FAILURE}}(status))\ \{}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00234}00234\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{cpu__types_8h_ac240bdf341c5e0ae333252cd5ecf0261}{CTX\_FRAME}}\ ctx;}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00235}00235\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{cpu_8h_a4cb54878e75e454401e12e4865c7d122}{SAVE\_CTX\_FRAME}}(\&ctx);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00236}00236\ \ \ \ \ \ \ \ \ MtBugcheck(\&ctx,\ NULL,\ \mbox{\hyperlink{bugcheck_8h_a3dd6c077b2422dcc0d05246537da5c82a0f1a69904473988b332b7e0f24efbb45}{FILESYSTEM\_PANIC}},\ 0,\ \textcolor{keyword}{false});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00237}00237\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00238}00238\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00239}00239\ \ \ \ \ \mbox{\hyperlink{struct_t_i_m_e___e_n_t_r_y}{TIME\_ENTRY}}\ currTime\ =\ get\_time();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00240}00240\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00241}00241\ \textcolor{preprocessor}{\#define\ ISRAEL\_UTC\_OFFSET\ 3}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00242}00242\ \ \ \ \ \mbox{\hyperlink{gop_8c_a41ff1165c1969706dadb5b409ae082e9}{gop\_printf}}(\mbox{\hyperlink{gop_8h_afc9149f5de51bd9ac4f5ebbfa153f018}{COLOR\_GREEN}},\ \textcolor{stringliteral}{"{}Current\ Time:\ \%d/\%d/\%d\ |\ \%d:\%d:\%d\(\backslash\)n"{}},\ currTime.\mbox{\hyperlink{struct_t_i_m_e___e_n_t_r_y_a57ca98d8f6d4baf0fe41c583c7dcb0d5}{year}},\ currTime.\mbox{\hyperlink{struct_t_i_m_e___e_n_t_r_y_a3e00faf7fbf9805e9ec4d2edd6339050}{month}},\ currTime.\mbox{\hyperlink{struct_t_i_m_e___e_n_t_r_y_a72369a1087b2aeffe374bb054cb97c12}{day}},\ currTime.\mbox{\hyperlink{struct_t_i_m_e___e_n_t_r_y_ae5af4ff48939d13d480f87e56a9385d6}{hour}}\ +\ \mbox{\hyperlink{kernel_8c_a2d000697316631e744359a19471179c9}{ISRAEL\_UTC\_OFFSET}},\ currTime.\mbox{\hyperlink{struct_t_i_m_e___e_n_t_r_y_a8ff981ec55c945940f4a0da7d8709b3c}{minute}},\ currTime.\mbox{\hyperlink{struct_t_i_m_e___e_n_t_r_y_a8459fc4e94de7eefc74991e41779c8fc}{second}});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00243}00243\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00244}00244\ \ \ \ \ \textcolor{keywordtype}{char}\ listings[256];}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00245}00245\ \ \ \ \ status\ =\ \mbox{\hyperlink{vfs_8c_a49377ba7575cbad9c52cf142099215ce}{vfs\_listdir}}(\textcolor{stringliteral}{"{}/"{}},\ listings,\ \textcolor{keyword}{sizeof}(listings));}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00246}00246\ \ \ \ \ \mbox{\hyperlink{gop_8c_a41ff1165c1969706dadb5b409ae082e9}{gop\_printf}}(\mbox{\hyperlink{gop_8h_ad86358bf19927183dd7b4ae215a29731}{COLOR\_RED}},\ \textcolor{stringliteral}{"{}vfs\_listdir\ returned:\ \%p\(\backslash\)n"{}},\ status);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00247}00247\ \ \ \ \ \mbox{\hyperlink{gop_8c_a41ff1165c1969706dadb5b409ae082e9}{gop\_printf}}(\mbox{\hyperlink{gop_8h_ad86358bf19927183dd7b4ae215a29731}{COLOR\_RED}},\ \textcolor{stringliteral}{"{}root\ directory\ is:\ \%s\(\backslash\)n"{}},\ \mbox{\hyperlink{vfs_8c_a617bde009f0493ff340ab914aafc5b27}{vfs\_is\_dir\_empty}}(\textcolor{stringliteral}{"{}/"{}})\ ?\ \textcolor{stringliteral}{"{}Empty"{}}\ :\ \textcolor{stringliteral}{"{}Not\ Empty"{}});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00248}00248\ \ \ \ \ \mbox{\hyperlink{gop_8c_a41ff1165c1969706dadb5b409ae082e9}{gop\_printf}}(\mbox{\hyperlink{gop_8h_a82573859711fce56f1aa0a76b18a9b18}{COLOR\_CYAN}},\ \textcolor{stringliteral}{"{}\%s"{}},\ listings);}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00249}00249\ }
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00250}00250\ \ \ \ \ \mbox{\hyperlink{thread_8c_af7b3da54472a3278ae58554e8ea10bdf}{MtCreateThread}}((\mbox{\hyperlink{thread_8h_a72fcf929d51dce199593912ed4910ade}{ThreadEntry}})test,\ NULL,\ \mbox{\hyperlink{cpu__types_8h_ae0e9c6382014aa678edc81724ef4b0b8afdd226f1a0c01fe52ac70683076a662e}{DEFAULT\_TIMESLICE\_TICKS}},\ \textcolor{keyword}{true});}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00251}00251\ \ \ \ \ \textcolor{keywordtype}{int}\ integer\ =\ 1234;}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00252}00252\ \ \ \ \ \mbox{\hyperlink{thread_8c_af7b3da54472a3278ae58554e8ea10bdf}{MtCreateThread}}((\mbox{\hyperlink{thread_8h_a72fcf929d51dce199593912ed4910ade}{ThreadEntry}})funcWithParam,\ \&integer,\ \mbox{\hyperlink{cpu__types_8h_ae0e9c6382014aa678edc81724ef4b0b8afdd226f1a0c01fe52ac70683076a662e}{DEFAULT\_TIMESLICE\_TICKS}},\ \textcolor{keyword}{true});\ \textcolor{comment}{//\ I\ have\ tested\ 5+\ threads,\ works\ perfectly\ as\ it\ should.}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00253}00253\ \ \ \ \ \textcolor{comment}{/*\ Enable\ LAPIC\ Now.\ */}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00254}00254\ \ \ \ \ \mbox{\hyperlink{apic_8c_aec4be6fe8565dd53ee1f2b6567d7d3e3}{lapic\_init\_bsp}}();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00255}00255\ \ \ \ \ \mbox{\hyperlink{apic_8c_ac7b59a78aea266f1c387e64bcae6cc51}{lapic\_enable}}();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00256}00256\ \ \ \ \ \mbox{\hyperlink{apic_8c_a1e4c2eac6f54346ca8dd087e24ff420c}{init\_lapic\_timer}}(100);\ \textcolor{comment}{//\ 10ms.}}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00257}00257\ \ \ \ \ \_\_sti();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00258}00258\ \ \ \ \ \mbox{\hyperlink{scheduler_8c_a3f4dc5fcea4efe91c75e4760d804828e}{Schedule}}();}
\DoxyCodeLine{\Hypertarget{kernel_8c_source_l00259}00259\ \}}

\end{DoxyCode}

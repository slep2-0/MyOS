\doxysection{ahci.\+c}
\hypertarget{ahci_8c_source}{}\label{ahci_8c_source}\index{C:/Users/matanel/Desktop/Projects/KernelDevelopment/kernel/drivers/ahci/ahci.c@{C:/Users/matanel/Desktop/Projects/KernelDevelopment/kernel/drivers/ahci/ahci.c}}
\mbox{\hyperlink{ahci_8c}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00001}00001\ \textcolor{comment}{/*}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00002}00002\ \textcolor{comment}{\ *\ PROJECT:\ \ \ \ \ \ MatanelOS\ Kernel}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00003}00003\ \textcolor{comment}{\ *\ LICENSE:\ \ \ \ \ \ GPLv3}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00004}00004\ \textcolor{comment}{\ *\ PURPOSE:\ \ \ \ \ \ AHCI\ Driver\ Implementation.}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00005}00005\ \textcolor{comment}{\ */}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00006}00006\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00007}00007\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{ahci_8h}{ahci.h}}"{}}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00008}00008\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{assert_8h}{../../assert.h}}"{}}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00009}00009\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{mg_8h}{../../includes/mg.h}}"{}}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00010}00010\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{mm_8h}{../../includes/mm.h}}"{}}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00011}00011\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00012}00012\ \textcolor{preprocessor}{\#ifdef\ REMINDER}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00013}00013\ \textcolor{keyword}{\_Static\_assert}(\textcolor{keyword}{false},\ \textcolor{stringliteral}{"{}Reminder:\ AHCI,\ and\ other\ DMA\ stuff\ DEAL\ WITH\ PHYSICAL\ ADDRESSES\ ONLY!\ not\ virtual,\ so\ supply\ to\ them\ the\ translated\ addresses."{}});}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00014}00014\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00015}00015\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00016}00016\ \textcolor{comment}{//\#define\ AHCI\_DEBUG\_PRINT}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00017}00017\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00018}00018\ \textcolor{preprocessor}{\#ifdef\ AHCI\_DEBUG\_PRINT}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00019}00019\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ decode\_serr(uint32\_t\ serr)\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00020}00020\ \ \ \ \ \textcolor{keywordflow}{if}\ (serr\ ==\ 0)\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00021}00021\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ gop\_printf(0xFFFFFF00,\ "{}SERR:\ No\ errors\(\backslash\)n"{});}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00022}00022\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00023}00023\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00024}00024\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00025}00025\ \ \ \ \ \textcolor{comment}{//\ gop\_printf(0xFFFF0000,\ "{}SERR:\ 0x\%08x\ -\/\ Errors\ detected:\(\backslash\)n"{},\ serr);}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00026}00026\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00027}00027\ \ \ \ \ \textcolor{comment}{//\ ERR\ bits\ (0-\/15)\ -\/\ Recoverable\ and\ non-\/recoverable\ errors}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00028}00028\ \ \ \ \ \textcolor{comment}{//if\ (serr\ \&\ (1\ <<\ 0))\ \ //\ gop\_printf(0xFFFFFF00,\ "{}\ \ [0]\ ERR.I\ -\/\ Recovered\ Data\ Integrity\ Error\(\backslash\)n"{});}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00029}00029\ \ \ \ \ \textcolor{comment}{//if\ (serr\ \&\ (1\ <<\ 1))\ \ //\ gop\_printf(0xFFFFFF00,\ "{}\ \ [1]\ ERR.M\ -\/\ Recovered\ Communications\ Error\(\backslash\)n"{});}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00030}00030\ \ \ \ \ \textcolor{comment}{//if\ (serr\ \&\ (1\ <<\ 8))\ \ //\ gop\_printf(0xFFFFFF00,\ "{}\ \ [8]\ ERR.T\ -\/\ Transient\ Data\ Integrity\ Error\(\backslash\)n"{});}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00031}00031\ \ \ \ \ \textcolor{comment}{//if\ (serr\ \&\ (1\ <<\ 9))\ \ //\ gop\_printf(0xFFFFFF00,\ "{}\ \ [9]\ ERR.C\ -\/\ Persistent\ Communication/Data\ Integrity\ Error\(\backslash\)n"{});}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00032}00032\ \ \ \ \ \textcolor{comment}{//if\ (serr\ \&\ (1\ <<\ 10))\ //\ gop\_printf(0xFFFFFF00,\ "{}\ \ [10]\ ERR.P\ -\/\ Protocol\ Error\(\backslash\)n"{});}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00033}00033\ \ \ \ \ \textcolor{comment}{//if\ (serr\ \&\ (1\ <<\ 11))\ //\ gop\_printf(0xFFFFFF00,\ "{}\ \ [11]\ ERR.E\ -\/\ Internal\ Error\(\backslash\)n"{});}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00034}00034\ \ \ \ \ \textcolor{comment}{//}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00036}00036\ \ \ \ \ \textcolor{comment}{//if\ (serr\ \&\ (1\ <<\ 16))\ //\ gop\_printf(0xFFFFFF00,\ "{}\ \ [16]\ DIAG.N\ -\/\ PhyRdy\ Change\(\backslash\)n"{});}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00037}00037\ \ \ \ \ \textcolor{comment}{//if\ (serr\ \&\ (1\ <<\ 17))\ //\ gop\_printf(0xFFFFFF00,\ "{}\ \ [17]\ DIAG.I\ -\/\ Phy\ Internal\ Error\(\backslash\)n"{});}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00038}00038\ \ \ \ \ \textcolor{comment}{//if\ (serr\ \&\ (1\ <<\ 18))\ //\ gop\_printf(0xFFFFFF00,\ "{}\ \ [18]\ DIAG.W\ -\/\ Comm\ Wake\(\backslash\)n"{});}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00039}00039\ \ \ \ \ \textcolor{comment}{//if\ (serr\ \&\ (1\ <<\ 19))\ //\ gop\_printf(0xFFFFFF00,\ "{}\ \ [19]\ DIAG.B\ -\/\ 10B\ to\ 8B\ Decode\ Error\(\backslash\)n"{});}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00040}00040\ \ \ \ \ \textcolor{comment}{//if\ (serr\ \&\ (1\ <<\ 20))\ //\ gop\_printf(0xFFFFFF00,\ "{}\ \ [20]\ DIAG.D\ -\/\ Disparity\ Error\(\backslash\)n"{});}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00041}00041\ \ \ \ \ \textcolor{comment}{//if\ (serr\ \&\ (1\ <<\ 21))\ //\ gop\_printf(0xFFFFFF00,\ "{}\ \ [21]\ DIAG.C\ -\/\ CRC\ Error\(\backslash\)n"{});}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00042}00042\ \ \ \ \ \textcolor{comment}{//if\ (serr\ \&\ (1\ <<\ 22))\ //\ gop\_printf(0xFFFFFF00,\ "{}\ \ [22]\ DIAG.H\ -\/\ Handshake\ Error\(\backslash\)n"{});}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00043}00043\ \ \ \ \ \textcolor{comment}{//if\ (serr\ \&\ (1\ <<\ 23))\ //\ gop\_printf(0xFFFFFF00,\ "{}\ \ [23]\ DIAG.S\ -\/\ Link\ Sequence\ Error\(\backslash\)n"{});}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00044}00044\ \ \ \ \ \textcolor{comment}{//if\ (serr\ \&\ (1\ <<\ 24))\ //\ gop\_printf(0xFFFFFF00,\ "{}\ \ [24]\ DIAG.T\ -\/\ Transport\ State\ Transition\ Error\(\backslash\)n"{});}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00045}00045\ \ \ \ \ \textcolor{comment}{//if\ (serr\ \&\ (1\ <<\ 25))\ //\ gop\_printf(0xFFFFFF00,\ "{}\ \ [25]\ DIAG.F\ -\/\ Unknown\ FIS\ Type\(\backslash\)n"{});}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00046}00046\ \ \ \ \ \textcolor{comment}{//if\ (serr\ \&\ (1\ <<\ 26))\ //\ gop\_printf(0xFFFFFF00,\ "{}\ \ [26]\ DIAG.X\ -\/\ Exchanged\(\backslash\)n"{});}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00047}00047\ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00048}00048\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00049}00049\ \textcolor{comment}{//\ Context\ per\ initialized\ port}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00050}\mbox{\hyperlink{struct___a_h_c_i___p_o_r_t___c_t_x}{00050}}\ \textcolor{keyword}{typedef}\ \textcolor{keyword}{struct\ }\mbox{\hyperlink{struct___a_h_c_i___p_o_r_t___c_t_x}{\_AHCI\_PORT\_CTX}}\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00051}\mbox{\hyperlink{struct___a_h_c_i___p_o_r_t___c_t_x_a9c4e1ebd6b9f043649c6f18c6029f065}{00051}}\ \ \ \ \ \mbox{\hyperlink{ahci_8h_ac8d5245a93b3d91b9fa746c801c74a28}{HBA\_PORT}}*\ \mbox{\hyperlink{struct___a_h_c_i___p_o_r_t___c_t_x_a9c4e1ebd6b9f043649c6f18c6029f065}{port}};\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ MMIO\ base\ for\ this\ port}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00052}\mbox{\hyperlink{struct___a_h_c_i___p_o_r_t___c_t_x_acd12194f997e67fe450168cb8bfd29af}{00052}}\ \ \ \ \ \mbox{\hyperlink{ahci_8h_a5fd38edf79dcde4ab4b729353f99b837}{HBA\_CMD\_TBL}}*\ \mbox{\hyperlink{struct___a_h_c_i___p_o_r_t___c_t_x_acd12194f997e67fe450168cb8bfd29af}{cmd\_tbl}};\ \ \ \ \ \ \ \textcolor{comment}{//\ Command\ table\ memory}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00053}\mbox{\hyperlink{struct___a_h_c_i___p_o_r_t___c_t_x_a8a076d565ce925f96c3a4b39dd83fc21}{00053}}\ \ \ \ \ \textcolor{keywordtype}{void}*\ \mbox{\hyperlink{struct___a_h_c_i___p_o_r_t___c_t_x_a8a076d565ce925f96c3a4b39dd83fc21}{clb}};\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Cmd\ list\ buffer}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00054}\mbox{\hyperlink{struct___a_h_c_i___p_o_r_t___c_t_x_af8f8d0924a3a186e27d8f9b1499ebe76}{00054}}\ \ \ \ \ \textcolor{keywordtype}{void}*\ \mbox{\hyperlink{struct___a_h_c_i___p_o_r_t___c_t_x_af8f8d0924a3a186e27d8f9b1499ebe76}{fis}};\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ FIS\ receive\ buffer}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00055}\mbox{\hyperlink{struct___a_h_c_i___p_o_r_t___c_t_x_a15eac7f722555054361c0c089ceb07f9}{00055}}\ \ \ \ \ \mbox{\hyperlink{block_8h_a1e03bdef1501e96036b676dc18e71787}{BLOCK\_DEVICE}}\ \mbox{\hyperlink{struct___a_h_c_i___p_o_r_t___c_t_x_a15eac7f722555054361c0c089ceb07f9}{bdev}};\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Associated\ BLOCK\_DEVICE\ interface}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00056}\mbox{\hyperlink{ahci_8c_a826ec3f5221e81ed24f55d01073491a4}{00056}}\ \}\ \mbox{\hyperlink{ahci_8c_a826ec3f5221e81ed24f55d01073491a4}{AHCI\_PORT\_CTX}};}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00057}00057\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00058}00058\ \textcolor{keyword}{static}\ \mbox{\hyperlink{ahci_8h_ae5f2dfa1afa0c14d4de2cb55400b1f37}{HBA\_MEM}}*\ hba\_mem;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00059}00059\ \textcolor{keyword}{static}\ \mbox{\hyperlink{ahci_8c_a826ec3f5221e81ed24f55d01073491a4}{AHCI\_PORT\_CTX}}\ ports[\mbox{\hyperlink{ahci_8h_a21dfe7d03e0027f3c2e4a1bc81e8d85a}{AHCI\_MAX\_PORTS}}];}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00060}00060\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{int}\ port\_count;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00061}00061\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00062}00062\ \textcolor{comment}{//\ Invalidate\ cache\ ranges\ of\ the\ CPU\ to\ ensure\ newest\ data\ is\ fetched\ from\ RAM.}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00063}00063\ \textcolor{keyword}{static}\ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{void}\ cache\_flush\_invalidate\_range(\textcolor{keywordtype}{void}*\ addr,\ \textcolor{keywordtype}{size\_t}\ len)\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00064}00064\ \ \ \ \ uintptr\_t\ p\ =\ (uintptr\_t)addr\ \&\ \string~(uintptr\_t)63;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00065}00065\ \ \ \ \ uintptr\_t\ end\ =\ (uintptr\_t)addr\ +\ len;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00066}00066\ \ \ \ \ \textcolor{keywordflow}{for}\ (;\ p\ <\ end;\ p\ +=\ 64)\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00067}00067\ \ \ \ \ \ \ \ \ \_\_asm\_\_\ \textcolor{keyword}{volatile}(\textcolor{stringliteral}{"{}clflush\ (\%0)"{}}\ ::\ \textcolor{stringliteral}{"{}r"{}}((\textcolor{keywordtype}{void}*)p)\ :\ \textcolor{stringliteral}{"{}memory"{}});}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00068}00068\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00069}00069\ \ \ \ \ \_\_asm\_\_\ \textcolor{keyword}{volatile}(\textcolor{stringliteral}{"{}mfence"{}}\ :::\ \textcolor{stringliteral}{"{}memory"{}});}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00070}00070\ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00071}00071\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00072}00072\ \textcolor{keyword}{static}\ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{void}\ outl\_port(uint16\_t\ port,\ uint32\_t\ val)\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00073}00073\ \ \ \ \ \_\_asm\_\_\ \textcolor{keyword}{volatile}(\textcolor{stringliteral}{"{}outl\ \%0,\ \%1"{}}\ ::\ \textcolor{stringliteral}{"{}a"{}}(val),\ \textcolor{stringliteral}{"{}d"{}}(port));}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00074}00074\ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00075}00075\ \textcolor{keyword}{static}\ \textcolor{keyword}{inline}\ uint32\_t\ inl\_port(uint16\_t\ port)\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00076}00076\ \ \ \ \ uint32\_t\ val;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00077}00077\ \ \ \ \ \_\_asm\_\_\ \textcolor{keyword}{volatile}(\textcolor{stringliteral}{"{}inl\ \%1,\ \%0"{}}\ :\ \textcolor{stringliteral}{"{}=a"{}}(val)\ :\ \textcolor{stringliteral}{"{}d"{}}(port));}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00078}00078\ \ \ \ \ \textcolor{keywordflow}{return}\ val;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00079}00079\ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00080}00080\ \textcolor{keyword}{static}\ uint32\_t\ pci\_cfg\_read32(uint8\_t\ bus,\ uint8\_t\ slot,\ uint8\_t\ func,\ uint8\_t\ offset)\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00081}00081\ \ \ \ \ uint32\_t\ addr\ =\ (1u\ <<\ 31)\ |\ ((uint32\_t)bus\ <<\ 16)\ |\ ((uint32\_t)slot\ <<\ 11)\ |}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00082}00082\ \ \ \ \ \ \ \ \ ((uint32\_t)func\ <<\ 8)\ |\ (offset\ \&\ 0xFC);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00083}00083\ \ \ \ \ outl\_port(0xCF8,\ addr);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00084}00084\ \ \ \ \ \textcolor{keywordflow}{return}\ inl\_port(0xCFC);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00085}00085\ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00086}00086\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ pci\_cfg\_write32(uint8\_t\ bus,\ uint8\_t\ slot,\ uint8\_t\ func,\ uint8\_t\ offset,\ uint32\_t\ val)\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00087}00087\ \ \ \ \ uint32\_t\ addr\ =\ (1u\ <<\ 31)\ |\ ((uint32\_t)bus\ <<\ 16)\ |\ ((uint32\_t)slot\ <<\ 11)\ |}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00088}00088\ \ \ \ \ \ \ \ \ ((uint32\_t)func\ <<\ 8)\ |\ (offset\ \&\ 0xFC);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00089}00089\ \ \ \ \ outl\_port(0xCF8,\ addr);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00090}00090\ \ \ \ \ outl\_port(0xCFC,\ val);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00091}00091\ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00092}00092\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00093}00093\ \textcolor{comment}{//\ Scans\ PCI\ buses\ and\ enables\ Bus\ Master\ bit\ for\ first\ AHCI\ class\ device\ found.}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00094}00094\ \textcolor{comment}{//\ Call\ this\ at\ start\ of\ ahci\_init()\ before\ enable\_controller().}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00095}00095\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ ensure\_ahci\_busmaster\_enabled(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00096}00096\ \ \ \ \ \textcolor{keywordflow}{for}\ (uint8\_t\ bus\ =\ 0;\ bus\ <\ 8;\ ++bus)\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00097}00097\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (uint8\_t\ slot\ =\ 0;\ slot\ <\ 32;\ ++slot)\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00098}00098\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (uint8\_t\ func\ =\ 0;\ func\ <\ 8;\ ++func)\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00099}00099\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ uint32\_t\ d0\ =\ pci\_cfg\_read32(bus,\ slot,\ func,\ 0x00);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00100}00100\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ((d0\ \&\ 0xFFFF)\ ==\ 0xFFFF)\ \textcolor{keywordflow}{continue};\ \textcolor{comment}{//\ no\ device}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00101}00101\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ uint32\_t\ cl\ =\ pci\_cfg\_read32(bus,\ slot,\ func,\ 0x08);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00102}00102\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ uint8\_t\ base\_class\ =\ (cl\ >>\ 24)\ \&\ 0xFF;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00103}00103\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ uint8\_t\ sub\_class\ =\ (cl\ >>\ 16)\ \&\ 0xFF;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00104}00104\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ uint8\_t\ prog\_if\ =\ (cl\ >>\ 8)\ \&\ 0xFF;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00105}00105\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (base\_class\ ==\ 0x01\ \&\&\ sub\_class\ ==\ 0x06\ \&\&\ prog\_if\ ==\ 0x01)\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00106}00106\ \textcolor{preprocessor}{\#ifdef\ AHCI\_DEBUG\_PRINT}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00107}00107\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ uint32\_t\ hdr\ =\ pci\_cfg\_read32(bus,\ slot,\ func,\ 0x00);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00108}00108\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ uint16\_t\ vendor\ =\ hdr\ \&\ 0xFFFF;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00109}00109\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ uint16\_t\ device\ =\ (hdr\ >>\ 16)\ \&\ 0xFFFF;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00110}00110\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00111}00111\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ uint32\_t\ cmd32\ =\ pci\_cfg\_read32(bus,\ slot,\ func,\ 0x04);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00112}00112\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ uint16\_t\ cmd\ =\ cmd32\ \&\ 0xFFFF;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00113}00113\ \textcolor{preprocessor}{\#ifdef\ AHCI\_DEBUG\_PRINT}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00114}00114\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ gop\_printf(0xFFFFFF00,\ "{}AHCI\ PCI\ at\ \%p:\%p\ vendor=\%p\ device=\%p\(\backslash\)n"{},\ bus,\ slot,\ func,\ vendor,\ device);}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00115}00115\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ gop\_printf(0xFFFFFF00,\ "{}PCI\ CMD\ before:\ \%p\(\backslash\)n"{},\ cmd);}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00116}00116\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00117}00117\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!(cmd\ \&\ (1\ <<\ 2)))\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00118}00118\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ cmd\ |=\ (1\ <<\ 2);\ \textcolor{comment}{//\ set\ Bus\ Master}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00119}00119\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pci\_cfg\_write32(bus,\ slot,\ func,\ 0x04,\ (cmd32\ \&\ 0xFFFF0000)\ |\ (uint32\_t)cmd);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00120}00120\ \textcolor{preprocessor}{\#ifdef\ AHCI\_DEBUG\_PRINT}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00121}00121\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ gop\_printf(0xFFFFFF00,\ "{}Enabled\ PCI\ Bus\ Master\ bit\ for\ AHCI\(\backslash\)n"{});}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00122}00122\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00123}00123\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00124}00124\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00125}00125\ \textcolor{preprocessor}{\#ifdef\ AHCI\_DEBUG\_PRINT}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00126}00126\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ gop\_printf(0xFFFFFF00,\ "{}PCI\ Bus\ Master\ already\ enabled\(\backslash\)n"{});}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00127}00127\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00128}00128\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00129}00129\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00130}00130\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00131}00131\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00132}00132\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00133}00133\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00134}00134\ \textcolor{preprocessor}{\#ifdef\ AHCI\_DEBUG\_PRINT}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00135}00135\ \ \ \ \ \textcolor{comment}{//\ gop\_printf(0xFFFF0000,\ "{}AHCI\ PCI\ device\ not\ found\ while\ scanning\ PCI\ bus\(\backslash\)n"{});}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00136}00136\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00137}00137\ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00138}00138\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00144}00144\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{int}\ find\_free\_slot(uint32\_t\ mask)\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00145}00145\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ 32;\ i++)\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00146}00146\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!(mask\ \&\ (1u\ <<\ i)))\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00147}00147\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ i;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00148}00148\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00149}00149\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00150}00150\ \ \ \ \ \textcolor{keywordflow}{return}\ -\/1;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00151}00151\ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00152}00152\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00156}00156\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ enable\_controller(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00157}00157\ \ \ \ \ hba\_mem-\/>ghc\ |=\ (1u\ <<\ 31);\ \textcolor{comment}{//\ AHCI\ Enable.}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00158}00158\ \ \ \ \ hba\_mem-\/>ghc\ |=\ (1u\ <<\ 0);\ \textcolor{comment}{//\ Global\ Reset.}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00160}00160\ \ \ \ \ \textcolor{keywordflow}{while}\ (hba\_mem-\/>ghc\ \&\ (1u\ <<\ 0));}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00161}00161\ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00162}00162\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00168}00168\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{bool}\ init\_one\_port(\textcolor{keywordtype}{int}\ idx)\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00169}00169\ \ \ \ \ \mbox{\hyperlink{ahci_8h_ac8d5245a93b3d91b9fa746c801c74a28}{HBA\_PORT}}*\ p\ =\ (\mbox{\hyperlink{ahci_8h_ac8d5245a93b3d91b9fa746c801c74a28}{HBA\_PORT}}*)((uint8\_t*)hba\_mem\ +\ 0x100\ +\ idx\ *\ 0x80);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00170}00170\ \ \ \ \ uint32\_t\ status\ =\ p-\/>\mbox{\hyperlink{struct___h_b_a___p_o_r_t_a20e79ef71adff15c5481b97a2b8fb546}{ssts}};}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00171}00171\ \ \ \ \ \textcolor{keywordflow}{if}\ ((status\ \&\ 0x0F)\ !=\ 3)\ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};\ \textcolor{comment}{//\ no\ device\ present}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00172}00172\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00173}00173\ \ \ \ \ \textcolor{comment}{//\ Stop\ the\ port\ before\ configuration}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00174}00174\ \ \ \ \ p-\/>\mbox{\hyperlink{struct___h_b_a___p_o_r_t_a5e9712b08d7cbf6091f9e5334ff97b5d}{cmd}}\ \&=\ \string~(1u\ <<\ 0);\ \textcolor{comment}{//\ Clear\ ST\ (START)}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00175}00175\ \ \ \ \ p-\/>\mbox{\hyperlink{struct___h_b_a___p_o_r_t_a5e9712b08d7cbf6091f9e5334ff97b5d}{cmd}}\ \&=\ \string~(1u\ <<\ 4);\ \textcolor{comment}{//\ Clear\ PRE\ (FIS\ Receive\ Enable)}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00176}00176\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00177}00177\ \ \ \ \ \textcolor{comment}{//\ Wait\ until\ port\ is\ idle}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00178}00178\ \ \ \ \ \textcolor{keywordflow}{while}\ ((p-\/>\mbox{\hyperlink{struct___h_b_a___p_o_r_t_a5e9712b08d7cbf6091f9e5334ff97b5d}{cmd}}\ \&\ (1u\ <<\ 15))\ ||\ (p-\/>\mbox{\hyperlink{struct___h_b_a___p_o_r_t_a5e9712b08d7cbf6091f9e5334ff97b5d}{cmd}}\ \&\ (1u\ <<\ 14)))\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00179}00179\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{intrin_8h_a26e3a63842c3c5f7d7b97a5c2d786e41}{\_\_pause}}();}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00180}00180\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00181}00181\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00182}00182\ \ \ \ \ \textcolor{comment}{//\ Allocate\ and\ zero\ CLB\ (1\ KiB)}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00183}00183\ \ \ \ \ \textcolor{keywordtype}{void}*\ clb\ =\ \mbox{\hyperlink{mmio_8c_ac78ff048b41c520d5b2f9cd176dfce2b}{MmAllocateContigiousMemory}}(1024,\ \mbox{\hyperlink{macros_8h_ae67fce0de32a6e75b649711af83a0d6e}{UINT64\_T\_MAX}});}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00184}00184\ \ \ \ \ \textcolor{keywordflow}{if}\ (!clb)\ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00185}00185\ \ \ \ \ \mbox{\hyperlink{mm_8h_a7d9455da4f2ec94a98286a19e7d8e39d}{kmemset}}(clb,\ 0,\ 1024);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00186}00186\ \ \ \ \ \textcolor{comment}{//\ pass\ the\ PHYSICAL\ address.}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00187}00187\ \ \ \ \ uintptr\_t\ clb\_phys\ =\ \mbox{\hyperlink{map_8c_a29e582a0230e8396492f0620023f0ae5}{MiTranslateVirtualToPhysical}}(clb);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00188}00188\ \ \ \ \ \mbox{\hyperlink{assert_8h_a3d4ae9c092e117c836f52dc7d7cee574}{assert}}(((uintptr\_t)clb\_phys\ \&\ 0x3FF)\ ==\ 0,\ \textcolor{stringliteral}{"{}CLB\ must\ be\ 1KiB-\/aligned\ (1024\ byte\ multiple)"{}});}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00189}00189\ \textcolor{preprocessor}{\#ifdef\ AHCI\_DEBUG\_PRINT}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00190}00190\ \ \ \ \ \textcolor{comment}{//\ gop\_printf(COLOR\_BLUE,\ "{}In\ INIT\_ONE\_PORT,\ clb\_phys:\ \%p\ |\ virt:\ \%p\(\backslash\)n"{},\ clb\_phys,\ clb);}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00191}00191\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00192}00192\ \ \ \ \ p-\/>\mbox{\hyperlink{struct___h_b_a___p_o_r_t_a2fd95d5d04d61114c60b2c16fc908e41}{clb}}\ =\ (uint32\_t)(uintptr\_t)clb\_phys;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00193}00193\ \ \ \ \ p-\/>\mbox{\hyperlink{struct___h_b_a___p_o_r_t_a846391766b0bde62d390c6514ee575d2}{clbu}}\ =\ (uint32\_t)((uintptr\_t)clb\_phys\ >>\ 32);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00194}00194\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00195}00195\ \ \ \ \ \textcolor{comment}{//\ Allocate\ and\ zero\ FIS\ receive\ buffer\ (256\ B)}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00196}00196\ \ \ \ \ \textcolor{keywordtype}{void}*\ fis\_buf\ =\ \mbox{\hyperlink{mmio_8c_ac78ff048b41c520d5b2f9cd176dfce2b}{MmAllocateContigiousMemory}}(256,\ \mbox{\hyperlink{macros_8h_ae67fce0de32a6e75b649711af83a0d6e}{UINT64\_T\_MAX}});}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00197}00197\ \ \ \ \ \textcolor{keywordflow}{if}\ (!fis\_buf)\ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00198}00198\ \ \ \ \ \mbox{\hyperlink{mm_8h_a7d9455da4f2ec94a98286a19e7d8e39d}{kmemset}}(fis\_buf,\ 0,\ 256);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00199}00199\ \ \ \ \ \textcolor{comment}{//\ Again,\ pass\ the\ PHYSICAL.}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00200}00200\ \ \ \ \ uintptr\_t\ fis\_buf\_phys\ =\ \mbox{\hyperlink{map_8c_a29e582a0230e8396492f0620023f0ae5}{MiTranslateVirtualToPhysical}}(fis\_buf);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00201}00201\ \textcolor{preprocessor}{\#ifdef\ AHCI\_DEBUG\_PRINT}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00202}00202\ \ \ \ \ \textcolor{comment}{//\ gop\_printf(COLOR\_BLUE,\ "{}In\ INIT\_ONE\_PORT,\ fis\_buf\_phys:\ \%p\ |\ virt:\ \%p\(\backslash\)n"{},\ fis\_buf\_phys,\ fis\_buf);}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00203}00203\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00204}00204\ \ \ \ \ p-\/>\mbox{\hyperlink{struct___h_b_a___p_o_r_t_a38a54fe370e6c01108abfb4fdaf693e6}{fb}}\ =\ (uint32\_t)(uintptr\_t)fis\_buf\_phys;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00205}00205\ \ \ \ \ p-\/>\mbox{\hyperlink{struct___h_b_a___p_o_r_t_a496af14f1d8470a17f862aa1e43cd3b2}{fbu}}\ =\ (uint32\_t)((uintptr\_t)fis\_buf\_phys\ >>\ 32);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00206}00206\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00207}00207\ \ \ \ \ \textcolor{comment}{//\ Allocate\ and\ zero\ Command\ Table\ buffers:\ 256\ B\ × 32\ slots}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00208}00208\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ tbl\_size\ =\ 256\ *\ 32;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00209}00209\ \ \ \ \ \textcolor{keywordtype}{void}*\ cmd\_tbl\ =\ \mbox{\hyperlink{mmio_8c_ac78ff048b41c520d5b2f9cd176dfce2b}{MmAllocateContigiousMemory}}(tbl\_size,\ \mbox{\hyperlink{macros_8h_ae67fce0de32a6e75b649711af83a0d6e}{UINT64\_T\_MAX}});}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00210}00210\ \ \ \ \ \textcolor{keywordflow}{if}\ (!cmd\_tbl)\ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00211}00211\ \ \ \ \ \mbox{\hyperlink{mm_8h_a7d9455da4f2ec94a98286a19e7d8e39d}{kmemset}}(cmd\_tbl,\ 0,\ tbl\_size);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00212}00212\ \ \ \ \ uintptr\_t\ cmd\_tbl\_phys\ =\ \mbox{\hyperlink{map_8c_a29e582a0230e8396492f0620023f0ae5}{MiTranslateVirtualToPhysical}}(cmd\_tbl);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00213}00213\ \ \ \ \ \mbox{\hyperlink{assert_8h_a3d4ae9c092e117c836f52dc7d7cee574}{assert}}(((uintptr\_t)cmd\_tbl\_phys\ \&\ 0xFF)\ ==\ 0,\ \textcolor{stringliteral}{"{}Command\ table\ block\ must\ be\ 256-\/byte\ aligned"{}});}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00214}00214\ \textcolor{preprocessor}{\#ifdef\ AHCI\_DEBUG\_PRINT}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00215}00215\ \ \ \ \ \textcolor{comment}{//\ gop\_printf(COLOR\_BLUE,\ "{}In\ INIT\_ONE\_PORT,\ cmd\_tbl\_phys:\ \%p\ |\ virt:\ \%p\(\backslash\)n"{},\ cmd\_tbl\_phys,\ cmd\_tbl);}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00216}00216\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00217}00217\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00218}00218\ \ \ \ \ \textcolor{comment}{//\ Point\ each\ command\ header\ to\ its\ table}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00219}00219\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ slot\ =\ 0;\ slot\ <\ 32;\ slot++)\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00220}00220\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Header\ at\ clb\ +\ slot*32\ bytes}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00221}00221\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{ahci_8h_aa42f2e54bb5ba9a97507d17ac6203e06}{HBA\_CMD\_HEADER}}*\ hdr\ =\ (\mbox{\hyperlink{ahci_8h_aa42f2e54bb5ba9a97507d17ac6203e06}{HBA\_CMD\_HEADER}}*)((uint8\_t*)clb\ +\ slot\ *\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{ahci_8h_aa42f2e54bb5ba9a97507d17ac6203e06}{HBA\_CMD\_HEADER}}));}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00222}00222\ \ \ \ \ \ \ \ \ uintptr\_t\ tbl\_pa\_phys\ =\ (uintptr\_t)cmd\_tbl\_phys\ +\ slot\ *\ 256;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00223}00223\ \ \ \ \ \ \ \ \ hdr-\/>\mbox{\hyperlink{struct___h_b_a___c_m_d___h_e_a_d_e_r_a7b9e83f2a21a5acc68d70b04b012d6d2}{ctba}}\ =\ (uint32\_t)(tbl\_pa\_phys\ \&\ 0xFFFFFFFF);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00224}00224\ \ \ \ \ \ \ \ \ hdr-\/>\mbox{\hyperlink{struct___h_b_a___c_m_d___h_e_a_d_e_r_a0fb060abb54a57da672c1fd9603e0c12}{ctbau}}\ =\ (uint32\_t)(tbl\_pa\_phys\ >>\ 32);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00225}00225\ \ \ \ \ \ \ \ \ hba\_cmd\_hdr\_set\_prdtl(hdr,\ 1);\ \textcolor{comment}{//\ one\ PRDT\ entry}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00226}00226\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00227}00227\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00228}00228\ \ \ \ \ \textcolor{comment}{//\ Clear\ any\ old\ errors\ and\ start\ the\ port}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00229}00229\ \ \ \ \ p-\/>\mbox{\hyperlink{struct___h_b_a___p_o_r_t_aac086c44fba913e33d5d4480166f486f}{serr}}\ =\ \string~0U;\ \textcolor{comment}{//\ Clear\ all\ SERROR\ bits\ by\ writing\ 1\ to\ them.}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00230}00230\ \ \ \ \ p-\/>\mbox{\hyperlink{struct___h_b_a___p_o_r_t_a5e9712b08d7cbf6091f9e5334ff97b5d}{cmd}}\ |=\ (1u\ <<\ 4);\ \textcolor{comment}{//\ Set\ FRE}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00231}00231\ \ \ \ \ p-\/>\mbox{\hyperlink{struct___h_b_a___p_o_r_t_a5e9712b08d7cbf6091f9e5334ff97b5d}{cmd}}\ |=\ (1u\ <<\ 0);\ \textcolor{comment}{//\ Set\ ST}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00232}00232\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00233}00233\ \ \ \ \ \textcolor{comment}{//\ Add\ this\ assertion\ to\ ensure\ the\ port\ actually\ starts}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00234}00234\ \ \ \ \ \mbox{\hyperlink{assert_8h_a3d4ae9c092e117c836f52dc7d7cee574}{assert}}((p-\/>\mbox{\hyperlink{struct___h_b_a___p_o_r_t_a5e9712b08d7cbf6091f9e5334ff97b5d}{cmd}}\ \&\ 1)\ !=\ 0,\ \textcolor{stringliteral}{"{}Port\ ST\ bit\ failed\ to\ set!"{}});}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00235}00235\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00236}00236\ \ \ \ \ \textcolor{comment}{//\ Save\ context}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00237}00237\ \ \ \ \ \mbox{\hyperlink{ahci_8c_a826ec3f5221e81ed24f55d01073491a4}{AHCI\_PORT\_CTX}}*\ ctx\ =\ \&ports[port\_count];}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00238}00238\ \ \ \ \ ctx-\/>\mbox{\hyperlink{struct___a_h_c_i___p_o_r_t___c_t_x_a9c4e1ebd6b9f043649c6f18c6029f065}{port}}\ =\ p;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00239}00239\ \ \ \ \ ctx-\/>\mbox{\hyperlink{struct___a_h_c_i___p_o_r_t___c_t_x_a8a076d565ce925f96c3a4b39dd83fc21}{clb}}\ =\ clb;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00240}00240\ \ \ \ \ ctx-\/>\mbox{\hyperlink{struct___a_h_c_i___p_o_r_t___c_t_x_af8f8d0924a3a186e27d8f9b1499ebe76}{fis}}\ =\ fis\_buf;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00241}00241\ \ \ \ \ ctx-\/>\mbox{\hyperlink{struct___a_h_c_i___p_o_r_t___c_t_x_acd12194f997e67fe450168cb8bfd29af}{cmd\_tbl}}\ =\ cmd\_tbl;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00242}00242\ \ \ \ \ ctx-\/>\mbox{\hyperlink{struct___a_h_c_i___p_o_r_t___c_t_x_a15eac7f722555054361c0c089ceb07f9}{bdev}}.\mbox{\hyperlink{struct___b_l_o_c_k___d_e_v_i_c_e_a8e37cfed3f193b5e4a151570d4a9ec05}{read\_sector}}\ =\ \mbox{\hyperlink{ahci_8c_ace09d7c971766cc2b7aba7c06032f781}{ahci\_read\_sector}};}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00243}00243\ \ \ \ \ ctx-\/>\mbox{\hyperlink{struct___a_h_c_i___p_o_r_t___c_t_x_a15eac7f722555054361c0c089ceb07f9}{bdev}}.\mbox{\hyperlink{struct___b_l_o_c_k___d_e_v_i_c_e_ac868ac234910b1a924bbdc3e931006a7}{write\_sector}}\ =\ \mbox{\hyperlink{ahci_8c_a71a8e835dddd5b57babc5f00de3e0623}{ahci\_write\_sector}};}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00244}00244\ \ \ \ \ ctx-\/>\mbox{\hyperlink{struct___a_h_c_i___p_o_r_t___c_t_x_a15eac7f722555054361c0c089ceb07f9}{bdev}}.\mbox{\hyperlink{struct___b_l_o_c_k___d_e_v_i_c_e_a640bb2cf7d104dc9f801e9820d5526f8}{dev\_data}}\ =\ ctx;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00245}00245\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00246}00246\ \ \ \ \ \textcolor{comment}{/*\ CAP\ and\ slot\ counts\ */}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00247}00247\ \textcolor{preprocessor}{\#ifdef\ AHCI\_DEBUG\_PRINT}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00248}00248\ \ \ \ \ uint32\_t\ cap\ =\ (uint32\_t)hba\_mem-\/>cap;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00249}00249\ \ \ \ \ uint32\_t\ ncs\ =\ (cap\ >>\ 8)\ \&\ 0x1Fu;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00250}00250\ \ \ \ \ \mbox{\hyperlink{assert_8h_a3d4ae9c092e117c836f52dc7d7cee574}{assert}}(((ncs\ +\ 1)\ >=\ 1)\ \&\&\ ((ncs\ +\ 1)\ <=\ 32),\ \textcolor{stringliteral}{"{}CAP.NCS\ invalid\ (command\ slots\ out\ of\ range)"{}});}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00251}00251\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00252}00252\ \ \ \ \ \textcolor{keywordtype}{bool}\ s64a\ =\ !!((cap\ >>\ 31)\ \&\ 1u);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00253}00253\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00254}00254\ \ \ \ \ \textcolor{comment}{/*\ Alignment\ checks\ */}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00255}00255\ \ \ \ \ \mbox{\hyperlink{assert_8h_a3d4ae9c092e117c836f52dc7d7cee574}{assert}}(((uintptr\_t)clb\_phys\ \&\ 0x3FF)\ ==\ 0,\ \textcolor{stringliteral}{"{}PxCLB\ must\ be\ 1KiB-\/aligned\ (1024\ bytes)"{}});}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00256}00256\ \ \ \ \ \mbox{\hyperlink{assert_8h_a3d4ae9c092e117c836f52dc7d7cee574}{assert}}(((uintptr\_t)fis\_buf\_phys\ \&\ 0xFF)\ ==\ 0,\ \textcolor{stringliteral}{"{}PxFB\ (FIS)\ must\ be\ 256-\/byte\ aligned"{}});}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00257}00257\ \ \ \ \ \mbox{\hyperlink{assert_8h_a3d4ae9c092e117c836f52dc7d7cee574}{assert}}(((uintptr\_t)cmd\_tbl\_phys\ \&\ 0xFF)\ ==\ 0,\ \textcolor{stringliteral}{"{}Command\ table\ region\ must\ start\ at\ 256-\/byte\ boundary"{}});}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00258}00258\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00259}00259\ \ \ \ \ \textcolor{comment}{/*\ 64-\/bit\ addressing:\ if\ device\ doesn't\ advertise\ S64A,\ upper\ bits\ must\ be\ zero\ */}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00260}00260\ \ \ \ \ \textcolor{keywordflow}{if}\ (!s64a)\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00261}00261\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{assert_8h_a3d4ae9c092e117c836f52dc7d7cee574}{assert}}(((uintptr\_t)clb\_phys\ >>\ 32)\ ==\ 0,\ \textcolor{stringliteral}{"{}CLB\ high\ dword\ must\ be\ zero\ when\ CAP.S64A==0"{}});}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00262}00262\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{assert_8h_a3d4ae9c092e117c836f52dc7d7cee574}{assert}}(((uintptr\_t)cmd\_tbl\_phys\ >>\ 32)\ ==\ 0,\ \textcolor{stringliteral}{"{}CMD\_TBL\ high\ dword\ must\ be\ zero\ when\ CAP.S64A==0"{}});}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00263}00263\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{assert_8h_a3d4ae9c092e117c836f52dc7d7cee574}{assert}}(((uintptr\_t)fis\_buf\_phys\ >>\ 32)\ ==\ 0,\ \textcolor{stringliteral}{"{}FIS\ high\ dword\ must\ be\ zero\ when\ CAP.S64A==0"{}});}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00264}00264\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00265}00265\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00266}00266\ \ \ \ \ \textcolor{comment}{/*\ Per-\/header\ CTBA\ programmed\ correctly\ (for\ the\ number\ of\ slots\ the\ HBA\ advertises)\ */}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00267}00267\ \textcolor{preprocessor}{\#ifdef\ AHCI\_DEBUG\_PRINT}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00268}00268\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{unsigned}\ sl\ =\ 0;\ sl\ <=\ ncs;\ ++sl)\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00269}00269\ \textcolor{preprocessor}{\#ifdef\ DEBUG}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00270}00270\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{ahci_8h_aa42f2e54bb5ba9a97507d17ac6203e06}{HBA\_CMD\_HEADER}}*\ hdr\ =\ (\mbox{\hyperlink{ahci_8h_aa42f2e54bb5ba9a97507d17ac6203e06}{HBA\_CMD\_HEADER}}*)((uint8\_t*)clb\ +\ sl\ *\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{ahci_8h_aa42f2e54bb5ba9a97507d17ac6203e06}{HBA\_CMD\_HEADER}}));}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00271}00271\ \ \ \ \ \ \ \ \ uintptr\_t\ expected\ =\ (uintptr\_t)cmd\_tbl\_phys\ +\ sl\ *\ 256;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00272}00272\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00273}00273\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{assert_8h_a3d4ae9c092e117c836f52dc7d7cee574}{assert}}(hdr-\/>\mbox{\hyperlink{struct___h_b_a___c_m_d___h_e_a_d_e_r_a7b9e83f2a21a5acc68d70b04b012d6d2}{ctba}}\ ==\ (uint32\_t)(expected\ \&\ 0xFFFFFFFFu),\ \textcolor{stringliteral}{"{}Header\ CTBA\ low\ doesn't\ match\ expected\ CTBA"{}});}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00274}00274\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (s64a)\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00275}00275\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{assert_8h_a3d4ae9c092e117c836f52dc7d7cee574}{assert}}(hdr-\/>\mbox{\hyperlink{struct___h_b_a___c_m_d___h_e_a_d_e_r_a0fb060abb54a57da672c1fd9603e0c12}{ctbau}}\ ==\ (uint32\_t)(expected\ >>\ 32),\ \textcolor{stringliteral}{"{}Header\ CTBAU\ mismatch\ (S64A\ advertised)"{}});}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00276}00276\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00277}00277\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00278}00278\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{assert_8h_a3d4ae9c092e117c836f52dc7d7cee574}{assert}}(hdr-\/>\mbox{\hyperlink{struct___h_b_a___c_m_d___h_e_a_d_e_r_a0fb060abb54a57da672c1fd9603e0c12}{ctbau}}\ ==\ 0,\ \textcolor{stringliteral}{"{}Header\ CTBAU\ must\ be\ zero\ when\ S64A==0"{}});}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00279}00279\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00280}00280\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00281}00281\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00282}00282\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00283}00283\ \ \ \ \ port\_count++;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00284}00284\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00285}00285\ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00286}00286\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00287}00287\ \textcolor{keyword}{extern}\ \mbox{\hyperlink{efi_8h_aa7f93145770b2b55fa44fc8b9a2cf58d}{BOOT\_INFO}}\ \mbox{\hyperlink{acpi_8c_a5f06053b8248ece91f68e4ae8da74ee4}{boot\_info\_local}};}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00288}00288\ \textcolor{keyword}{extern}\ \mbox{\hyperlink{efi_8h_a76f436ea56fd593cab07a6800d630828}{GOP\_PARAMS}}\ \mbox{\hyperlink{bugcheck_8c_ad8ca0be32b831aec9de80bcf0e22107e}{gop\_local}};}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00289}00289\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00290}\mbox{\hyperlink{ahci_8c_a1ed835aaf13aa614433110d49cfa556d}{00290}}\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{ahci_8c_a1ed835aaf13aa614433110d49cfa556d}{ahci\_initialized}}\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00291}00291\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00292}\mbox{\hyperlink{ahci_8c_a237a75df76bac12d7652004b7f579692}{00292}}\ \mbox{\hyperlink{mtstatus_8h_a7c794b38d203a5b842f27b12fb55495a}{MTSTATUS}}\ \mbox{\hyperlink{ahci_8c_a237a75df76bac12d7652004b7f579692}{ahci\_init}}(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00293}00293\ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{ahci_8c_a1ed835aaf13aa614433110d49cfa556d}{ahci\_initialized}})\ \{\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{mtstatus_8h_a147849337a41d8be9ccb4ef599b84a86}{MT\_SUCCESS}};\ \}\ \textcolor{comment}{//\ gop\_printf(COLOR\_RED,\ "{}AHCI\ Initialization\ got\ called\ again\ when\ already\ init.\(\backslash\)n"{});\ return\ MT\_SUCCESS;\ \}}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00294}00294\ \ \ \ \ \textcolor{comment}{//\ Use\ BootInfo\ PCI\ BARs.}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00295}00295\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ \mbox{\hyperlink{acpi_8c_a5f06053b8248ece91f68e4ae8da74ee4}{boot\_info\_local}}.AhciCount;\ i++)\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00296}00296\ \ \ \ \ \ \ \ \ uint64\_t\ base\ =\ \mbox{\hyperlink{acpi_8c_a5f06053b8248ece91f68e4ae8da74ee4}{boot\_info\_local}}.AhciBarBases[i];}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00297}00297\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{void}*\ virt\ =\ \mbox{\hyperlink{mmio_8c_a4939c6c7723219a53552746a8b716657}{MmMapIoSpace}}(base,\ \mbox{\hyperlink{mm_8h_acf0ee72c65911c54a418ccefba70ee77}{VirtualPageSize}},\ \mbox{\hyperlink{mm_8h_a401a925f8ec84579861731dc6b84c80aa5f1808dcde28bcfed35e0e4a88db421f}{MmNonCached}});}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00298}00298\ \textcolor{preprocessor}{\#ifdef\ AHCI\_DEBUG\_PRINT}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00299}00299\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ gop\_printf(COLOR\_ORANGE,\ "{}Address\ of\ AHCI\ BAR\ \%u\ (\%p)\ is:\ \%s\(\backslash\)n"{},\ i,\ virt,\ MmIsAddressPresent((uintptr\_t)virt)\ ?\ "{}Valid"{}\ :\ "{}Invalid"{});}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00300}00300\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00301}00301\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Now\ change\ the\ values\ in\ the\ struct}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00302}00302\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{acpi_8c_a5f06053b8248ece91f68e4ae8da74ee4}{boot\_info\_local}}.AhciBarBases[i]\ =\ (uint64\_t)virt;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00303}00303\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00304}00304\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00305}00305\ \ \ \ \ uint64\_t\ bar\ =\ \mbox{\hyperlink{acpi_8c_a5f06053b8248ece91f68e4ae8da74ee4}{boot\_info\_local}}.AhciBarBases[0];}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00306}00306\ \ \ \ \ hba\_mem\ =\ (\mbox{\hyperlink{ahci_8h_ae5f2dfa1afa0c14d4de2cb55400b1f37}{HBA\_MEM}}*)(uintptr\_t)bar;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00307}00307\ \textcolor{preprocessor}{\#ifdef\ AHCI\_DEBUG\_PRINT}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00308}00308\ \ \ \ \ \textcolor{comment}{//\ gop\_printf(0xFF00FFFF,\ "{}About\ to\ touch\ AHCI\ \%u\ at\ \%p\ |\ It's\ \%s\(\backslash\)n"{},0,\ hba\_mem,\ MmIsAddressPresent((uintptr\_t)bar)\ ?\ "{}Valid"{}\ :\ "{}Invalid"{});}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00309}00309\ \ \ \ \ \textcolor{comment}{//\_cli();\ \_\_hlt();}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00310}00310\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00311}00311\ \ \ \ \ ensure\_ahci\_busmaster\_enabled();}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00312}00312\ \ \ \ \ enable\_controller();}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00313}00313\ \ \ \ \ port\_count\ =\ 0;\ \textcolor{comment}{//\ Start\ from\ 0.}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00314}00314\ \ \ \ \ uint32\_t\ pi\ =\ hba\_mem-\/>pi;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00315}00315\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00316}00316\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ idx\ =\ 0;\ idx\ <\ \mbox{\hyperlink{ahci_8h_a21dfe7d03e0027f3c2e4a1bc81e8d85a}{AHCI\_MAX\_PORTS}};\ idx++)\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00317}00317\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (pi\ \&\ (1u\ <<\ idx))\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00318}00318\ \ \ \ \ \ \ \ \ \ \ \ \ init\_one\_port(idx);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00319}00319\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00320}00320\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00321}00321\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00322}00322\ \ \ \ \ \textcolor{comment}{//\ Register\ ALL\ block\ devices.}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00323}00323\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ port\_count;\ i++)\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00324}00324\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{block_8c_a5907b72093bd3ea0bee7c7409d3a6090}{register\_block\_device}}(\&ports[i].bdev);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00325}00325\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00326}00326\ \ \ \ \ \mbox{\hyperlink{ahci_8c_a1ed835aaf13aa614433110d49cfa556d}{ahci\_initialized}}\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00327}00327\ \ \ \ \ \textcolor{keywordflow}{return}\ port\_count\ >\ 0\ ?\ \mbox{\hyperlink{mtstatus_8h_a147849337a41d8be9ccb4ef599b84a86}{MT\_SUCCESS}}\ :\ \mbox{\hyperlink{mtstatus_8h_a46b1e8c59afc3ee9f187a07e41582eed}{MT\_AHCI\_PORT\_FAILURE}};\ \textcolor{comment}{//\ If\ it\ could\ register\ a\ port,\ it\ will\ return\ true,\ if\ it\ couldn't,\ it\ will\ return\ false\ (bugcheck)}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00328}00328\ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00329}00329\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00330}\mbox{\hyperlink{ahci_8c_ace09d7c971766cc2b7aba7c06032f781}{00330}}\ \mbox{\hyperlink{mtstatus_8h_a7c794b38d203a5b842f27b12fb55495a}{MTSTATUS}}\ \mbox{\hyperlink{ahci_8c_ace09d7c971766cc2b7aba7c06032f781}{ahci\_read\_sector}}(\mbox{\hyperlink{block_8h_a1e03bdef1501e96036b676dc18e71787}{BLOCK\_DEVICE}}*\ dev,\ uint32\_t\ lba,\ \textcolor{keywordtype}{void}*\ buf,\ \textcolor{keywordtype}{size\_t}\ bytes)\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00331}00331\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00332}00332\ \ \ \ \ \textcolor{comment}{//\ 1.\ Input\ Validation}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00333}00333\ \ \ \ \ \textcolor{keywordflow}{if}\ (bytes\ ==\ 0\ ||\ (bytes\ \%\ 512\ !=\ 0))\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00334}00334\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ ATA\ DMA\ transfers\ must\ typically\ be\ sector-\/aligned}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00335}00335\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{mtstatus_8h_a55458e0861f6a58c2bc62538f93609ce}{MT\_INVALID\_PARAM}};}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00336}00336\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00337}00337\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00338}00338\ \ \ \ \ \mbox{\hyperlink{ahci_8c_a826ec3f5221e81ed24f55d01073491a4}{AHCI\_PORT\_CTX}}*\ ctx\ =\ (\mbox{\hyperlink{ahci_8c_a826ec3f5221e81ed24f55d01073491a4}{AHCI\_PORT\_CTX}}*)dev-\/>\mbox{\hyperlink{struct___b_l_o_c_k___d_e_v_i_c_e_a640bb2cf7d104dc9f801e9820d5526f8}{dev\_data}};}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00339}00339\ \ \ \ \ \mbox{\hyperlink{ahci_8h_ac8d5245a93b3d91b9fa746c801c74a28}{HBA\_PORT}}*\ p\ =\ ctx-\/>\mbox{\hyperlink{struct___a_h_c_i___p_o_r_t___c_t_x_a9c4e1ebd6b9f043649c6f18c6029f065}{port}};}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00340}00340\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00341}00341\ \ \ \ \ \textcolor{comment}{//\ 2.\ Clear\ Pending\ Interrupts}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00342}00342\ \ \ \ \ p-\/>\mbox{\hyperlink{struct___h_b_a___p_o_r_t_ab21fab504791fdabfb4441c735452afb}{is}}\ =\ (uint32\_t)-\/1;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00343}00343\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00344}00344\ \ \ \ \ \textcolor{keywordtype}{int}\ slot\ =\ find\_free\_slot(p-\/>\mbox{\hyperlink{struct___h_b_a___p_o_r_t_ab2bfc30a5716fe626f8e44dab6fdf425}{sact}}\ |\ p-\/>\mbox{\hyperlink{struct___h_b_a___p_o_r_t_a5a98143e0639fd7e110a78a7d77231e0}{ci}});}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00345}00345\ \ \ \ \ \textcolor{keywordflow}{if}\ (slot\ <\ 0)\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{mtstatus_8h_a46b1e8c59afc3ee9f187a07e41582eed}{MT\_AHCI\_PORT\_FAILURE}};}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00346}00346\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00347}00347\ \ \ \ \ uint32\_t\ spin\ =\ 0;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00348}00348\ \ \ \ \ \textcolor{keyword}{const}\ uint32\_t\ TIMEOUT\ =\ 100000000;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00349}00349\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00350}00350\ \ \ \ \ \textcolor{comment}{//\ Wait\ for\ slot\ to\ be\ clear\ (sanity\ check)}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00351}00351\ \ \ \ \ \textcolor{keywordflow}{while}\ (p-\/>\mbox{\hyperlink{struct___h_b_a___p_o_r_t_a5a98143e0639fd7e110a78a7d77231e0}{ci}}\ \&\ (1u\ <<\ slot))\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00352}00352\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (++spin\ >=\ TIMEOUT)\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{mtstatus_8h_ad7bdb569867344cb70944a330aff1981}{MT\_AHCI\_TIMEOUT}};}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00353}00353\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00354}00354\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00355}00355\ \ \ \ \ \textcolor{comment}{//\ 3.\ Setup\ Command\ Table}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00356}00356\ \ \ \ \ \mbox{\hyperlink{ahci_8h_a5fd38edf79dcde4ab4b729353f99b837}{HBA\_CMD\_TBL}}*\ cmd\ =\ (\mbox{\hyperlink{ahci_8h_a5fd38edf79dcde4ab4b729353f99b837}{HBA\_CMD\_TBL}}*)((uint8\_t*)ctx-\/>\mbox{\hyperlink{struct___a_h_c_i___p_o_r_t___c_t_x_acd12194f997e67fe450168cb8bfd29af}{cmd\_tbl}}\ +\ slot\ *\ 256);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00357}00357\ \ \ \ \ \mbox{\hyperlink{mm_8h_a7d9455da4f2ec94a98286a19e7d8e39d}{kmemset}}(cmd,\ 0,\ 256);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00358}00358\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00359}00359\ \ \ \ \ \textcolor{comment}{//\ 4.\ Setup\ Command\ Header}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00360}00360\ \ \ \ \ \mbox{\hyperlink{ahci_8h_aa42f2e54bb5ba9a97507d17ac6203e06}{HBA\_CMD\_HEADER}}*\ hdr\ =\ (\mbox{\hyperlink{ahci_8h_aa42f2e54bb5ba9a97507d17ac6203e06}{HBA\_CMD\_HEADER}}*)((uint8\_t*)ctx-\/>\mbox{\hyperlink{struct___a_h_c_i___p_o_r_t___c_t_x_a8a076d565ce925f96c3a4b39dd83fc21}{clb}}\ +\ slot\ *\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{ahci_8h_aa42f2e54bb5ba9a97507d17ac6203e06}{HBA\_CMD\_HEADER}}));}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00361}00361\ \ \ \ \ hba\_cmd\_hdr\_set\_cfl(hdr,\ (\textcolor{keyword}{sizeof}(\mbox{\hyperlink{ahci_8h_a0f1c04900c6ce6d9e1bd2487672f1dd5}{FIS\_REG\_H2D}})\ +\ 3)\ /\ 4);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00362}00362\ \ \ \ \ hba\_cmd\_hdr\_set\_w(hdr,\ 0);\ \ \ \ \ \ \textcolor{comment}{//\ Read}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00363}00363\ \ \ \ \ hba\_cmd\_hdr\_set\_prdtl(hdr,\ 1);\ \ \textcolor{comment}{//\ One\ PRDT\ entry\ (Assuming\ bytes\ <=\ 4MB)}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00364}00364\ \ \ \ \ hdr-\/>\mbox{\hyperlink{struct___h_b_a___c_m_d___h_e_a_d_e_r_ac8d39c461915c7810aba1d549a0309aa}{prdbc}}\ =\ 0;\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Reset\ transferred\ count}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00365}00365\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00366}00366\ \ \ \ \ \textcolor{comment}{//\ 5.\ Calculate\ Sector\ Count}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00367}00367\ \ \ \ \ \textcolor{comment}{//\ We\ assume\ bytes\ is\ a\ multiple\ of\ 512\ based\ on\ the\ check\ above.}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00368}00368\ \ \ \ \ uint32\_t\ sector\_count\ =\ bytes\ /\ 512;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00369}00369\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00370}00370\ \ \ \ \ \textcolor{comment}{//\ 6.\ Build\ FIS\ with\ Dynamic\ Sector\ Count}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00371}00371\ \ \ \ \ \mbox{\hyperlink{ahci_8h_a0f1c04900c6ce6d9e1bd2487672f1dd5}{FIS\_REG\_H2D}}*\ fis\ =\ (\mbox{\hyperlink{ahci_8h_a0f1c04900c6ce6d9e1bd2487672f1dd5}{FIS\_REG\_H2D}}*)(\&cmd-\/>\mbox{\hyperlink{struct___h_b_a___c_m_d___t_b_l_a9ca6c851fa9b7745bf24b2104d25ed88}{cfis}});}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00372}00372\ \ \ \ \ \mbox{\hyperlink{mm_8h_a7d9455da4f2ec94a98286a19e7d8e39d}{kmemset}}(fis,\ 0,\ \textcolor{keyword}{sizeof}(*fis));}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00373}00373\ \ \ \ \ fis-\/>\mbox{\hyperlink{struct___f_i_s___r_e_g___h2_d_aa682c9430d53cab300ee8940356ef8ec}{fis\_type}}\ =\ \mbox{\hyperlink{ahci_8h_a84b1dcd3aa23624d89f56832a5e3ae0ea6bf1b47f446739ef43faae8f336c3926}{FIS\_TYPE\_REG\_H2D}};}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00374}00374\ \ \ \ \ fis-\/>\mbox{\hyperlink{struct___f_i_s___r_e_g___h2_d_a2e5a04327b5658199f0f7bda2acceee1}{c}}\ =\ 1;\ \textcolor{comment}{//\ Command}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00375}00375\ \ \ \ \ fis-\/>\mbox{\hyperlink{struct___f_i_s___r_e_g___h2_d_a1a5aaa930940857f68f245eeb89506b5}{command}}\ =\ 0x25;\ \textcolor{comment}{//\ READ\ DMA\ EXT}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00376}00376\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00377}00377\ \ \ \ \ fis-\/>\mbox{\hyperlink{struct___f_i_s___r_e_g___h2_d_a4d37bb385b2335b413564d27fd70b540}{lba0}}\ =\ (uint8\_t)(lba\ \&\ 0xFF);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00378}00378\ \ \ \ \ fis-\/>\mbox{\hyperlink{struct___f_i_s___r_e_g___h2_d_ac304bc04b42911d40f4f2c72c9874a86}{lba1}}\ =\ (uint8\_t)((lba\ >>\ 8)\ \&\ 0xFF);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00379}00379\ \ \ \ \ fis-\/>\mbox{\hyperlink{struct___f_i_s___r_e_g___h2_d_a2a83e1f9d697fda069699cac7ada6aa9}{lba2}}\ =\ (uint8\_t)((lba\ >>\ 16)\ \&\ 0xFF);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00380}00380\ \ \ \ \ fis-\/>\mbox{\hyperlink{struct___f_i_s___r_e_g___h2_d_a2376f17d1e7367401184b2a3978bcd3a}{device}}\ =\ 1\ <<\ 6;\ \textcolor{comment}{//\ LBA\ mode}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00381}00381\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00382}00382\ \ \ \ \ fis-\/>\mbox{\hyperlink{struct___f_i_s___r_e_g___h2_d_a88941bc1671b5fe35dc2a56fab1b06c9}{lba3}}\ =\ (uint8\_t)((lba\ >>\ 24)\ \&\ 0xFF);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00383}00383\ \ \ \ \ fis-\/>\mbox{\hyperlink{struct___f_i_s___r_e_g___h2_d_a35586c129650892e7d4a6c9873f3d0b7}{lba4}}\ =\ 0;\ \textcolor{comment}{//\ Extended\ LBA\ not\ supported\ in\ this\ simplified\ LBA32\ param}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00384}00384\ \ \ \ \ fis-\/>\mbox{\hyperlink{struct___f_i_s___r_e_g___h2_d_a7fe42d2d7b97b74048b192a186ddd18a}{lba5}}\ =\ 0;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00385}00385\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00386}00386\ \ \ \ \ \textcolor{comment}{//\ Split\ sector\ count\ for\ LBA48\ command\ structure}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00387}00387\ \ \ \ \ fis-\/>\mbox{\hyperlink{struct___f_i_s___r_e_g___h2_d_aba2096703359318cdd1e89c73ca1ab41}{countl}}\ =\ (uint8\_t)(sector\_count\ \&\ 0xFF);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00388}00388\ \ \ \ \ fis-\/>\mbox{\hyperlink{struct___f_i_s___r_e_g___h2_d_a504a9fe5ed439d47db5fe53f2a749fd3}{counth}}\ =\ (uint8\_t)((sector\_count\ >>\ 8)\ \&\ 0xFF);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00389}00389\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00390}00390\ \ \ \ \ \textcolor{comment}{//\ 7.\ Setup\ PRDT}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00391}00391\ \ \ \ \ \mbox{\hyperlink{ahci_8h_a8769db470fc28c8771fa46d2dfd5ad5e}{HBA\_PRDT\_ENTRY}}*\ prdt\ =\ \&cmd-\/>\mbox{\hyperlink{struct___h_b_a___c_m_d___t_b_l_ae306eace4b0328a382c88e13c1d2bbc3}{prdt\_entry}}[0];}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00392}00392\ \ \ \ \ uintptr\_t\ buf\_phys\ =\ \mbox{\hyperlink{map_8c_a29e582a0230e8396492f0620023f0ae5}{MiTranslateVirtualToPhysical}}(buf);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00393}00393\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00394}00394\ \ \ \ \ \textcolor{comment}{//\ Validate\ PRDT\ limits\ (AHCI\ PRDT\ dbc\ is\ max\ 4MB)}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00395}00395\ \ \ \ \ \textcolor{keywordflow}{if}\ (bytes\ >\ 4\ *\ 1024\ *\ 1024)\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{mtstatus_8h_a55458e0861f6a58c2bc62538f93609ce}{MT\_INVALID\_PARAM}};}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00396}00396\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00397}00397\ \ \ \ \ prdt-\/>\mbox{\hyperlink{struct___h_b_a___p_r_d_t___e_n_t_r_y_a3d44ae193b9ea434ad6a7487abc2f82e}{dba}}\ =\ (uint32\_t)(uintptr\_t)buf\_phys;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00398}00398\ \ \ \ \ prdt-\/>\mbox{\hyperlink{struct___h_b_a___p_r_d_t___e_n_t_r_y_a0e1f5c6f210d66855938dffc753d156b}{dbau}}\ =\ (uint32\_t)(((uintptr\_t)buf\_phys)\ >>\ 32);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00399}00399\ \ \ \ \ prdt-\/>\mbox{\hyperlink{struct___h_b_a___p_r_d_t___e_n_t_r_y_a017ed0d59352e94362de2a11c289a5ef}{dbc}}\ =\ bytes\ -\/\ 1;\ \textcolor{comment}{//\ Zero-\/based\ count\ (e.g.,\ 512\ bytes\ -\/>\ 511)}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00400}00400\ \ \ \ \ prdt-\/>\mbox{\hyperlink{struct___h_b_a___p_r_d_t___e_n_t_r_y_a752abcfe7ce5874cd9e8012a0346a37b}{i}}\ =\ 1;\ \textcolor{comment}{//\ Interrupt\ on\ Completion}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00401}00401\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00402}00402\ \ \ \ \ \textcolor{comment}{//\ 8.\ Memory\ Fences\ \&\ Cache\ Flushing}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00403}00403\ \ \ \ \ \textcolor{comment}{//\ Ensure\ the\ Table\ and\ Buffer\ are\ in\ RAM\ before\ the\ HBA\ fetches\ them}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00404}00404\ \ \ \ \ cache\_flush\_invalidate\_range(ctx-\/>\mbox{\hyperlink{struct___a_h_c_i___p_o_r_t___c_t_x_a8a076d565ce925f96c3a4b39dd83fc21}{clb}},\ 1024);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00405}00405\ \ \ \ \ cache\_flush\_invalidate\_range(cmd,\ 256);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00406}00406\ \ \ \ \ cache\_flush\_invalidate\_range(buf,\ bytes);\ \textcolor{comment}{//\ Flush\ the\ receiving\ buffer\ to\ be\ safe\ (invalidate)}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00407}00407\ \ \ \ \ \_\_asm\_\_\ \textcolor{keyword}{volatile}(\textcolor{stringliteral}{"{}sfence;\ mfence"{}}\ :::\ \textcolor{stringliteral}{"{}memory"{}});}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00408}00408\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00409}00409\ \ \ \ \ \textcolor{comment}{//\ 9.\ Start\ Command}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00410}00410\ \ \ \ \ p-\/>\mbox{\hyperlink{struct___h_b_a___p_o_r_t_a5a98143e0639fd7e110a78a7d77231e0}{ci}}\ =\ (1u\ <<\ slot);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00411}00411\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00412}00412\ \ \ \ \ \textcolor{comment}{//\ 10.\ Wait\ for\ Completion}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00413}00413\ \ \ \ \ spin\ =\ 0;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00414}00414\ \ \ \ \ \textcolor{keywordflow}{while}\ (p-\/>\mbox{\hyperlink{struct___h_b_a___p_o_r_t_a5a98143e0639fd7e110a78a7d77231e0}{ci}}\ \&\ (1u\ <<\ slot))\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00415}00415\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (++spin\ >=\ TIMEOUT)\ \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00416}00416\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00417}00417\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00418}00418\ \ \ \ \ \textcolor{comment}{//\ 11.\ Error\ Checking}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00419}00419\ \ \ \ \ \textcolor{keywordflow}{if}\ ((spin\ >=\ TIMEOUT)\ ||\ (p-\/>\mbox{\hyperlink{struct___h_b_a___p_o_r_t_a357b46f1c8107383ad47b9b65b532f5f}{tfd}}\ \&\ ((1\ <<\ 7)\ |\ (1\ <<\ 0))))\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00420}00420\ \textcolor{preprocessor}{\#ifdef\ AHCI\_DEBUG\_PRINT}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00421}00421\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ gop\_printf(COLOR\_RED,\ "{}AHCI\ Err:\ TFD:\ \%x,\ SERR:\ \%x\(\backslash\)n"{},\ p-\/>tfd,\ p-\/>serr);}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00422}00422\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00423}00423\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{mtstatus_8h_ae4ae297fe7cbd0ae4f97289e6db6b3c4}{MT\_AHCI\_READ\_FAILURE}};}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00424}00424\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00425}00425\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00426}00426\ \ \ \ \ \textcolor{comment}{//\ 12.\ Check\ Result}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00427}00427\ \ \ \ \ \textcolor{comment}{//\ Invalidate\ header\ cache\ so\ CPU\ reads\ the\ updated\ prdbc\ from\ RAM}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00428}00428\ \ \ \ \ \_\_asm\_\_\ \textcolor{keyword}{volatile}(\textcolor{stringliteral}{"{}mfence"{}}\ :::\ \textcolor{stringliteral}{"{}memory"{}});}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00429}00429\ \ \ \ \ cache\_flush\_invalidate\_range(hdr,\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{ahci_8h_aa42f2e54bb5ba9a97507d17ac6203e06}{HBA\_CMD\_HEADER}}));}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00430}00430\ \ \ \ \ \_\_asm\_\_\ \textcolor{keyword}{volatile}(\textcolor{stringliteral}{"{}mfence"{}}\ :::\ \textcolor{stringliteral}{"{}memory"{}});}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00431}00431\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00432}00432\ \ \ \ \ \textcolor{keywordflow}{if}\ (hdr-\/>\mbox{\hyperlink{struct___h_b_a___c_m_d___h_e_a_d_e_r_ac8d39c461915c7810aba1d549a0309aa}{prdbc}}\ !=\ bytes)\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00433}00433\ \textcolor{preprocessor}{\#ifdef\ AHCI\_DEBUG\_PRINT}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00434}00434\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ gop\_printf(COLOR\_RED,\ "{}AHCI\ Partial\ Read:\ Req\ \%u,\ Got\ \%u\(\backslash\)n"{},\ bytes,\ hdr-\/>prdbc);}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00435}00435\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00436}00436\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Even\ if\ mismatched,\ return\ success\ if\ data\ was\ moved?\ }}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00437}00437\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Usually\ strictly\ strictly\ enforce\ equality.}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00438}00438\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{mtstatus_8h_ae4ae297fe7cbd0ae4f97289e6db6b3c4}{MT\_AHCI\_READ\_FAILURE}};}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00439}00439\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00440}00440\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00441}00441\ \ \ \ \ \textcolor{comment}{//\ Invalidate\ data\ buffer\ cache\ so\ CPU\ reads\ new\ data\ from\ RAM}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00442}00442\ \ \ \ \ cache\_flush\_invalidate\_range(buf,\ bytes);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00443}00443\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00444}00444\ \ \ \ \ \textcolor{comment}{//\ Ack\ interrupt}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00445}00445\ \ \ \ \ p-\/>\mbox{\hyperlink{struct___h_b_a___p_o_r_t_ab21fab504791fdabfb4441c735452afb}{is}}\ =\ p-\/>\mbox{\hyperlink{struct___h_b_a___p_o_r_t_ab21fab504791fdabfb4441c735452afb}{is}};}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00446}00446\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00447}00447\ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{mtstatus_8h_a147849337a41d8be9ccb4ef599b84a86}{MT\_SUCCESS}};}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00448}00448\ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00449}00449\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00450}\mbox{\hyperlink{ahci_8c_a71a8e835dddd5b57babc5f00de3e0623}{00450}}\ \mbox{\hyperlink{mtstatus_8h_a7c794b38d203a5b842f27b12fb55495a}{MTSTATUS}}\ \mbox{\hyperlink{ahci_8c_a71a8e835dddd5b57babc5f00de3e0623}{ahci\_write\_sector}}(\mbox{\hyperlink{block_8h_a1e03bdef1501e96036b676dc18e71787}{BLOCK\_DEVICE}}*\ dev,\ uint32\_t\ lba,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{void}*\ buf,\ \textcolor{keywordtype}{size\_t}\ bytes)\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00451}00451\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00452}00452\ \ \ \ \ \textcolor{comment}{//\ 1.\ Input\ Validation}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00453}00453\ \ \ \ \ \textcolor{keywordflow}{if}\ (bytes\ ==\ 0\ ||\ (bytes\ \%\ 512\ !=\ 0))\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{mtstatus_8h_a55458e0861f6a58c2bc62538f93609ce}{MT\_INVALID\_PARAM}};}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00454}00454\ \ \ \ \ \textcolor{comment}{//\ 4MB\ Limit\ per\ PRDT\ entry\ check}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00455}00455\ \ \ \ \ \textcolor{keywordflow}{if}\ (bytes\ >\ 4\ *\ 1024\ *\ 1024)\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{mtstatus_8h_a55458e0861f6a58c2bc62538f93609ce}{MT\_INVALID\_PARAM}};}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00456}00456\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00457}00457\ \ \ \ \ \mbox{\hyperlink{ahci_8c_a826ec3f5221e81ed24f55d01073491a4}{AHCI\_PORT\_CTX}}*\ ctx\ =\ (\mbox{\hyperlink{ahci_8c_a826ec3f5221e81ed24f55d01073491a4}{AHCI\_PORT\_CTX}}*)dev-\/>\mbox{\hyperlink{struct___b_l_o_c_k___d_e_v_i_c_e_a640bb2cf7d104dc9f801e9820d5526f8}{dev\_data}};}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00458}00458\ \ \ \ \ \mbox{\hyperlink{ahci_8h_ac8d5245a93b3d91b9fa746c801c74a28}{HBA\_PORT}}*\ p\ =\ ctx-\/>\mbox{\hyperlink{struct___a_h_c_i___p_o_r_t___c_t_x_a9c4e1ebd6b9f043649c6f18c6029f065}{port}};}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00459}00459\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00460}00460\ \ \ \ \ \textcolor{comment}{//\ 2.\ Clear\ Pending\ Interrupts}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00461}00461\ \ \ \ \ p-\/>\mbox{\hyperlink{struct___h_b_a___p_o_r_t_ab21fab504791fdabfb4441c735452afb}{is}}\ =\ (uint32\_t)-\/1;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00462}00462\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00463}00463\ \ \ \ \ \textcolor{keywordtype}{int}\ slot\ =\ find\_free\_slot(p-\/>\mbox{\hyperlink{struct___h_b_a___p_o_r_t_ab2bfc30a5716fe626f8e44dab6fdf425}{sact}}\ |\ p-\/>\mbox{\hyperlink{struct___h_b_a___p_o_r_t_a5a98143e0639fd7e110a78a7d77231e0}{ci}});}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00464}00464\ \ \ \ \ \textcolor{keywordflow}{if}\ (slot\ <\ 0)\ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{mtstatus_8h_a46f73fb558e21e15b63353ddbaeb4219}{MT\_AHCI\_GENERAL\_FAILURE}};}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00465}00465\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00466}00466\ \ \ \ \ \textcolor{comment}{//\ Calculate\ sector\ count\ dynamically}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00467}00467\ \ \ \ \ uint32\_t\ sector\_count\ =\ bytes\ /\ 512;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00468}00468\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00469}00469\ \ \ \ \ \textcolor{comment}{/*\ Command\ table\ for\ this\ slot\ */}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00470}00470\ \ \ \ \ \mbox{\hyperlink{ahci_8h_a5fd38edf79dcde4ab4b729353f99b837}{HBA\_CMD\_TBL}}*\ cmd\ =\ (\mbox{\hyperlink{ahci_8h_a5fd38edf79dcde4ab4b729353f99b837}{HBA\_CMD\_TBL}}*)((uint8\_t*)ctx-\/>\mbox{\hyperlink{struct___a_h_c_i___p_o_r_t___c_t_x_acd12194f997e67fe450168cb8bfd29af}{cmd\_tbl}}\ +\ slot\ *\ 256);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00471}00471\ \ \ \ \ \mbox{\hyperlink{mm_8h_a7d9455da4f2ec94a98286a19e7d8e39d}{kmemset}}(cmd,\ 0,\ 256);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00472}00472\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00473}00473\ \ \ \ \ \textcolor{comment}{/*\ Command\ header\ */}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00474}00474\ \ \ \ \ \mbox{\hyperlink{ahci_8h_aa42f2e54bb5ba9a97507d17ac6203e06}{HBA\_CMD\_HEADER}}*\ hdr\ =\ (\mbox{\hyperlink{ahci_8h_aa42f2e54bb5ba9a97507d17ac6203e06}{HBA\_CMD\_HEADER}}*)((uint8\_t*)ctx-\/>\mbox{\hyperlink{struct___a_h_c_i___p_o_r_t___c_t_x_a8a076d565ce925f96c3a4b39dd83fc21}{clb}}\ +\ slot\ *\ \textcolor{keyword}{sizeof}(\mbox{\hyperlink{ahci_8h_aa42f2e54bb5ba9a97507d17ac6203e06}{HBA\_CMD\_HEADER}}));}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00475}00475\ \ \ \ \ hba\_cmd\_hdr\_set\_cfl(hdr,\ (\textcolor{keyword}{sizeof}(\mbox{\hyperlink{ahci_8h_a0f1c04900c6ce6d9e1bd2487672f1dd5}{FIS\_REG\_H2D}})\ +\ 3)\ /\ 4);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00476}00476\ \ \ \ \ hba\_cmd\_hdr\_set\_w(hdr,\ 1);\ \ \ \ \ \ \ \textcolor{comment}{/*\ write\ */}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00477}00477\ \ \ \ \ hdr-\/>\mbox{\hyperlink{struct___h_b_a___c_m_d___h_e_a_d_e_r_ac8d39c461915c7810aba1d549a0309aa}{prdbc}}\ =\ 0;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00478}00478\ \ \ \ \ hba\_cmd\_hdr\_set\_prdtl(hdr,\ 1);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00479}00479\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00480}00480\ \ \ \ \ \textcolor{comment}{/*\ Build\ CFIS\ */}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00481}00481\ \ \ \ \ \mbox{\hyperlink{ahci_8h_a0f1c04900c6ce6d9e1bd2487672f1dd5}{FIS\_REG\_H2D}}*\ fis\ =\ (\mbox{\hyperlink{ahci_8h_a0f1c04900c6ce6d9e1bd2487672f1dd5}{FIS\_REG\_H2D}}*)(\&cmd-\/>\mbox{\hyperlink{struct___h_b_a___c_m_d___t_b_l_a9ca6c851fa9b7745bf24b2104d25ed88}{cfis}});}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00482}00482\ \ \ \ \ \mbox{\hyperlink{mm_8h_a7d9455da4f2ec94a98286a19e7d8e39d}{kmemset}}(fis,\ 0,\ \textcolor{keyword}{sizeof}(*fis));}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00483}00483\ \ \ \ \ fis-\/>\mbox{\hyperlink{struct___f_i_s___r_e_g___h2_d_aa682c9430d53cab300ee8940356ef8ec}{fis\_type}}\ =\ \mbox{\hyperlink{ahci_8h_a84b1dcd3aa23624d89f56832a5e3ae0ea6bf1b47f446739ef43faae8f336c3926}{FIS\_TYPE\_REG\_H2D}};}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00484}00484\ \ \ \ \ fis-\/>\mbox{\hyperlink{struct___f_i_s___r_e_g___h2_d_a2e5a04327b5658199f0f7bda2acceee1}{c}}\ =\ 1;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00485}00485\ \ \ \ \ fis-\/>\mbox{\hyperlink{struct___f_i_s___r_e_g___h2_d_a1a5aaa930940857f68f245eeb89506b5}{command}}\ =\ 0x35;\ \textcolor{comment}{/*\ WRITE\ DMA\ EXT\ */}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00486}00486\ \ \ \ \ fis-\/>\mbox{\hyperlink{struct___f_i_s___r_e_g___h2_d_a2376f17d1e7367401184b2a3978bcd3a}{device}}\ =\ 1\ <<\ 6;\ \textcolor{comment}{//\ LBA\ mode}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00487}00487\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00488}00488\ \ \ \ \ fis-\/>\mbox{\hyperlink{struct___f_i_s___r_e_g___h2_d_a4d37bb385b2335b413564d27fd70b540}{lba0}}\ =\ (uint8\_t)(lba\ \&\ 0xFF);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00489}00489\ \ \ \ \ fis-\/>\mbox{\hyperlink{struct___f_i_s___r_e_g___h2_d_ac304bc04b42911d40f4f2c72c9874a86}{lba1}}\ =\ (uint8\_t)((lba\ >>\ 8)\ \&\ 0xFF);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00490}00490\ \ \ \ \ fis-\/>\mbox{\hyperlink{struct___f_i_s___r_e_g___h2_d_a2a83e1f9d697fda069699cac7ada6aa9}{lba2}}\ =\ (uint8\_t)((lba\ >>\ 16)\ \&\ 0xFF);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00491}00491\ \ \ \ \ fis-\/>\mbox{\hyperlink{struct___f_i_s___r_e_g___h2_d_a88941bc1671b5fe35dc2a56fab1b06c9}{lba3}}\ =\ (uint8\_t)((lba\ >>\ 24)\ \&\ 0xFF);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00492}00492\ \ \ \ \ fis-\/>\mbox{\hyperlink{struct___f_i_s___r_e_g___h2_d_a35586c129650892e7d4a6c9873f3d0b7}{lba4}}\ =\ 0;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00493}00493\ \ \ \ \ fis-\/>\mbox{\hyperlink{struct___f_i_s___r_e_g___h2_d_a7fe42d2d7b97b74048b192a186ddd18a}{lba5}}\ =\ 0;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00494}00494\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00495}00495\ \ \ \ \ \textcolor{comment}{//\ >>>\ FIXED:\ Dynamic\ Sector\ Count\ <<<}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00496}00496\ \ \ \ \ fis-\/>\mbox{\hyperlink{struct___f_i_s___r_e_g___h2_d_aba2096703359318cdd1e89c73ca1ab41}{countl}}\ =\ (uint8\_t)(sector\_count\ \&\ 0xFF);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00497}00497\ \ \ \ \ fis-\/>\mbox{\hyperlink{struct___f_i_s___r_e_g___h2_d_a504a9fe5ed439d47db5fe53f2a749fd3}{counth}}\ =\ (uint8\_t)((sector\_count\ >>\ 8)\ \&\ 0xFF);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00498}00498\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00499}00499\ \ \ \ \ \textcolor{comment}{/*\ PRDT\ */}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00500}00500\ \ \ \ \ \mbox{\hyperlink{ahci_8h_a8769db470fc28c8771fa46d2dfd5ad5e}{HBA\_PRDT\_ENTRY}}*\ prdt\ =\ \&cmd-\/>\mbox{\hyperlink{struct___h_b_a___c_m_d___t_b_l_ae306eace4b0328a382c88e13c1d2bbc3}{prdt\_entry}}[0];}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00501}00501\ \ \ \ \ \textcolor{comment}{//\ translation\ DOES\ NOT\ write\ to\ the\ buffer,\ only\ makes\ translations.}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00502}00502\ \ \ \ \ uintptr\_t\ buf\_phys\ =\ \mbox{\hyperlink{map_8c_a29e582a0230e8396492f0620023f0ae5}{MiTranslateVirtualToPhysical}}((\textcolor{keywordtype}{void}*)buf);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00503}00503\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00504}00504\ \textcolor{preprocessor}{\#ifdef\ AHCI\_DEBUG\_PRINT}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00505}00505\ \ \ \ \ \textcolor{comment}{//\ gop\_printf(COLOR\_BLUE,\ "{}AHCI\ WRITE:\ phys:\ \%p\ |\ virt:\ \%p\ |\ bytes:\ \%u\(\backslash\)n"{},\ buf\_phys,\ buf,\ bytes);}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00506}00506\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00507}00507\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00508}00508\ \ \ \ \ prdt-\/>\mbox{\hyperlink{struct___h_b_a___p_r_d_t___e_n_t_r_y_a3d44ae193b9ea434ad6a7487abc2f82e}{dba}}\ =\ (uint32\_t)(uintptr\_t)buf\_phys;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00509}00509\ \ \ \ \ prdt-\/>\mbox{\hyperlink{struct___h_b_a___p_r_d_t___e_n_t_r_y_a0e1f5c6f210d66855938dffc753d156b}{dbau}}\ =\ (uint32\_t)(((uintptr\_t)buf\_phys)\ >>\ 32);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00510}00510\ \ \ \ \ prdt-\/>\mbox{\hyperlink{struct___h_b_a___p_r_d_t___e_n_t_r_y_a017ed0d59352e94362de2a11c289a5ef}{dbc}}\ =\ bytes\ -\/\ 1;\ \textcolor{comment}{//\ Set\ byte\ count\ (length\ -\/\ 1)}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00511}00511\ \ \ \ \ prdt-\/>\mbox{\hyperlink{struct___h_b_a___p_r_d_t___e_n_t_r_y_a752abcfe7ce5874cd9e8012a0346a37b}{i}}\ =\ 1;\ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Interrupt\ on\ completion}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00512}00512\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00513}00513\ \ \ \ \ \textcolor{comment}{//\ >>>\ CRITICAL:\ Cache\ Flushing\ for\ Writes\ <<<}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00514}00514\ \ \ \ \ \textcolor{comment}{//\ For\ writes,\ we\ must\ ensure\ the\ data\ in\ the\ CPU\ cache\ is\ written\ back\ to\ RAM}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00515}00515\ \ \ \ \ \textcolor{comment}{//\ before\ the\ DMA\ controller\ reads\ it.}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00516}00516\ \ \ \ \ cache\_flush\_invalidate\_range((\textcolor{keywordtype}{void}*)buf,\ bytes);\ \textcolor{comment}{//\ Flush\ entire\ buffer,\ not\ just\ 512}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00517}00517\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00518}00518\ \ \ \ \ \textcolor{comment}{//\ Flush\ metadata}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00519}00519\ \ \ \ \ cache\_flush\_invalidate\_range(ctx-\/>\mbox{\hyperlink{struct___a_h_c_i___p_o_r_t___c_t_x_a8a076d565ce925f96c3a4b39dd83fc21}{clb}},\ 1024);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00520}00520\ \ \ \ \ cache\_flush\_invalidate\_range(cmd,\ 256);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00521}00521\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00522}00522\ \ \ \ \ \_\_asm\_\_\ \textcolor{keyword}{volatile}(\textcolor{stringliteral}{"{}sfence;\ mfence"{}}\ :::\ \textcolor{stringliteral}{"{}memory"{}});}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00523}00523\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00524}00524\ \ \ \ \ \textcolor{comment}{/*\ Issue\ */}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00525}00525\ \ \ \ \ p-\/>\mbox{\hyperlink{struct___h_b_a___p_o_r_t_a5a98143e0639fd7e110a78a7d77231e0}{ci}}\ =\ (1u\ <<\ slot);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00526}00526\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00527}00527\ \ \ \ \ \textcolor{comment}{/*\ Wait\ */}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00528}00528\ \ \ \ \ uint32\_t\ spin\ =\ 0;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00529}00529\ \ \ \ \ \textcolor{keyword}{const}\ uint32\_t\ TIMEOUT\ =\ 100000000;}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00530}00530\ \ \ \ \ \textcolor{keywordflow}{while}\ (p-\/>\mbox{\hyperlink{struct___h_b_a___p_o_r_t_a5a98143e0639fd7e110a78a7d77231e0}{ci}}\ \&\ (1u\ <<\ slot))\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00531}00531\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (++spin\ >=\ TIMEOUT)\ \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00532}00532\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00533}00533\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00534}00534\ \ \ \ \ \textcolor{keywordflow}{if}\ (spin\ >=\ TIMEOUT)\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00535}00535\ \textcolor{preprocessor}{\#ifdef\ AHCI\_DEBUG\_PRINT}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00536}00536\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ gop\_printf(COLOR\_RED,\ "{}AHCI\ TIMEOUT\ ahci\_write\_sector\(\backslash\)n"{});}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00537}00537\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00538}00538\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{mtstatus_8h_ad7bdb569867344cb70944a330aff1981}{MT\_AHCI\_TIMEOUT}};}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00539}00539\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00540}00540\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00541}00541\ \ \ \ \ \textcolor{comment}{//\ IMPORTANT:\ Check\ for\ errors\ from\ the\ device}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00542}00542\ \ \ \ \ \textcolor{keywordflow}{if}\ (p-\/>\mbox{\hyperlink{struct___h_b_a___p_o_r_t_a357b46f1c8107383ad47b9b65b532f5f}{tfd}}\ \&\ ((1\ <<\ 7)\ |\ (1\ <<\ 0)))\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00543}00543\ \textcolor{preprocessor}{\#ifdef\ AHCI\_DEBUG\_PRINT}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00544}00544\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ gop\_printf(0xFFFF0000,\ "{}AHCI\ write\ error!\(\backslash\)n"{});}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00545}00545\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ gop\_printf(0xFFFFFF00,\ "{}Port\ TFD:\ \%p,\ SERR:\ \%p\(\backslash\)n"{},\ (void*)(uintptr\_t)p-\/>tfd,\ (void*)(uintptr\_t)p-\/>serr);}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00546}00546\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00547}00547\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{mtstatus_8h_a05d02534d3e3ddfe49edd80da1d89836}{MT\_AHCI\_WRITE\_FAILURE}};}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00548}00548\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00549}00549\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00550}00550\ \ \ \ \ \textcolor{comment}{//\ Optional:\ Verify\ prdbc\ matches\ bytes\ written}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00551}00551\ \ \ \ \ \textcolor{comment}{//\ \_\_asm\_\_\ volatile("{}mfence"{}\ :::\ "{}memory"{});}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00552}00552\ \ \ \ \ \textcolor{comment}{//\ cache\_flush\_invalidate\_range(hdr,\ sizeof(HBA\_CMD\_HEADER));}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00553}00553\ \ \ \ \ \textcolor{comment}{//\ if\ (hdr-\/>prdbc\ !=\ bytes)\ \{\ /*\ Warning\ */\ \}}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00554}00554\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00555}00555\ \ \ \ \ \textcolor{comment}{//\ clear\ int}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00556}00556\ \ \ \ \ p-\/>\mbox{\hyperlink{struct___h_b_a___p_o_r_t_ab21fab504791fdabfb4441c735452afb}{is}}\ =\ p-\/>\mbox{\hyperlink{struct___h_b_a___p_o_r_t_ab21fab504791fdabfb4441c735452afb}{is}};}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00557}00557\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00558}00558\ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{mtstatus_8h_a147849337a41d8be9ccb4ef599b84a86}{MT\_SUCCESS}};}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00559}00559\ \}}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00560}00560\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00561}00561\ }
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00562}\mbox{\hyperlink{ahci_8c_a155325b891cfe68e3e74735a8f304702}{00562}}\ \mbox{\hyperlink{block_8h_a1e03bdef1501e96036b676dc18e71787}{BLOCK\_DEVICE}}*\ \mbox{\hyperlink{ahci_8c_a155325b891cfe68e3e74735a8f304702}{ahci\_get\_block\_device}}(\textcolor{keywordtype}{int}\ index)\ \{}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00563}00563\ \ \ \ \ \textcolor{keywordflow}{return}\ \mbox{\hyperlink{block_8c_ac7446440486f68f8b12119a25eb9740b}{get\_block\_device}}(index);}
\DoxyCodeLine{\Hypertarget{ahci_8c_source_l00564}00564\ \}}

\end{DoxyCode}

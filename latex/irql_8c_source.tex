\doxysection{irql.\+c}
\hypertarget{irql_8c_source}{}\label{irql_8c_source}\index{C:/Users/matanel/Desktop/Projects/KernelDevelopment/kernel/cpu/irql/irql.c@{C:/Users/matanel/Desktop/Projects/KernelDevelopment/kernel/cpu/irql/irql.c}}
\mbox{\hyperlink{irql_8c}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00001}00001\ \textcolor{comment}{/*}}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00002}00002\ \textcolor{comment}{\ *\ PROJECT:\ \ \ \ \ \ MatanelOS\ Kernel}}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00003}00003\ \textcolor{comment}{\ *\ LICENSE:\ \ \ \ \ \ GPLv3}}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00004}00004\ \textcolor{comment}{\ *\ PURPOSE:\ \ \ \ \ \ IRQL\ Implementation\ (Fixed\ with\ Dispatch\ Level\ scheduling\ toggle)}}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00005}00005\ \textcolor{comment}{\ */}}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00006}00006\ }
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00007}00007\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{irql_8h}{irql.h}}"{}}}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00008}00008\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bugcheck_8h}{../../bugcheck/bugcheck.h}}"{}}}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00009}00009\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{idt_8h}{../../interrupts/idt.h}}"{}}}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00010}00010\ }
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00011}\mbox{\hyperlink{irql_8c_aff2fd5039d098c671403089630aa2a16}{00011}}\ \mbox{\hyperlink{cpu__types_8h_a7258ea91cea6c1c174df48f6225ef4da}{IRQL}}\ \mbox{\hyperlink{irql_8c_aff2fd5039d098c671403089630aa2a16}{irq\_irql}}[16]\ =\ \{}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00012}00012\ \ \ \ \ \mbox{\hyperlink{cpu__types_8h_a6ff101fd8adf1c79792d98893f8dee3eaf269d1ff38f220586a36073e957c1c31}{DIRQL\_TIMER}},\ \mbox{\hyperlink{cpu__types_8h_a6ff101fd8adf1c79792d98893f8dee3eaa26c00abca6060aa0ef883d4feb64933}{DIRQL\_KEYBOARD}},\ \mbox{\hyperlink{cpu__types_8h_a6ff101fd8adf1c79792d98893f8dee3ea98db32e4c9f2f7038588637a8e0d8e02}{DIRQL\_CASCADE}},\ \mbox{\hyperlink{cpu__types_8h_a6ff101fd8adf1c79792d98893f8dee3ea3a0954558ba16ce10f86b27a1c260ab9}{DIRQL\_COM2}},}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00013}00013\ \ \ \ \ \mbox{\hyperlink{cpu__types_8h_a6ff101fd8adf1c79792d98893f8dee3ea07d2fc2ab4f645aa20a219f254e89c92}{DIRQL\_COM1}},\ \mbox{\hyperlink{cpu__types_8h_a6ff101fd8adf1c79792d98893f8dee3ea652d8fcb8d7178c43d659e05d5f0c61e}{DIRQL\_SOUND\_LPT2}},\ \mbox{\hyperlink{cpu__types_8h_a6ff101fd8adf1c79792d98893f8dee3ead24bc1037757a8687b57431012e1ec7b}{DIRQL\_FLOPPY}},\ \mbox{\hyperlink{cpu__types_8h_a6ff101fd8adf1c79792d98893f8dee3ea06521f37ef85a73a21191dd7e17cfac3}{DIRQL\_LPT1}},}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00014}00014\ \ \ \ \ \mbox{\hyperlink{cpu__types_8h_a6ff101fd8adf1c79792d98893f8dee3eac17c317e38ad78a2774691e66da0e314}{DIRQL\_RTC}},\ \mbox{\hyperlink{cpu__types_8h_a6ff101fd8adf1c79792d98893f8dee3ea87be9ec49b4a5b948bf3708d00527745}{DIRQL\_PERIPHERAL9}},\ \mbox{\hyperlink{cpu__types_8h_a6ff101fd8adf1c79792d98893f8dee3ea7f6e3a59936365c2a9fab81afe3528f3}{DIRQL\_PERIPHERAL10}},\ \mbox{\hyperlink{cpu__types_8h_a6ff101fd8adf1c79792d98893f8dee3ea3f4f6178ac1c2cee47a6a70ae90c2d11}{DIRQL\_PERIPHERAL11}},}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00015}00015\ \ \ \ \ \mbox{\hyperlink{cpu__types_8h_a6ff101fd8adf1c79792d98893f8dee3ea4370ab4568401345c04e3c93a17d8f85}{DIRQL\_MOUSE}},\ \mbox{\hyperlink{cpu__types_8h_a6ff101fd8adf1c79792d98893f8dee3eaf5d0cfde2e4bea8ab1814ce632a6323e}{DIRQL\_FPU}},\ \mbox{\hyperlink{cpu__types_8h_a6ff101fd8adf1c79792d98893f8dee3eabe8e9b8a2dc2a7b98b72fe4d786de3d1}{DIRQL\_PRIMARY\_ATA}},\ \mbox{\hyperlink{cpu__types_8h_a6ff101fd8adf1c79792d98893f8dee3ea4124f29d67ec38a0a9cf86411029b764}{DIRQL\_SECONDARY\_ATA}}}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00016}00016\ \};}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00017}00017\ }
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00018}\mbox{\hyperlink{irql_8c_a89b1dc79cdd1cbd04ef4a4470ed77604}{00018}}\ \textcolor{preprocessor}{\#define\ IRQ\_LINES\ (sizeof(irq\_irql)\ /\ sizeof(irq\_irql[0]))}}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00019}00019\ }
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00020}00020\ \textcolor{keyword}{static}\ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{bool}\ interrupts\_enabled(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00021}00021\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{long}\ flags;}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00022}00022\ \ \ \ \ \_\_asm\_\_\ \_\_volatile\_\_(\textcolor{stringliteral}{"{}pushfq;\ popq\ \%0"{}}\ :\ \textcolor{stringliteral}{"{}=r"{}}(flags));}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00023}00023\ \ \ \ \ \textcolor{keywordflow}{return}\ (flags\ \&\ (1UL\ <<\ 9))\ !=\ 0;\ \textcolor{comment}{//\ IF\ is\ bit\ 9}}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00024}00024\ \}}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00025}00025\ }
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00026}00026\ \textcolor{comment}{//\ IMPORTANT:\ We\ disable\ interrupts\ around\ PIC\ updates\ to\ avoid\ races.}}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00027}\mbox{\hyperlink{irql_8c_ab5f701d7ea67d78af40e6bc73264e0c4}{00027}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{irql_8c_ab5f701d7ea67d78af40e6bc73264e0c4}{update\_pic\_mask\_for\_current\_irql}}(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00028}00028\ \ \ \ \ \textcolor{keywordtype}{bool}\ prev\_if\ =\ interrupts\_enabled();}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00029}00029\ \ \ \ \ \_\_cli();}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00030}00030\ \ \ \ \ \mbox{\hyperlink{cpu__types_8h_a7258ea91cea6c1c174df48f6225ef4da}{IRQL}}\ level\ =\ \mbox{\hyperlink{bugcheck_8c_a0b2a3530e9a5998456be351b4251b878}{cpu}}.currentIrql;}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00031}00031\ }
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00032}00032\ \ \ \ \ \textcolor{comment}{//\ Mask\ any\ IRQ\ whose\ assigned\ IRQL\ is\ <=\ the\ current\ CPU\ IRQL.}}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00033}00033\ \ \ \ \ \textcolor{comment}{//\ Unmask\ any\ IRQ\ whose\ assigned\ IRQL\ is\ >\ the\ current\ CPU\ IRQL.}}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00034}00034\ \ \ \ \ \textcolor{keywordflow}{for}\ (uint8\_t\ i\ =\ 0;\ i\ <\ \mbox{\hyperlink{irql_8c_a89b1dc79cdd1cbd04ef4a4470ed77604}{IRQ\_LINES}};\ i++)\ \{}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00035}00035\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\mbox{\hyperlink{irql_8c_aff2fd5039d098c671403089630aa2a16}{irq\_irql}}[i]\ <=\ level)\ \{}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00036}00036\ \ \ \ \ \ \ \ \ \ \ \ \ mask\_irq(i);}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00037}00037\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00038}00038\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00039}00039\ \ \ \ \ \ \ \ \ \ \ \ \ unmask\_irq(i);}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00040}00040\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00041}00041\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00042}00042\ \ \ \ \ \textcolor{keywordflow}{if}\ (prev\_if)\ \_\_sti();}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00043}00043\ \}}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00044}00044\ }
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00045}00045\ \textcolor{keyword}{static}\ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{void}\ toggle\_scheduler(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00046}00046\ \ \ \ \ \textcolor{comment}{//\ schedulerEnabled\ should\ be\ true\ only\ at\ IRQL\ <\ DISPATCH\_LEVEL}}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00047}00047\ \ \ \ \ \mbox{\hyperlink{bugcheck_8c_a0b2a3530e9a5998456be351b4251b878}{cpu}}.schedulerEnabled\ =\ (\mbox{\hyperlink{bugcheck_8c_a0b2a3530e9a5998456be351b4251b878}{cpu}}.currentIrql\ <\ \mbox{\hyperlink{cpu__types_8h_a6ff101fd8adf1c79792d98893f8dee3ea291292740ec80ec0ff8e2a70c5bdfd6f}{DISPATCH\_LEVEL}});}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00048}00048\ \}}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00049}00049\ }
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00050}\mbox{\hyperlink{irql_8c_ab87b54fe7849700d6989baf517998ac8}{00050}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{irql_8c_ab87b54fe7849700d6989baf517998ac8}{MtGetCurrentIRQL}}(\mbox{\hyperlink{cpu__types_8h_a7258ea91cea6c1c174df48f6225ef4da}{IRQL}}*\ out)\ \{}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00051}00051\ \ \ \ \ tracelast\_func(\textcolor{stringliteral}{"{}GetCurrentIRQL"{}});}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00052}00052\ \ \ \ \ *out\ =\ atomic\_load\_explicit(\&\mbox{\hyperlink{bugcheck_8c_a0b2a3530e9a5998456be351b4251b878}{cpu}}.currentIrql,\ memory\_order\_acquire);}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00053}00053\ \}}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00054}00054\ }
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00055}\mbox{\hyperlink{irql_8c_a7b283751f37f08c240ae3ec69c88036c}{00055}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{irql_8c_a7b283751f37f08c240ae3ec69c88036c}{MtRaiseIRQL}}(\mbox{\hyperlink{cpu__types_8h_a7258ea91cea6c1c174df48f6225ef4da}{IRQL}}\ new\_irql,\ \mbox{\hyperlink{cpu__types_8h_a7258ea91cea6c1c174df48f6225ef4da}{IRQL}}*\ old\_irql)\ \{}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00056}00056\ \ \ \ \ \textcolor{keywordtype}{bool}\ prev\_if\ =\ interrupts\_enabled();}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00057}00057\ \ \ \ \ \_\_cli();}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00058}00058\ \ \ \ \ tracelast\_func(\textcolor{stringliteral}{"{}RaiseIRQL"{}});}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00059}00059\ }
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00060}00060\ \ \ \ \ \textcolor{keywordflow}{if}\ (old\_irql)\ \{}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00061}00061\ \ \ \ \ \ \ \ \ *old\_irql\ =\ \mbox{\hyperlink{bugcheck_8c_a0b2a3530e9a5998456be351b4251b878}{cpu}}.currentIrql;}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00062}00062\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00063}00063\ }
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00064}00064\ \ \ \ \ \mbox{\hyperlink{cpu__types_8h_a7258ea91cea6c1c174df48f6225ef4da}{IRQL}}\ curr\ =\ atomic\_load\_explicit(\&\mbox{\hyperlink{bugcheck_8c_a0b2a3530e9a5998456be351b4251b878}{cpu}}.currentIrql,\ memory\_order\_acquire);}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00065}00065\ \ \ \ \ \textcolor{keywordflow}{if}\ (new\_irql\ <\ curr)\ \{}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00066}00066\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{cpu__types_8h_ac240bdf341c5e0ae333252cd5ecf0261}{CTX\_FRAME}}\ ctx;}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00067}00067\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{cpu_8h_a4cb54878e75e454401e12e4865c7d122}{SAVE\_CTX\_FRAME}}(\&ctx);}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00068}00068\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{bugcheck_8h_a0ea5d5717f65abd50f45d343b6a251c9}{BUGCHECK\_ADDITIONALS}}\ addt\ =\ \{\ 0\ \};}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00069}00069\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{gop_8c_a4c58494b90fd7bfbc33a84178e327b88}{ksnprintf}}(addt.\mbox{\hyperlink{struct___b_u_g_c_h_e_c_k___a_d_d_i_t_i_o_n_a_l_s_a22666d1dd2bf2e039ee004bcf8650c97}{str}},\ \textcolor{keyword}{sizeof}(addt.\mbox{\hyperlink{struct___b_u_g_c_h_e_c_k___a_d_d_i_t_i_o_n_a_l_s_a22666d1dd2bf2e039ee004bcf8650c97}{str}}),\ \textcolor{stringliteral}{"{}Attempted\ to\ raise\ IRQL\ to\ a\ lower\ level\ than\ current\ IRQL."{}});}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00070}00070\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{bugcheck_8c_a882a1431cb6ee4d732b3aaf8a3cfda97}{MtBugcheckEx}}(\&ctx,\ NULL,\ \mbox{\hyperlink{bugcheck_8h_a3dd6c077b2422dcc0d05246537da5c82ae3e824eb536b02e7941e6545b6979fc7}{IRQL\_NOT\_LESS\_OR\_EQUAL}},\ \&addt,\ \textcolor{keyword}{true});}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00071}00071\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00072}00072\ }
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00073}00073\ \ \ \ \ \mbox{\hyperlink{bugcheck_8c_a0b2a3530e9a5998456be351b4251b878}{cpu}}.currentIrql\ =\ new\_irql;}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00074}00074\ \ \ \ \ toggle\_scheduler();}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00075}00075\ \ \ \ \ \mbox{\hyperlink{irql_8c_ab5f701d7ea67d78af40e6bc73264e0c4}{update\_pic\_mask\_for\_current\_irql}}();}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00076}00076\ \ \ \ \ \textcolor{keywordflow}{if}\ (prev\_if)\ \_\_sti();}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00077}00077\ \}}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00078}00078\ }
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00079}\mbox{\hyperlink{irql_8c_a173035246a571f36d2066be8fa9eef11}{00079}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{irql_8c_a173035246a571f36d2066be8fa9eef11}{MtLowerIRQL}}(\mbox{\hyperlink{cpu__types_8h_a7258ea91cea6c1c174df48f6225ef4da}{IRQL}}\ new\_irql)\ \{}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00080}00080\ \ \ \ \ \textcolor{keywordtype}{bool}\ prev\_if\ =\ interrupts\_enabled();}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00081}00081\ \ \ \ \ \_\_cli();}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00082}00082\ \ \ \ \ tracelast\_func(\textcolor{stringliteral}{"{}LowerIRQL"{}});}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00083}00083\ }
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00084}00084\ \ \ \ \ \mbox{\hyperlink{cpu__types_8h_a7258ea91cea6c1c174df48f6225ef4da}{IRQL}}\ curr\ =\ atomic\_load\_explicit(\&\mbox{\hyperlink{bugcheck_8c_a0b2a3530e9a5998456be351b4251b878}{cpu}}.currentIrql,\ memory\_order\_acquire);}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00085}00085\ \ \ \ \ \textcolor{keywordflow}{if}\ (new\_irql\ >\ curr)\ \{}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00086}00086\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{cpu__types_8h_ac240bdf341c5e0ae333252cd5ecf0261}{CTX\_FRAME}}\ ctx;}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00087}00087\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{cpu_8h_a4cb54878e75e454401e12e4865c7d122}{SAVE\_CTX\_FRAME}}(\&ctx);}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00088}00088\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{bugcheck_8h_a0ea5d5717f65abd50f45d343b6a251c9}{BUGCHECK\_ADDITIONALS}}\ addt\ =\ \{\ 0\ \};}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00089}00089\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{gop_8c_a4c58494b90fd7bfbc33a84178e327b88}{ksnprintf}}(addt.\mbox{\hyperlink{struct___b_u_g_c_h_e_c_k___a_d_d_i_t_i_o_n_a_l_s_a22666d1dd2bf2e039ee004bcf8650c97}{str}},\ \textcolor{keyword}{sizeof}(addt.\mbox{\hyperlink{struct___b_u_g_c_h_e_c_k___a_d_d_i_t_i_o_n_a_l_s_a22666d1dd2bf2e039ee004bcf8650c97}{str}}),\ \textcolor{stringliteral}{"{}Attempted\ to\ lower\ IRQL\ to\ a\ higher\ level\ than\ current\ IRQL."{}});}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00090}00090\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{bugcheck_8c_a882a1431cb6ee4d732b3aaf8a3cfda97}{MtBugcheckEx}}(\&ctx,\ NULL,\ \mbox{\hyperlink{bugcheck_8h_a3dd6c077b2422dcc0d05246537da5c82ae3e824eb536b02e7941e6545b6979fc7}{IRQL\_NOT\_LESS\_OR\_EQUAL}},\ \&addt,\ \textcolor{keyword}{true});}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00091}00091\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00092}00092\ }
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00093}00093\ \ \ \ \ \mbox{\hyperlink{bugcheck_8c_a0b2a3530e9a5998456be351b4251b878}{cpu}}.currentIrql\ =\ new\_irql;}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00094}00094\ \ \ \ \ toggle\_scheduler();}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00095}00095\ \ \ \ \ \mbox{\hyperlink{irql_8c_ab5f701d7ea67d78af40e6bc73264e0c4}{update\_pic\_mask\_for\_current\_irql}}();}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00096}00096\ \ \ \ \ \textcolor{keywordflow}{if}\ (prev\_if)\ \_\_sti();}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00097}00097\ \}}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00098}00098\ }
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00099}00099\ \textcolor{comment}{//\ This\ function\ should\ be\ used\ sparingly,\ only\ during\ initialization.}}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00100}\mbox{\hyperlink{irql_8c_a4fb94a50a85a92c8939fa2201c5ba0d8}{00100}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{irql_8c_a4fb94a50a85a92c8939fa2201c5ba0d8}{\_MtSetIRQL}}(\mbox{\hyperlink{cpu__types_8h_a7258ea91cea6c1c174df48f6225ef4da}{IRQL}}\ new\_irql)\ \{}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00101}00101\ \ \ \ \ \textcolor{keywordtype}{bool}\ prev\_if\ =\ interrupts\_enabled();}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00102}00102\ \ \ \ \ \_\_cli();}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00103}00103\ \ \ \ \ tracelast\_func(\textcolor{stringliteral}{"{}\_SetIRQL"{}});}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00104}00104\ }
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00105}00105\ \ \ \ \ \mbox{\hyperlink{bugcheck_8c_a0b2a3530e9a5998456be351b4251b878}{cpu}}.currentIrql\ =\ new\_irql;}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00106}00106\ \ \ \ \ toggle\_scheduler();}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00107}00107\ \ \ \ \ \mbox{\hyperlink{irql_8c_ab5f701d7ea67d78af40e6bc73264e0c4}{update\_pic\_mask\_for\_current\_irql}}();}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00108}00108\ \ \ \ \ \textcolor{keywordflow}{if}\ (prev\_if)\ \_\_sti();}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00109}00109\ \}}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00110}00110\ }
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00111}\mbox{\hyperlink{irql_8c_a18058aa8b45e4b81a66efa2f2d708215}{00111}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{irql_8c_a18058aa8b45e4b81a66efa2f2d708215}{enforce\_max\_irql}}(\mbox{\hyperlink{cpu__types_8h_a7258ea91cea6c1c174df48f6225ef4da}{IRQL}}\ max\_allowed,\ \textcolor{keywordtype}{void}*\ RIP)\ \{}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00112}00112\ \ \ \ \ \textcolor{keywordtype}{bool}\ prev\_if\ =\ interrupts\_enabled();}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00113}00113\ \ \ \ \ \_\_cli();}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00114}00114\ \ \ \ \ \mbox{\hyperlink{cpu__types_8h_a7258ea91cea6c1c174df48f6225ef4da}{IRQL}}\ curr\ =\ atomic\_load\_explicit(\&\mbox{\hyperlink{bugcheck_8c_a0b2a3530e9a5998456be351b4251b878}{cpu}}.currentIrql,\ memory\_order\_acquire);}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00115}00115\ \ \ \ \ \textcolor{keywordflow}{if}\ (curr\ >\ max\_allowed)\ \{}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00116}00116\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{cpu__types_8h_ac240bdf341c5e0ae333252cd5ecf0261}{CTX\_FRAME}}\ ctx;}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00117}00117\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{cpu_8h_a4cb54878e75e454401e12e4865c7d122}{SAVE\_CTX\_FRAME}}(\&ctx);}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00118}00118\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{bugcheck_8h_a0ea5d5717f65abd50f45d343b6a251c9}{BUGCHECK\_ADDITIONALS}}\ addt\ =\ \{\ 0\ \};}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00119}00119\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{gop_8c_a4c58494b90fd7bfbc33a84178e327b88}{ksnprintf}}(addt.\mbox{\hyperlink{struct___b_u_g_c_h_e_c_k___a_d_d_i_t_i_o_n_a_l_s_a22666d1dd2bf2e039ee004bcf8650c97}{str}},\ \textcolor{keyword}{sizeof}(addt.\mbox{\hyperlink{struct___b_u_g_c_h_e_c_k___a_d_d_i_t_i_o_n_a_l_s_a22666d1dd2bf2e039ee004bcf8650c97}{str}}),\ \textcolor{stringliteral}{"{}Function\ was\ called\ above\ its\ maximum\ IRQL\ limit."{}});}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00120}00120\ \ \ \ \ \ \ \ \ addt.\mbox{\hyperlink{struct___b_u_g_c_h_e_c_k___a_d_d_i_t_i_o_n_a_l_s_add9af9569af79ec26dd741fb226b38ba}{ptr}}\ =\ RIP;}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00121}00121\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{bugcheck_8c_a882a1431cb6ee4d732b3aaf8a3cfda97}{MtBugcheckEx}}(\&ctx,\ NULL,\ \mbox{\hyperlink{bugcheck_8h_a3dd6c077b2422dcc0d05246537da5c82ae3e824eb536b02e7941e6545b6979fc7}{IRQL\_NOT\_LESS\_OR\_EQUAL}},\ \&addt,\ \textcolor{keyword}{true});}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00122}00122\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00123}00123\ \ \ \ \ \textcolor{keywordflow}{if}\ (prev\_if)\ \_\_sti();}
\DoxyCodeLine{\Hypertarget{irql_8c_source_l00124}00124\ \}}

\end{DoxyCode}

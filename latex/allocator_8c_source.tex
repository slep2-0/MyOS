\doxysection{allocator.\+c}
\hypertarget{allocator_8c_source}{}\label{allocator_8c_source}\index{C:/Users/matanel/Desktop/Projects/KernelDevelopment/kernel/memory/allocator/allocator.c@{C:/Users/matanel/Desktop/Projects/KernelDevelopment/kernel/memory/allocator/allocator.c}}
\mbox{\hyperlink{allocator_8c}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00001}00001\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{allocator_8h}{allocator.h}}"{}}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00002}00002\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bugcheck_8h}{../../bugcheck/bugcheck.h}}"{}}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00003}00003\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{memory_8h}{../memory.h}}"{}}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00004}00004\ }
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00005}00005\ \textcolor{keyword}{static}\ uint8\_t*\ frame\_bitmap\ =\ NULL;}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00006}00006\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{size\_t}\ total\_frames\ =\ 0;}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00007}00007\ }
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00008}00008\ \textcolor{keyword}{static}\ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{void}\ set\_frame(\textcolor{keywordtype}{size\_t}\ frame)\ \{}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00009}00009\ \ \ \ \ tracelast\_func(\textcolor{stringliteral}{"{}set\_frame"{}});}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00010}00010\ \ \ \ \ uint64\_t\ rip;}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00011}00011\ \ \ \ \ \mbox{\hyperlink{cpu_8h_ad14712b6bd2c4d4acc67a0178f481a01}{GET\_RIP}}(rip);}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00012}00012\ \ \ \ \ \mbox{\hyperlink{irql_8c_a18058aa8b45e4b81a66efa2f2d708215}{enforce\_max\_irql}}(\mbox{\hyperlink{cpu__types_8h_a6ff101fd8adf1c79792d98893f8dee3ea291292740ec80ec0ff8e2a70c5bdfd6f}{DISPATCH\_LEVEL}},\ (\textcolor{keywordtype}{void}*)rip);}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00013}00013\ \ \ \ \ \textcolor{keywordflow}{if}\ (frame\ >=\ total\_frames)\ \{}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00014}00014\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{cpu__types_8h_ac240bdf341c5e0ae333252cd5ecf0261}{CTX\_FRAME}}\ ctx;}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00015}00015\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{cpu_8h_a4cb54878e75e454401e12e4865c7d122}{SAVE\_CTX\_FRAME}}(\&ctx);}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00016}00016\ \ \ \ \ \ \ \ \ MtBugcheck(\&ctx,\ NULL,\ \mbox{\hyperlink{bugcheck_8h_a3dd6c077b2422dcc0d05246537da5c82a1c8943d908dca2a4a06855d7681fe869}{FRAME\_LIMIT\_REACHED}},\ 0,\ \textcolor{keyword}{false});}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00017}00017\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00018}00018\ \ \ \ \ frame\_bitmap[frame\ /\ 8]\ |=\ (uint8\_t)(1\ <<\ (frame\ \%\ 8));}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00019}00019\ \}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00020}00020\ }
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00021}00021\ \textcolor{keyword}{static}\ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{void}\ clear\_frame(\textcolor{keywordtype}{size\_t}\ frame)\ \{}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00022}00022\ \ \ \ \ tracelast\_func(\textcolor{stringliteral}{"{}clear\_frame"{}});}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00023}00023\ \ \ \ \ uint64\_t\ rip;}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00024}00024\ \ \ \ \ \mbox{\hyperlink{cpu_8h_ad14712b6bd2c4d4acc67a0178f481a01}{GET\_RIP}}(rip);}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00025}00025\ \ \ \ \ \mbox{\hyperlink{irql_8c_a18058aa8b45e4b81a66efa2f2d708215}{enforce\_max\_irql}}(\mbox{\hyperlink{cpu__types_8h_a6ff101fd8adf1c79792d98893f8dee3ea291292740ec80ec0ff8e2a70c5bdfd6f}{DISPATCH\_LEVEL}},\ (\textcolor{keywordtype}{void}*)rip);}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00026}00026\ \ \ \ \ \textcolor{keywordflow}{if}\ (frame\ <\ total\_frames)\ \{}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00027}00027\ \ \ \ \ \ \ \ \ frame\_bitmap[frame\ /\ 8]\ \&=\ (uint8\_t)\string~(1\ <<\ (frame\ \%\ 8));}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00028}00028\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00029}00029\ \}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00030}00030\ }
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00031}00031\ \textcolor{keyword}{static}\ \textcolor{keyword}{inline}\ \textcolor{keywordtype}{bool}\ test\_frame(\textcolor{keywordtype}{size\_t}\ frame)\ \{}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00032}00032\ \ \ \ \ tracelast\_func(\textcolor{stringliteral}{"{}test\_frame"{}});}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00033}00033\ \ \ \ \ uint64\_t\ rip;}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00034}00034\ \ \ \ \ \mbox{\hyperlink{cpu_8h_ad14712b6bd2c4d4acc67a0178f481a01}{GET\_RIP}}(rip);}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00035}00035\ \ \ \ \ \mbox{\hyperlink{irql_8c_a18058aa8b45e4b81a66efa2f2d708215}{enforce\_max\_irql}}(\mbox{\hyperlink{cpu__types_8h_a6ff101fd8adf1c79792d98893f8dee3ea291292740ec80ec0ff8e2a70c5bdfd6f}{DISPATCH\_LEVEL}},\ (\textcolor{keywordtype}{void}*)rip);}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00036}00036\ \ \ \ \ \textcolor{keywordflow}{return}\ (frame\ <\ total\_frames)\ \&\&\ (frame\_bitmap[frame\ /\ 8]\ \&\ (1\ <<\ (frame\ \%\ 8)));}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00037}00037\ \}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00038}00038\ }
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00039}00039\ \textcolor{keyword}{static}\ uint64\_t\ get\_total\_memory\_size(\textcolor{keyword}{const}\ \mbox{\hyperlink{kernel_8h_aa7f93145770b2b55fa44fc8b9a2cf58d}{BOOT\_INFO}}*\ boot\_info)\ \{}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00040}00040\ \ \ \ \ uint64\_t\ highest\_addr\ =\ 0;}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00041}00041\ }
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00042}00042\ \ \ \ \ \textcolor{comment}{//\ Calculate\ the\ number\ of\ entries\ in\ the\ memory\ map}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00043}00043\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ entry\_count\ =\ boot\_info-\/>\mbox{\hyperlink{struct___b_o_o_t___i_n_f_o_a9bec53c13537ffc17434fc3db3f36f0d}{MapSize}}\ /\ boot\_info-\/>\mbox{\hyperlink{struct___b_o_o_t___i_n_f_o_a8bc89261b88b97450ff261d153d0bbdb}{DescriptorSize}};}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00044}00044\ }
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00045}00045\ \ \ \ \ \textcolor{comment}{//\ Get\ a\ pointer\ to\ the\ first\ descriptor}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00046}00046\ \ \ \ \ \mbox{\hyperlink{uefi__memory_8h_ae2b15dcae1dcf3876131751b232dc591}{EFI\_MEMORY\_DESCRIPTOR}}*\ desc\ =\ boot\_info-\/>\mbox{\hyperlink{struct___b_o_o_t___i_n_f_o_a43e384015b713dc64d7f8a59ad452622}{MemoryMap}};}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00047}00047\ }
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00048}00048\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ entry\_count;\ i++)\ \{}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00049}00049\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Calculate\ the\ end\ address\ of\ the\ current\ memory\ region.}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00050}00050\ \ \ \ \ \ \ \ \ uint64\_t\ region\_end\ =\ desc-\/>\mbox{\hyperlink{struct___e_f_i___m_e_m_o_r_y___d_e_s_c_r_i_p_t_o_r_ad31a686b44d9fa70840b0f625434e291}{PhysicalStart}}\ +\ (desc-\/>\mbox{\hyperlink{struct___e_f_i___m_e_m_o_r_y___d_e_s_c_r_i_p_t_o_r_a84530c369b622a5f3899052267fa18fe}{NumberOfPages}}\ *\ \mbox{\hyperlink{allocator_8h_af9b1b2ba12857a4bf11289dac8c5462d}{FRAME\_SIZE}});}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00051}00051\ }
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00052}00052\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ If\ this\ region\ ends\ at\ a\ higher\ address,\ update\ our\ maximum.}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00053}00053\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (region\_end\ >\ highest\_addr)\ highest\_addr\ =\ region\_end;}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00054}00054\ }
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00055}00055\ \ \ \ \ \ \ \ \ desc\ =\ (\mbox{\hyperlink{uefi__memory_8h_ae2b15dcae1dcf3876131751b232dc591}{EFI\_MEMORY\_DESCRIPTOR}}*)((uint8\_t*)desc\ +\ boot\_info-\/>\mbox{\hyperlink{struct___b_o_o_t___i_n_f_o_a8bc89261b88b97450ff261d153d0bbdb}{DescriptorSize}});}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00056}00056\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00057}00057\ }
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00058}00058\ \ \ \ \ \textcolor{keywordflow}{return}\ highest\_addr;}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00059}00059\ \}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00060}00060\ }
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00061}\mbox{\hyperlink{allocator_8c_af4512add62b5d487bf56ff115f3e16d7}{00061}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{allocator_8c_af4512add62b5d487bf56ff115f3e16d7}{frame\_bitmap\_init}}(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00062}00062\ \ \ \ \ tracelast\_func(\textcolor{stringliteral}{"{}frame\_bitmap\_init"{}});}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00063}00063\ \ \ \ \ uint64\_t\ rip;}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00064}00064\ \ \ \ \ \mbox{\hyperlink{cpu_8h_ad14712b6bd2c4d4acc67a0178f481a01}{GET\_RIP}}(rip);}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00065}00065\ \ \ \ \ \mbox{\hyperlink{irql_8c_a18058aa8b45e4b81a66efa2f2d708215}{enforce\_max\_irql}}(\mbox{\hyperlink{cpu__types_8h_a6ff101fd8adf1c79792d98893f8dee3ea291292740ec80ec0ff8e2a70c5bdfd6f}{DISPATCH\_LEVEL}},\ (\textcolor{keywordtype}{void}*)rip);}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00066}00066\ }
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00067}00067\ \ \ \ \ \textcolor{comment}{//\ 1.\ Calculate\ the\ total\ memory\ size\ and\ required\ bitmap\ size}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00068}00068\ \ \ \ \ uint64\_t\ total\_memory\ =\ get\_total\_memory\_size(\&\mbox{\hyperlink{ahci_8c_a5f06053b8248ece91f68e4ae8da74ee4}{boot\_info\_local}});}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00069}00069\ \ \ \ \ total\_frames\ =\ (total\_memory\ +\ \mbox{\hyperlink{allocator_8h_af9b1b2ba12857a4bf11289dac8c5462d}{FRAME\_SIZE}}\ -\/\ 1)\ /\ \mbox{\hyperlink{allocator_8h_af9b1b2ba12857a4bf11289dac8c5462d}{FRAME\_SIZE}};\ \textcolor{comment}{//\ round\ up}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00070}00070\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ bitmap\_size\ =\ (total\_frames\ +\ 7)\ /\ 8;}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00071}00071\ }
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00072}00072\ \ \ \ \ \textcolor{comment}{//\ 2.\ Find\ a\ place\ in\ physical\ memory\ for\ our\ bitmap}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00073}00073\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ entry\_count\ =\ \mbox{\hyperlink{ahci_8c_a5f06053b8248ece91f68e4ae8da74ee4}{boot\_info\_local}}.MapSize\ /\ \mbox{\hyperlink{ahci_8c_a5f06053b8248ece91f68e4ae8da74ee4}{boot\_info\_local}}.DescriptorSize;}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00074}00074\ \ \ \ \ \mbox{\hyperlink{uefi__memory_8h_ae2b15dcae1dcf3876131751b232dc591}{EFI\_MEMORY\_DESCRIPTOR}}*\ desc\ =\ \mbox{\hyperlink{ahci_8c_a5f06053b8248ece91f68e4ae8da74ee4}{boot\_info\_local}}.MemoryMap;}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00075}00075\ \ \ \ \ uintptr\_t\ bitmap\_phys\ =\ 0;}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00076}00076\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ entry\_count;\ ++i)\ \{}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00077}00077\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Look\ for\ a\ usable\ region\ that's\ big\ enough}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00078}00078\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (classify(desc-\/>\mbox{\hyperlink{struct___e_f_i___m_e_m_o_r_y___d_e_s_c_r_i_p_t_o_r_a140acdd7ac30628e97d1851104f05c03}{Type}})\ \&\&\ (desc-\/>\mbox{\hyperlink{struct___e_f_i___m_e_m_o_r_y___d_e_s_c_r_i_p_t_o_r_a84530c369b622a5f3899052267fa18fe}{NumberOfPages}}\ *\ \mbox{\hyperlink{allocator_8h_af9b1b2ba12857a4bf11289dac8c5462d}{FRAME\_SIZE}})\ >=\ bitmap\_size)\ \{}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00079}00079\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ We\ found\ a\ spot!\ Use\ its\ physical\ start\ address.}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00080}00080\ \ \ \ \ \ \ \ \ \ \ \ \ bitmap\_phys\ =\ desc-\/>\mbox{\hyperlink{struct___e_f_i___m_e_m_o_r_y___d_e_s_c_r_i_p_t_o_r_ad31a686b44d9fa70840b0f625434e291}{PhysicalStart}};}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00081}00081\ \ \ \ \ \ \ \ \ \ \ \ \ frame\_bitmap\ =\ (uint8\_t*)(bitmap\_phys\ +\ \mbox{\hyperlink{allocator_8h_aa884a3bb19dee79e8e3ca8a529726372}{PHYS\_MEM\_OFFSET}});}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00082}00082\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00083}00083\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00084}00084\ \ \ \ \ \ \ \ \ desc\ =\ (\mbox{\hyperlink{uefi__memory_8h_ae2b15dcae1dcf3876131751b232dc591}{EFI\_MEMORY\_DESCRIPTOR}}*)((uint8\_t*)desc\ +\ \mbox{\hyperlink{ahci_8c_a5f06053b8248ece91f68e4ae8da74ee4}{boot\_info\_local}}.DescriptorSize);}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00085}00085\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00086}00086\ }
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00087}00087\ \ \ \ \ \textcolor{keywordflow}{if}\ (!bitmap\_phys)\ \{}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00088}00088\ \ \ \ \ \ \ \ \ MtBugcheck(NULL,\ NULL,\ \mbox{\hyperlink{bugcheck_8h_a3dd6c077b2422dcc0d05246537da5c82acbf56036797b0df791819f5480a1a466}{STACK\_SEGMENT\_OVERRUN}},\ 0,\ \textcolor{keyword}{false});}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00089}00089\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00090}00090\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00091}00091\ }
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00092}00092\ \ \ \ \ \textcolor{keywordflow}{if}\ (frame\_bitmap\ ==\ NULL)\ \{}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00093}00093\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ This\ is\ a\ catastrophic\ failure.\ We\ couldn't\ find\ anywhere\ to\ put\ the\ bitmap.}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00094}00094\ \ \ \ \ \ \ \ \ MtBugcheck(NULL,\ NULL,\ \mbox{\hyperlink{bugcheck_8h_a3dd6c077b2422dcc0d05246537da5c82a9c324c1a641bbd8a619dddcd426aa1c7}{FRAME\_BITMAP\_CREATION\_FAILURE}},\ 0,\ \textcolor{keyword}{false});}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00095}00095\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00096}00096\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00097}00097\ }
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00098}00098\ }
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00099}00099\ \ \ \ \ \textcolor{comment}{//\ 3.\ Initialize\ the\ bitmap}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00100}00100\ \ \ \ \ \textcolor{comment}{//\ Mark\ all\ frames\ as\ used/reserved\ initially}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00101}00101\ \ \ \ \ \mbox{\hyperlink{memory_8c_aa3e72f75500f5ac381dd21e9510e75c4}{kmemset}}(frame\_bitmap,\ 0xFF,\ bitmap\_size);}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00102}00102\ }
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00103}00103\ \ \ \ \ \textcolor{comment}{//\ 4.\ Mark\ the\ bitmap's\ OWN\ frames\ as\ used!\ (Crucial!)}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00104}00104\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ bitmap\_pages\ =\ (bitmap\_size\ +\ \mbox{\hyperlink{allocator_8h_af9b1b2ba12857a4bf11289dac8c5462d}{FRAME\_SIZE}}\ -\/\ 1)\ /\ \mbox{\hyperlink{allocator_8h_af9b1b2ba12857a4bf11289dac8c5462d}{FRAME\_SIZE}};}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00105}00105\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ bitmap\_base\_frame\ =\ bitmap\_phys\ /\ \mbox{\hyperlink{allocator_8h_af9b1b2ba12857a4bf11289dac8c5462d}{FRAME\_SIZE}};\ \textcolor{comment}{//\ physical\ here}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00106}00106\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ bitmap\_pages;\ i++)\ \{}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00107}00107\ \ \ \ \ \ \ \ \ set\_frame(bitmap\_base\_frame\ +\ i);}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00108}00108\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00109}00109\ }
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00110}00110\ \ \ \ \ \textcolor{comment}{//\ 5.\ Clear\ usable\ frames\ based\ on\ the\ rest\ of\ the\ memory\ map}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00111}00111\ \ \ \ \ desc\ =\ \mbox{\hyperlink{ahci_8c_a5f06053b8248ece91f68e4ae8da74ee4}{boot\_info\_local}}.MemoryMap;}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00112}00112\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ entry\_count;\ ++i)\ \{}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00113}00113\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (desc-\/>\mbox{\hyperlink{struct___e_f_i___m_e_m_o_r_y___d_e_s_c_r_i_p_t_o_r_a140acdd7ac30628e97d1851104f05c03}{Type}}\ ==\ \mbox{\hyperlink{uefi__memory_8h_af095fe56818f3bd8a310206b8777bb1c}{EfiConventionalMemory}})\ \{}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00114}00114\ \ \ \ \ \ \ \ \ \ \ \ \ uintptr\_t\ base\ =\ desc-\/>\mbox{\hyperlink{struct___e_f_i___m_e_m_o_r_y___d_e_s_c_r_i_p_t_o_r_ad31a686b44d9fa70840b0f625434e291}{PhysicalStart}};}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00115}00115\ \ \ \ \ \ \ \ \ \ \ \ \ uint64\_t\ pages\ =\ desc-\/>\mbox{\hyperlink{struct___e_f_i___m_e_m_o_r_y___d_e_s_c_r_i_p_t_o_r_a84530c369b622a5f3899052267fa18fe}{NumberOfPages}};}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00116}00116\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (uint64\_t\ p\ =\ 0;\ p\ <\ pages;\ ++p)\ \{}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00117}00117\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ frame\_idx\ =\ (base\ /\ \mbox{\hyperlink{allocator_8h_af9b1b2ba12857a4bf11289dac8c5462d}{FRAME\_SIZE}})\ +\ p;}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00118}00118\ }
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00119}00119\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Don't\ free\ the\ frames\ we\ are\ using\ for\ the\ bitmap\ itself!}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00120}00120\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (frame\_idx\ >=\ ((uintptr\_t)bitmap\_phys\ /\ \mbox{\hyperlink{allocator_8h_af9b1b2ba12857a4bf11289dac8c5462d}{FRAME\_SIZE}})\ \&\&}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00121}00121\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ frame\_idx\ <\ (((uintptr\_t)bitmap\_phys\ /\ \mbox{\hyperlink{allocator_8h_af9b1b2ba12857a4bf11289dac8c5462d}{FRAME\_SIZE}})\ +\ bitmap\_pages))\ \{}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00122}00122\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00123}00123\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00124}00124\ }
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00125}00125\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ clear\_frame(frame\_idx);}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00126}00126\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00127}00127\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00128}00128\ \ \ \ \ \ \ \ \ desc\ =\ (\mbox{\hyperlink{uefi__memory_8h_ae2b15dcae1dcf3876131751b232dc591}{EFI\_MEMORY\_DESCRIPTOR}}*)((uint8\_t*)desc\ +\ \mbox{\hyperlink{ahci_8c_a5f06053b8248ece91f68e4ae8da74ee4}{boot\_info\_local}}.DescriptorSize);}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00129}00129\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00130}00130\ \}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00131}00131\ }
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00132}00132\ \textcolor{comment}{//\ Earlyâ€boot\ frame\ allocator:}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00133}\mbox{\hyperlink{allocator_8c_a8bb840f3e319d15269adf7f9110f4bc9}{00133}}\ uintptr\_t\ \mbox{\hyperlink{allocator_8c_a8bb840f3e319d15269adf7f9110f4bc9}{alloc\_frame}}(\textcolor{keywordtype}{void})\ \{}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00134}00134\ \ \ \ \ tracelast\_func(\textcolor{stringliteral}{"{}alloc\_frame"{}});}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00135}00135\ \ \ \ \ uint64\_t\ rip;}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00136}00136\ \ \ \ \ \mbox{\hyperlink{cpu_8h_ad14712b6bd2c4d4acc67a0178f481a01}{GET\_RIP}}(rip);}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00137}00137\ \ \ \ \ \mbox{\hyperlink{irql_8c_a18058aa8b45e4b81a66efa2f2d708215}{enforce\_max\_irql}}(\mbox{\hyperlink{cpu__types_8h_a6ff101fd8adf1c79792d98893f8dee3ea291292740ec80ec0ff8e2a70c5bdfd6f}{DISPATCH\_LEVEL}},\ (\textcolor{keywordtype}{void}*)rip);}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00139}00139\ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ frame\ =\ 0;\ frame\ <\ total\_frames;\ ++frame)\ \{}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00140}00140\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!(frame\_bitmap[frame\ /\ 8]\ \&\ (1\ <<\ (frame\ \%\ 8))))\ \{}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00141}00141\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ mark\ and\ return}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00142}00142\ \ \ \ \ \ \ \ \ \ \ \ \ frame\_bitmap[frame\ /\ 8]\ |=\ (1\ <<\ (frame\ \%\ 8));}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00143}00143\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ (uintptr\_t)(frame\ *\ \mbox{\hyperlink{allocator_8h_af9b1b2ba12857a4bf11289dac8c5462d}{FRAME\_SIZE}});}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00144}00144\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00145}00145\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00146}00146\ \ \ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00147}00147\ \}}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00148}00148\ }
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00149}\mbox{\hyperlink{allocator_8c_a000852beb10aa667f95a9ac94ebe847c}{00149}}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{allocator_8c_a000852beb10aa667f95a9ac94ebe847c}{free\_frame}}(uintptr\_t\ p)\ \{}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00150}00150\ \ \ \ \ tracelast\_func(\textcolor{stringliteral}{"{}free\_frame"{}});}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00151}00151\ \ \ \ \ uint64\_t\ rip;}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00152}00152\ \ \ \ \ \mbox{\hyperlink{cpu_8h_ad14712b6bd2c4d4acc67a0178f481a01}{GET\_RIP}}(rip);}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00153}00153\ \ \ \ \ \mbox{\hyperlink{irql_8c_a18058aa8b45e4b81a66efa2f2d708215}{enforce\_max\_irql}}(\mbox{\hyperlink{cpu__types_8h_a6ff101fd8adf1c79792d98893f8dee3ea291292740ec80ec0ff8e2a70c5bdfd6f}{DISPATCH\_LEVEL}},\ (\textcolor{keywordtype}{void}*)rip);}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00154}00154\ \ \ \ \ \textcolor{keywordtype}{size\_t}\ frame\ =\ (uintptr\_t)p\ /\ \mbox{\hyperlink{allocator_8h_af9b1b2ba12857a4bf11289dac8c5462d}{FRAME\_SIZE}};}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00155}00155\ \ \ \ \ clear\_frame(frame);}
\DoxyCodeLine{\Hypertarget{allocator_8c_source_l00156}00156\ \}}

\end{DoxyCode}
